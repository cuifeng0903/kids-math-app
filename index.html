<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ã¿ã‚“ãªã®ã•ã‚“ã™ã† - ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“</title>
<style>
  :root{
    --bg:#f7fafc; --ink:#223; --muted:#667;
    --red:#e53935; --orange:#ff8c00; --yellow:#ffd54a; --green:#42c58a;
    --sky:#4aa3ff; --purple:#9c27b0; --lavender:#c8a2c8; --deeppink:#ff1493;
    --gray-light:#d9d9d9; --gray:#9e9e9e; --gray-dark:#616161;
    --ten-border:#e53935; --twenty-border:#ff9800; --twenty-bg:#fffaf0;
    --card:#ffffff; --border:#e6e9ef; --focus:#3b82f6; --shadow:0 4px 16px rgba(0,0,0,0.08);
    --radius:16px; --radius-sm:12px;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg); color:var(--ink); font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Yu Gothic","Meiryo",sans-serif;}
  body{margin:0}
  header{display:flex; align-items:center; justify-content:space-between; padding:16px; position:sticky; top:0; background:var(--bg); z-index:10; border-bottom:1px solid var(--border);}
  header h1{font-size:1.4rem; margin:0}
  .tagline{color:var(--muted); font-size:0.9rem}
  .shell{max-width:980px; margin:0 auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
  .toolbar{display:flex; gap:8px; align-items:center; padding:12px; flex-wrap:wrap}
  .seg{display:flex; background:#f2f4f8; border-radius:14px; overflow:hidden; border:1px solid var(--border)}
  .seg-btn{appearance:none; border:none; flex:1; padding:12px 16px; font-weight:700; background:transparent}
  .seg-btn.active{background:white; color:var(--focus)}
  button{appearance:none; border:none; border-radius:14px; padding:14px 18px; font-size:1.1rem; background:#fff; border:1px solid var(--border); box-shadow:var(--shadow); color:var(--ink)}
  button.big{font-size:1.4rem; padding:16px 22px; border-radius:18px}
  button.primary{background:var(--focus); color:#fff; border-color:transparent}
  button.mute{background:#f2f4f8}
  button:active{transform:scale(0.98)}
  input[type="number"]{
    font-size:1.2rem; padding:10px 12px; border-radius:12px; border:2px solid var(--border); width:110px; box-shadow:var(--shadow);
  }

  .stage{padding:12px 16px}
  .equation{display:flex; align-items:center; justify-content:center; gap:16px; font-size:2rem; padding:12px; flex-wrap:wrap}
  .num-display{min-width:84px; min-height:84px; display:flex; align-items:center; justify-content:center; background:white; border:2px solid var(--border); border-radius:20px; box-shadow:var(--shadow); font-weight:800}
  .op,.equals{min-width:48px; text-align:center}

  .counter-row{display:flex; gap:12px; justify-content:center; align-items:center; padding:10px; flex-wrap:wrap}
  .counter{display:flex; align-items:center; gap:8px}
  .counter button{width:54px; height:54px; font-size:1.6rem}
  .counter .value{min-width:68px; height:54px; background:white; border:2px solid var(--border); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:1.6rem; font-weight:800; box-shadow:var(--shadow)}
  .input-wrap{display:flex; align-items:center; gap:8px}

  .area{display:flex; justify-content:center; gap:24px; padding:10px; flex-wrap:wrap}
  .group{flex:1 1 280px; min-width:260px; max-width:420px; background:#fff; border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; position:relative}
  .group h3{margin:0 0 6px 0; font-size:1.02rem; color:var(--muted)}
  .blocks{display:flex; flex-wrap:wrap; gap:8px; min-height:64px; padding:6px}

  /* Blocks: all squares (value=1) */
  .block{width:44px; height:44px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1)}
  /* one-digit color classes */
  .b-red{background:var(--red)}
  .b-orange{background:var(--orange)}
  .b-yellow{background:var(--yellow)}
  .b-green{background:var(--green)}
  .b-sky{background:var(--sky)}
  .b-purple{background:var(--purple)}
  .b-lavender{background:var(--lavender)}
  .b-deeppink{background:var(--deeppink)}
  .b-gray-light{background:var(--gray-light)}
  .b-gray{background:var(--gray)}
  .b-gray-dark{background:var(--gray-dark)}
  /* tens grouping styles (still value=1 per block) */
  .b-ten{background:#fff; border:6px solid var(--ten-border)}
  .b-twenty{background:var(--twenty-bg); border:6px solid var(--twenty-border)}

  /* Animations */
  .bounce-in{animation:bounceIn 380ms ease-out}
  @keyframes bounceIn{0%{transform:scale(0.6); opacity:0}60%{transform:scale(1.08); opacity:1}100%{transform:scale(1)}}
  .fade-out{animation:fadeOut 420ms ease-in forwards}
  @keyframes fadeOut{to{transform:translateY(-6px) scale(0.9); opacity:0}}
  .shake{animation:shake 400ms ease-in-out}
  @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

  /* Challenge */
  .challenge{padding:14px}
  .qheader{display:flex; justify-content:center; gap:12px; align-items:center; flex-wrap:wrap}
  .qtext{font-size:1.4rem; text-align:center; margin:6px 0}
  .choices{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center}
  .choice-input{display:flex; align-items:center; gap:8px}
  .choice-input input[type="number"]{width:140px; font-size:1.6rem}
  .choice-input button{width:58px; height:58px; font-size:1.6rem}
  .score{display:flex; gap:6px; justify-content:center; padding:6px}
  .star{font-size:1.3rem; color:#f5b301}
  .progress{font-size:1rem; color:var(--muted)}

  /* Marks (big circle / big X) overlay */
  .overlay{position:fixed; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; z-index:1000}
  .mark{position:absolute; width:280px; height:280px; opacity:0; transform:scale(0.6)}
  .mark.show{animation:markPop 700ms ease-out forwards}
  @keyframes markPop{0%{opacity:0; transform:scale(0.6)}40%{opacity:1; transform:scale(1.05)}100%{opacity:1; transform:scale(1)}}
  .mark.correct{border:18px solid var(--red); border-radius:50%}
  .mark.wrong::before, .mark.wrong::after{
    content:""; position:absolute; left:50%; top:50%; width:18px; height:280px; background:#1e88e5; transform-origin:center;
  }
  .mark.wrong::before{transform:translate(-50%,-50%) rotate(45deg)}
  .mark.wrong::after{transform:translate(-50%,-50%) rotate(-45deg)}

  /* Confetti fountain */
  .confetti{position:fixed; bottom:-6px; left:50%; width:8px; height:16px; transform:translateX(-50%); opacity:0.9; border-radius:2px; z-index:999}
  .confetti.anim{animation:confettiUp 900ms ease-out forwards}
  @keyframes confettiUp{
    0%{transform:translate(-50%,0) rotate(0deg); opacity:1}
    70%{opacity:1}
    100%{transform:translate(calc(-50% + var(--dx)), calc(-120px - var(--dy))) rotate(var(--rot)); opacity:0}
  }

  /* Accessibility */
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  .help{padding:12px; color:var(--muted); font-size:0.95rem}
  .pill{padding:10px 14px; border-radius:999px; background:#eef3ff; color:#1946b8; font-weight:700; border:1px solid #dbe7ff}
</style>
</head>
<body>
<header>
  <h1>ã¿ã‚“ãªã®ã•ã‚“ã™ã†</h1>
  <div class="tagline">ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ã‚’ã€ã¿ã¦ãƒ»ã•ã‚ã£ã¦å­¦ã¼ã†</div>
</header>

<div class="shell">
  <!-- Mode Switch -->
  <div class="card">
    <div class="toolbar" role="tablist" aria-label="ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
      <div class="seg" aria-label="å­¦ã¶ï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸">
        <button class="seg-btn active" id="tab-learn" role="tab" aria-selected="true">ã¾ãªã¶</button>
        <button class="seg-btn" id="tab-challenge" role="tab" aria-selected="false">ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
      </div>
      <div class="spacer"></div>
      <button id="resetBtn" class="pill">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- Learn Mode -->
  <section id="learn" class="card stage" role="region" aria-label="ã¾ãªã¶ãƒ¢ãƒ¼ãƒ‰">
    <div class="equation" aria-live="polite">
      <div class="num-display" id="numA" aria-label="ã¯ã˜ã‚ã® ã‹ãš">3</div>
      <div class="op" id="opText">ï¼‹</div>
      <div class="num-display" id="numB" aria-label="ã¤ãã® ã‹ãš">2</div>
      <div class="equals">ï¼</div>
      <div class="num-display" id="numAns">5</div>
    </div>

    <div class="counter-row" aria-label="ã‹ãšã®ã›ã£ã¦ã„">
      <div class="counter" aria-label="ã¯ã˜ã‚ã®ã‹ãš">
        <button class="big" id="aMinus">âˆ’</button>
        <div class="value" id="aValue">3</div>
        <button class="big" id="aPlus">ï¼‹</button>
        <div class="input-wrap">
          <label class="sr-only" for="aInput">ã¯ã˜ã‚ã®ã‹ãš æ–‡å­—å…¥åŠ›</label>
          <input id="aInput" type="number" min="0" max="40" value="3" />
        </div>
      </div>
      <div class="seg" aria-label="ãŸã™ãƒ»ã²ã ã® ãˆã‚‰ã³ã‹ãŸ">
        <button class="seg-btn active" id="opAdd">ãŸã—ã–ã‚“</button>
        <button class="seg-btn" id="opSub">ã²ãã–ã‚“</button>
      </div>
      <div class="counter" aria-label="ã¤ãã®ã‹ãš">
        <button class="big" id="bMinus">âˆ’</button>
        <div class="value" id="bValue">2</div>
        <button class="big" id="bPlus">ï¼‹</button>
        <div class="input-wrap">
          <label class="sr-only" for="bInput">ã¤ãã®ã‹ãš æ–‡å­—å…¥åŠ›</label>
          <input id="bInput" type="number" min="0" max="40" value="2" />
        </div>
      </div>
    </div>

    <div class="area">
      <div class="group">
        <h3>ã¯ã˜ã‚ã® ã‹ãš</h3>
        <div class="blocks" id="groupA" aria-label="ã¯ã˜ã‚ã® ã‹ãš ã® ãƒ–ãƒ­ãƒƒã‚¯"></div>
      </div>
      <div class="group">
        <h3><span id="middleTitle">ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰</span></h3>
        <div class="blocks" id="groupB" aria-label="ã¤ãã® ã‹ãš ã® ãƒ–ãƒ­ãƒƒã‚¯"></div>
      </div>
      <div class="group">
        <h3>ã“ãŸãˆ</h3>
        <div class="blocks" id="groupAns" aria-label="ã“ãŸãˆ ã® ãƒ–ãƒ­ãƒƒã‚¯"></div>
      </div>
    </div>

    <div class="play-row">
      <button id="playBtn" class="primary big">â–¶ï¸ ã¿ã¦ã¿ã‚ˆã†</button>
      <button id="clearAns" class="mute">ã“ãŸãˆã‚’ ã‘ã™</button>
    </div>

    <div class="help">
      ã€ŒãŸã—ã–ã‚“ã€ã¯ãƒ–ãƒ­ãƒƒã‚¯ãŒ ã„ã£ã—ã‚‡ã«ãªã£ã¦ ã“ãŸãˆã«ãªã‚Šã¾ã™ã€‚  
      ã€Œã²ãã–ã‚“ã€ã¯ ã¯ã˜ã‚ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã€Œã¨ã‚‹ ã‹ãšã€ãŒ ã¸ã£ã¦ã€ã®ã“ã‚ŠãŒ ã“ãŸãˆã§ã™ã€‚  
      10ã‚„20ã¯ã€ç‰¹åˆ¥ãªãµã¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ ã¾ã¨ã¾ã‚Šã‚’ ã—ã‚ã—ã¾ã™ã€‚
    </div>
  </section>

  <!-- Challenge Mode -->
  <section id="challenge" class="card challenge" role="region" aria-label="ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰" style="display:none">
    <div class="qheader">
      <div class="seg" aria-label="å‡ºé¡Œã‚¿ã‚¤ãƒ—">
        <button class="seg-btn active" id="typeAdd">ãŸã—ç®—</button>
        <button class="seg-btn" id="typeSub">ã²ãç®—</button>
        <button class="seg-btn" id="typeBoth">ã‚Šã‚‡ã†ã»ã†</button>
      </div>
      <div class="seg" aria-label="ã‚€ãšã‹ã—ã•">
        <button class="seg-btn active" id="diffEasy">ã‹ã‚“ãŸã‚“</button>
        <button class="seg-btn" id="diffNormal">ãµã¤ã†</button>
        <button class="seg-btn" id="diffHard">ã‚€ãšã‹ã—ã„</button>
      </div>
      <div class="progress" id="progressText">1 / 5 å•</div>
    </div>

    <div class="qtext" id="qtext">ã‚‚ã‚“ã ã„ãŒ ã¯ã˜ã¾ã‚‹ã‚ˆï¼</div>
    <div class="equation">
      <div class="num-display" id="cA">?</div>
      <div class="op" id="cOp">ï¼‹</div>
      <div class="num-display" id="cB">?</div>
      <div class="equals">ï¼</div>
      <div class="num-display" id="cAns">ï¼Ÿ</div>
    </div>

    <div class="area">
      <div class="group">
        <h3>ã¯ã˜ã‚ã® ã‹ãš</h3>
        <div class="blocks" id="cGroupA"></div>
      </div>
      <div class="group">
        <h3 id="cMiddleTitle">ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰</h3>
        <div class="blocks" id="cGroupB"></div>
      </div>
      <div class="group">
        <h3>ã“ãŸãˆ</h3>
        <div class="blocks" id="cGroupAns"></div>
      </div>
    </div>

    <div class="choices">
      <div class="choice-input" aria-label="ã“ãŸãˆ">
        <button id="ansMinus" class="big">âˆ’</button>
        <input id="ansInput" type="number" min="0" max="40" value="0" />
        <button id="ansPlus" class="big">ï¼‹</button>
      </div>
      <button id="submitAns" class="primary big">ã“ãŸãˆã‚’ ãã‚ã‚‹</button>
      <button id="nextQ" class="big" disabled>ã¤ãã® ã‚‚ã‚“ã ã„</button>
    </div>

    <div class="score" id="score"></div>
    <div class="help">
      5å•ã«ã¡ã‚‡ã†ã›ã‚“ï¼ æ­£è§£ã™ã‚‹ã¨ã€èµ¤ã„ã€‡ã¨ç´™ãµã¶ããŒã§ã‚‹ã‚ˆã€‚ã¾ã¡ãŒãˆã‚‹ã¨ã€é’ã„âœ•ãŒã§ã‚‹ã‚ˆã€‚  
      5å•ãŠã‚ã‚‹ã¨ã€ã”ã»ã†ã³ã‚¹ã‚¿ãƒ³ãƒ—ãŒ ã‚ã‚‰ã‚ã‚Œã¾ã™ã€‚
    </div>
  </section>
</div>

<!-- Overlay for marks and confetti -->
<div id="overlay" class="overlay" aria-hidden="true"></div>

<script>
(function(){
  // ====== State ======
  const state = {
    a:3, b:2, op:'add', // learn mode
    // Challenge
    type:'add', // 'add' | 'sub' | 'both'
    diff:'easy', // 'easy' | 'normal' | 'hard'
    roundLen:5,
    qIndex:0,
    current:{a:0,b:0,op:'add',answer:0},
    score:0
  };

  // ====== Elements ======
  const numA = document.getElementById('numA');
  const numB = document.getElementById('numB');
  const numAns = document.getElementById('numAns');
  const opText = document.getElementById('opText');
  const middleTitle = document.getElementById('middleTitle');
  const groupA = document.getElementById('groupA');
  const groupB = document.getElementById('groupB');
  const groupAns = document.getElementById('groupAns');

  const aMinus = document.getElementById('aMinus');
  const aPlus  = document.getElementById('aPlus');
  const bMinus = document.getElementById('bMinus');
  const bPlus  = document.getElementById('bPlus');
  const aValue = document.getElementById('aValue');
  const bValue = document.getElementById('bValue');
  const aInput = document.getElementById('aInput');
  const bInput = document.getElementById('bInput');
  const opAdd  = document.getElementById('opAdd');
  const opSub  = document.getElementById('opSub');

  const playBtn = document.getElementById('playBtn');
  const clearAns = document.getElementById('clearAns');
  const resetBtn = document.getElementById('resetBtn');

  const tabLearn = document.getElementById('tab-learn');
  const tabChallenge = document.getElementById('tab-challenge');
  const sectionLearn = document.getElementById('learn');
  const sectionChallenge = document.getElementById('challenge');

  // Challenge elems
  const typeAdd = document.getElementById('typeAdd');
  const typeSub = document.getElementById('typeSub');
  const typeBoth = document.getElementById('typeBoth');
  const diffEasy = document.getElementById('diffEasy');
  const diffNormal = document.getElementById('diffNormal');
  const diffHard = document.getElementById('diffHard');
  const progressText = document.getElementById('progressText');

  const cA = document.getElementById('cA');
  const cB = document.getElementById('cB');
  const cOp = document.getElementById('cOp');
  const cAns = document.getElementById('cAns');
  const cGroupA = document.getElementById('cGroupA');
  const cGroupB = document.getElementById('cGroupB');
  const cGroupAns = document.getElementById('cGroupAns');
  const cMiddleTitle = document.getElementById('cMiddleTitle');
  const qtext = document.getElementById('qtext');

  const ansMinus = document.getElementById('ansMinus');
  const ansPlus = document.getElementById('ansPlus');
  const ansInput = document.getElementById('ansInput');
  const submitAns = document.getElementById('submitAns');
  const nextQ = document.getElementById('nextQ');

  const scoreEl = document.getElementById('score');
  const overlay = document.getElementById('overlay');

  // ====== Helpers ======
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const calcAns = ()=> state.op==='add' ? state.a+state.b : state.a-state.b;
  const calcLabel = ()=> state.op==='add' ? 'ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰' : 'ã¨ã‚‹ ã‹ãšï¼ˆã²ãï¼‰';

  function clearBlocks(el){ while(el.firstChild) el.removeChild(el.firstChild); }
  function makeBlock(classList=[]){
    const d = document.createElement('div');
    d.className = 'block';
    classList.forEach(c=>d.classList.add(c));
    return d;
  }

  // Build blocks per spec: use 20-group, 10-group, then ones coloring
  function buildBlocks(container, n){
    clearBlocks(container);
    let remain = n;
    // 20-groups
    while(remain >= 20){
      for(let i=0;i<20;i++){ container.appendChild(makeBlock(['b-twenty'])); }
      remain -= 20;
    }
    // 10-groups
    if(remain >= 10){
      for(let i=0;i<10;i++){ container.appendChild(makeBlock(['b-ten'])); }
      remain -= 10;
    }
    // Ones (1-9) coloring logic
    if(remain > 0){
      const onesBlocks = onesColorBlocks(remain);
      onesBlocks.forEach(cls => container.appendChild(makeBlock([cls])));
    }
  }

  // One-digit color mapping with ordered sequences for 7 and 9
  function onesColorBlocks(n){
    const map = {
      1:['b-red'],
      2:Array(2).fill('b-orange'),
      3:Array(3).fill('b-yellow'),
      4:Array(4).fill('b-green'),
      5:Array(5).fill('b-sky'),
      6:Array(6).fill('b-purple'),
      7:['b-red','b-orange','b-yellow','b-green','b-sky','b-purple','b-lavender'],
      8:Array(8).fill('b-deeppink'),
      9:['b-gray-light','b-gray-light','b-gray-light','b-gray','b-gray','b-gray','b-gray-dark','b-gray-dark','b-gray-dark']
    };
    return map[n] || [];
  }

  // Render Learn Mode UI
  function renderLearn(){
    // For subtraction, prevent negative
    if(state.op==='sub' && state.b>state.a) state.b=state.a;

    aValue.textContent = state.a; bValue.textContent = state.b;
    aInput.value = state.a; bInput.value = state.b;

    numA.textContent = state.a; numB.textContent = state.b;
    opText.textContent = state.op==='add' ? 'ï¼‹' : 'âˆ’';
    numAns.textContent = calcAns();
    middleTitle.textContent = calcLabel();

    buildBlocks(groupA, state.a);
    buildBlocks(groupB, state.b);
    clearBlocks(groupAns); // answer is built by animation or reset
  }

  // ====== Animations (visual explanation) ======
  function wait(ms){ return new Promise(res=>setTimeout(res,ms)); }
  async function moveClone(sourceBlock, targetContainer){
    const rect = sourceBlock.getBoundingClientRect();
    const tRect = targetContainer.getBoundingClientRect();
    const clone = sourceBlock.cloneNode(true);
    clone.style.position = 'fixed';
    clone.style.left = rect.left + 'px';
    clone.style.top  = rect.top  + 'px';
    clone.style.zIndex = 9999;
    clone.style.transition = 'transform 360ms ease-in-out, opacity 360ms ease-in-out';
    document.body.appendChild(clone);
    const dx = (tRect.left + 16 + Math.random()*24) - rect.left;
    const dy = (tRect.top  + 16 + Math.random()*24) - rect.top;
    requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.96)`; });
    await wait(360);
    clone.style.opacity='0';
    await wait(120);
    clone.remove();
  }

  async function animateAdd(){
    clearBlocks(groupAns);
    // Move B then A blocks visually
    const moveBlocks = async (source)=>{
      const blocks = Array.from(source.querySelectorAll('.block'));
      for(const b of blocks){
        await moveClone(b, groupAns);
        const rb = makeBlock(['b-sky']); // temporary bounce marker
        rb.classList.add('bounce-in');
        groupAns.appendChild(rb);
        await wait(60);
      }
    };
    await moveBlocks(groupB);
    await moveBlocks(groupA);
    // Rebuild answer to spec
    await wait(160);
    buildBlocks(groupAns, state.a + state.b);
  }

  async function animateSub(){
    clearBlocks(groupAns);
    // Remove B blocks from A (first B blocks)
    const aBlocks = Array.from(groupA.querySelectorAll('.block'));
    const toRemove = Math.min(state.b, aBlocks.length);
    for(let i=0;i<toRemove;i++){
      const b = aBlocks[i];
      b.style.outline='3px solid #1e88e5'; b.style.outlineOffset='-2px';
      await wait(120);
      b.classList.add('fade-out');
      await wait(420);
      b.remove();
    }
    const remain = groupA.querySelectorAll('.block').length;
    // Show interim bounce
    for(let i=0;i<Math.min(remain,6);i++){
      const rb = makeBlock(['b-green']); rb.classList.add('bounce-in'); groupAns.appendChild(rb); await wait(40);
    }
    await wait(160);
    buildBlocks(groupAns, remain);
  }

  // ====== Marks & Confetti & Sounds ======
  function showMark(type){ // 'correct' or 'wrong'
    overlay.innerHTML = '';
    const mark = document.createElement('div');
    mark.className = 'mark ' + (type==='correct' ? 'correct' : 'wrong') + ' show';
    overlay.appendChild(mark);
    // Auto remove
    setTimeout(()=>{ overlay.innerHTML=''; }, 1200);
  }

  function fountainConfetti(){
    const colors = ['#ff4d4f','#ff8c00','#ffd54a','#42c58a','#4aa3ff','#9c27b0','#ff1493','#00c2ff','#00e676'];
    const count = 80;
    for(let i=0;i<count;i++){
      const c = document.createElement('div');
      c.className='confetti anim';
      const dx = (Math.random()*240 - 120) + 'px'; // spread left/right
      const dy = (Math.random()*80) + 'px'; // additional height variation
      const rot = (Math.random()*540 - 270) + 'deg';
      c.style.setProperty('--dx', dx);
      c.style.setProperty('--dy', dy);
      c.style.setProperty('--rot', rot);
      c.style.background = colors[i % colors.length];
      document.body.appendChild(c);
      setTimeout(()=> c.remove(), 1100);
    }
  }

  // Simple success/failure sounds with Web Audio API
  let audioCtx = null;
  function beep(freq=440, dur=0.2, type='sine', vol=0.2){
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ osc.stop(); }, dur*1000);
  }
  function successSound(){
    // little arpeggio
    beep(523,0.12,'sine',0.18); setTimeout(()=>beep(659,0.12,'sine',0.18),130);
    setTimeout(()=>beep(784,0.18,'sine',0.18),260);
  }
  function failSound(){
    beep(220,0.18,'sawtooth',0.18); setTimeout(()=>beep(180,0.18,'sawtooth',0.18),200);
  }

  // ====== Learn Mode Events ======
  const MAX = 40; // learn mode ceiling
  aMinus.addEventListener('click', ()=>{ state.a = clamp(state.a-1,0,MAX); renderLearn(); });
  aPlus .addEventListener('click', ()=>{ state.a = clamp(state.a+1,0,MAX); if(state.op==='sub' && state.b>state.a) state.b=state.a; renderLearn(); });
  bMinus.addEventListener('click', ()=>{ state.b = clamp(state.b-1,0,MAX); renderLearn(); });
  bPlus .addEventListener('click', ()=>{ state.b = clamp(state.b+1,0,MAX); if(state.op==='sub' && state.b>state.a) state.b=state.a; renderLearn(); });

  aInput.addEventListener('change', ()=>{ state.a = clamp(parseInt(aInput.value||'0',10),0,MAX); if(state.op==='sub' && state.b>state.a) state.b=state.a; renderLearn(); });
  bInput.addEventListener('change', ()=>{ state.b = clamp(parseInt(bInput.value||'0',10),0,MAX); renderLearn(); });

  opAdd.addEventListener('click', ()=>{
    state.op='add';
    opAdd.classList.add('active'); opSub.classList.remove('active');
    renderLearn();
  });
  opSub.addEventListener('click', ()=>{
    state.op='sub';
    opSub.classList.add('active'); opAdd.classList.remove('active');
    if(state.b>state.a) state.b=state.a;
    renderLearn();
  });

  playBtn.addEventListener('click', async ()=>{
    playBtn.disabled = true;
    if(state.op==='add'){ await animateAdd(); }
    else{ await animateSub(); }
    playBtn.disabled = false;
  });
  clearAns.addEventListener('click', ()=> clearBlocks(groupAns));
  resetBtn.addEventListener('click', ()=>{
    state.a=3; state.b=2; state.op='add';
    aInput.value=3; bInput.value=2;
    opAdd.classList.add('active'); opSub.classList.remove('active');
    renderLearn();
    clearBlocks(groupAns);
  });

  // ====== Tabs ======
  function showLearn(){
    tabLearn.classList.add('active'); tabChallenge.classList.remove('active');
    tabLearn.setAttribute('aria-selected','true'); tabChallenge.setAttribute('aria-selected','false');
    sectionLearn.style.display='block'; sectionChallenge.style.display='none';
  }
  function showChallenge(){
    tabChallenge.classList.add('active'); tabLearn.classList.remove('active');
    tabChallenge.setAttribute('aria-selected','true'); tabLearn.setAttribute('aria-selected','false');
    sectionLearn.style.display='none'; sectionChallenge.style.display='block';
    startRound();
  }
  tabLearn.addEventListener('click', showLearn);
  tabChallenge.addEventListener('click', showChallenge);

  // ====== Challenge Mode Logic ======
  function setType(t){
    state.type = t;
    typeAdd.classList.toggle('active', t==='add');
    typeSub.classList.toggle('active', t==='sub');
    typeBoth.classList.toggle('active', t==='both');
    startRound();
  }
  function setDiff(d){
    state.diff = d;
    diffEasy.classList.toggle('active', d==='easy');
    diffNormal.classList.toggle('active', d==='normal');
    diffHard.classList.toggle('active', d==='hard');
    startRound();
  }
  typeAdd.addEventListener('click', ()=>setType('add'));
  typeSub.addEventListener('click', ()=>setType('sub'));
  typeBoth.addEventListener('click', ()=>setType('both'));
  diffEasy.addEventListener('click', ()=>setDiff('easy'));
  diffNormal.addEventListener('click', ()=>setDiff('normal'));
  diffHard.addEventListener('click', ()=>setDiff('hard'));

  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function ranges(){
    if(state.diff==='easy') return {A:[1,5], B:[0,5]};
    if(state.diff==='normal') return {A:[1,10], B:[0,5]};
    return {A:[1,10], B:[0,10]}; // hard
  }

  function pickOp(){
    if(state.type==='add') return 'add';
    if(state.type==='sub') return 'sub';
    return Math.random()<0.5 ? 'add' : 'sub';
  }

  function makeQuestion(){
    const {A:[aMin,aMax], B:[bMin,bMax]} = ranges();
    let a = randInt(aMin,aMax);
    let b = randInt(bMin,bMax);
    const op = pickOp();
    if(op==='sub' && b>a){ // avoid negative
      [a,b] = [b,a];
      if(a===0){ a=1; } // ensure at least 1 for A in subtraction
    }
    const ans = op==='add' ? (a+b) : (a-b);
    state.current = {a,b,op,answer:ans};
  }

  function renderQuestion(){
    const {a,b,op,answer} = state.current;
    progressText.textContent = `${state.qIndex+1} / ${state.roundLen} å•`;
    qtext.textContent = 'ã‚‚ã‚“ã ã„ï¼šã‚ˆã‚“ã§ ã“ãŸãˆã‚’ å…¥ã‚Œã¦ã­';
    cA.textContent = a; cB.textContent = b; cOp.textContent = op==='add'?'ï¼‹':'âˆ’';
    cAns.textContent = 'ï¼Ÿ';
    cMiddleTitle.textContent = op==='add' ? 'ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰' : 'ã¨ã‚‹ ã‹ãšï¼ˆã²ãï¼‰';
    clearBlocks(cGroupA); clearBlocks(cGroupB); clearBlocks(cGroupAns);
    buildBlocks(cGroupA, a);
    buildBlocks(cGroupB, b);
    ansInput.value = 0;
    nextQ.disabled = true;
    submitAns.disabled = false;
  }

  function renderScore(){
    scoreEl.innerHTML = '';
    for(let i=0;i<state.score;i++){
      const s = document.createElement('span');
      s.className='star'; s.textContent='â˜…'; scoreEl.appendChild(s);
    }
  }

  function startRound(){
    state.qIndex = 0;
    state.score = 0;
    renderScore();
    makeQuestion();
    renderQuestion();
  }

  function onSubmit(){
    const val = clamp(parseInt(ansInput.value||'0',10),0,40);
    const ok = val===state.current.answer;
    if(ok){
      cAns.textContent = val;
      showMark('correct');
      fountainConfetti();
      successSound();
      // Show answer blocks with spec
      buildBlocks(cGroupAns, val);
      state.score = clamp(state.score+1, 0, state.roundLen);
      renderScore();
    }else{
      showMark('wrong');
      failSound();
    }
    submitAns.disabled = true;
    nextQ.disabled = false;
  }

  function onNext(){
    if(state.qIndex < state.roundLen-1){
      state.qIndex++;
      makeQuestion();
      renderQuestion();
    }else{
      // End of round: reward stamp
      showRewardStamp();
      startRound();
    }
  }

  const stamps = [
    'ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥','ğŸ…','ğŸ¥¥',
    'ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ'
  ];
  function showRewardStamp(){
    overlay.innerHTML = '';
    const stamp = document.createElement('div');
    stamp.style.position='absolute';
    stamp.style.bottom='12%';
    stamp.style.left='50%';
    stamp.style.transform='translateX(-50%) scale(0.4)';
    stamp.style.fontSize='8rem';
    stamp.style.filter='drop-shadow(0 6px 18px rgba(0,0,0,0.2))';
    stamp.textContent = stamps[Math.floor(Math.random()*stamps.length)];
    overlay.appendChild(stamp);
    // Celebrate with extra confetti
    fountainConfetti();
    setTimeout(()=>{ stamp.style.transition='transform 600ms ease-out'; stamp.style.transform='translateX(-50%) scale(1)'; }, 50);
    setTimeout(()=>{ overlay.innerHTML=''; }, 2000);
  }

  // Challenge controls
  ansMinus.addEventListener('click', ()=>{
    ansInput.value = clamp(parseInt(ansInput.value||'0',10)-1,0,40);
  });
  ansPlus.addEventListener('click', ()=>{
    ansInput.value = clamp(parseInt(ansInput.value||'0',10)+1,0,40);
  });
  submitAns.addEventListener('click', onSubmit);
  nextQ.addEventListener('click', onNext);

  // ====== Init ======
  renderLearn();
  // Preload audio context on user gesture
  document.body.addEventListener('click', ()=>{ audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)(); }, {once:true});
})();
</script>
</body>
</html>
