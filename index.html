<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„Ç≠„ÉÉ„Ç∫ÁÆóÊï∞„Ç¢„Éó„É™ Ver.1.1.3 Fix2</title>

  <!-- PWA -->
  <meta name="theme-color" content="#ff6b6b" />
  ./manifest.webmanifest
  <!-- ‰ªªÊÑè„ÅÆfaviconÔºà„ÅÇ„Çå„Å∞Ôºâ -->
  ./icons/icon-192.png

  <!-- ====== Âçò‰∏Ä„Éï„Ç°„Ç§„É´ÂÜÖ„Çπ„Çø„Ç§„É´ÔºàUIÊúÄÂ∞èÔºâ ====== -->
  <style>
    :root { --accent:#ff6b6b; --primary:#2e6df6; --bg:#fafafa; --border:#eee; --text:#333; }
    body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; color:var(--text); background:#fff; }
    .km-container { max-width:980px; margin:0 auto; padding:16px 20px; }
    .km-header { margin-bottom:12px; }
    .km-title { font-size:22px; font-weight:700; }
    .km-title small { font-size:12px; color:#888; margin-left:.5em; }

    .km-panel { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:12px; }
    .km-ops-tabs { display:inline-flex; gap:8px; margin-bottom:10px; }
    .km-tab { border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
    .km-tab.is-active { background:#fff2f2; border-color:var(--accent); color:#d63a3a; }
    .km-settings { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; align-items:end; }
    .km-setting label { display:block; font-size:12px; color:#666; margin-bottom:4px; }
    .km-select { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    .km-actions { display:flex; gap:8px; justify-content:flex-end; }
    .km-btn { border:1px solid #ddd; background:#fff; border-radius:10px; padding:8px 14px; font-weight:700; cursor:pointer; }
    .km-btn:disabled { opacity:.5; cursor:not-allowed; }
    .km-btn-primary { background:var(--primary); border-color:var(--primary); color:#fff; }
    .km-btn-accent { background:var(--accent); border-color:var(--accent); color:#fff; }
    .km-btn-ghost { background:#fff; color:#333; }
    .km-board { margin-top:14px; border:1px dashed #e8e8e8; border-radius:10px; padding:12px; }
    .km-row { display:grid; grid-template-columns:1fr 60px 1fr 40px 1fr; gap:8px; align-items:start; }
    .km-col { min-width:0; }
    .km-col-operator,.km-col-equals { display:flex; align-items:center; justify-content:center; }
    .km-label { font-size:12px; color:#666; margin:6px 0; }
    .km-operator { font-size:24px; font-weight:900; color:var(--accent); }
    .km-equals { font-size:20px; font-weight:900; color:#333; }
    .km-value { text-align:center; margin-top:6px; color:#333; }
    .km-num { font-weight:800; font-size:16px; }
    .km-blocks { display:grid; grid-template-columns:repeat(10,18px); gap:4px 4px; min-height:26px; }
    .km-block { width:18px; height:18px; border-radius:4px; background:#ffd5d5; border:1px solid #ffb3b3; box-shadow:0 1px 0 rgba(0,0,0,.04) inset; }
    .km-block.bA { background:#ffd5d5; border-color:#ffb3b3; }
    .km-block.bB { background:#d5ecff; border-color:#b3dbff; }
    .km-block.bSum { background:#fedb7a; border-color:#f9c94c; }
    .km-answer { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .km-answer-select { min-width:120px; }
    .km-result { min-height:20px; margin-top:6px; font-weight:700; }
    .km-result.ok { color:#d63a3a; }
    .km-result.ng { color:#666; }
    .km-formula { margin-top:10px; text-align:center; font-weight:800; font-size:16px; letter-spacing:.02em; }
    .km-reward-area { margin-top:12px; display:flex; gap:12px; align-items:center; }
    .km-stamps { display:flex; gap:8px; align-items:center; }
    .km-stamp-slot { width:56px; height:56px; border:2px dashed #ccc; border-radius:12px; display:grid; place-items:center; color:#bbb; }
    @media (max-width:720px){ .km-settings{grid-template-columns:1fr 1fr;} .km-row{grid-template-columns:1fr 40px 1fr 30px 1fr;} }
  </style>
</head>

<body>
  <main id="app" class="km-container">
    <header class="km-header">
      <h1 class="km-title">„Ç≠„ÉÉ„Ç∫ÁÆóÊï∞„Ç¢„Éó„É™ <small>Ver.1.1.3 Fix2</small></h1>
    </header>

    <!-- Êìç‰Ωú„Éë„Éç„É´ -->
    <section class="km-panel">
      <div class="km-ops-tabs" role="tablist" aria-label="ÊºîÁÆó„ÅÆÈÅ∏Êäû">
        <button class="km-tab is-active" data-op="add" role="tab" aria-selected="true">„Åü„Åó„Åñ„Çì</button>
        <button class="km-tab" data-op="sub" role="tab" aria-selected="false">„Å≤„Åç„Åñ„Çì</button>
      </div>
      <div class="km-settings">
        <div class="km-setting">
          <label for="firstNum">„ÅØ„Åò„ÇÅ„ÅÆ„Åã„Åö</label>
          <select id="firstNum" class="km-select"></select>
        </div>
        <div class="km-setting">
          <label for="secondNum">„Å§„Åé„ÅÆ„Åã„Åö</label>
          <select id="secondNum" class="km-select"></select>
        </div>
        <div class="km-setting">
          <label for="difficulty">Èõ£ÊòìÂ∫¶</label>
          <select id="difficulty" class="km-select">
            <option value="easy">„ÇÑ„Åï„Åó„ÅÑÔºà1„Äú10Ôºâ</option>
            <option value="normal" selected>„Åµ„Å§„ÅÜÔºà1„Äú20Ôºâ</option>
            <option value="hard">„ÇÄ„Åö„Åã„Åó„ÅÑÔºà1„Äú50Ôºâ</option>
          </select>
        </div>
        <div class="km-actions">
          <button id="btnStart" class="km-btn km-btn-primary">„Çπ„Çø„Éº„Éà</button>
          <button id="btnReset" class="km-btn" disabled>„ÇÑ„Çä„Å™„Åä„Åó</button>
        </div>
      </div>
    </section>

    <!-- Ë°®Á§∫È†òÂüü -->
    <section class="km-board" aria-live="polite" aria-atomic="true">
      <div class="km-row">
        <div class="km-col">
          <h2 class="km-label">„ÅØ„Åò„ÇÅ„ÅÆ„Åã„Åö</h2>
          <div id="laneA" class="km-blocks" data-lane="A"></div>
          <div class="km-value"><span id="valueA" class="km-num">0</span></div>
        </div>

        <div class="km-col km-col-operator">
          <div id="opBadge" class="km-operator">Ôºã</div>
        </div>

        <div class="km-col">
          <h2 class="km-label">„Å§„Åé„ÅÆ„Åã„Åö</h2>
          <div id="laneB" class="km-blocks" data-lane="B"></div>
          <div class="km-value"><span id="valueB" class="km-num">0</span></div>
        </div>

        <div class="km-col km-col-equals">
          <div class="km-equals">Ôºù</div>
        </div>

        <div class="km-col">
          <h2 class="km-label">„Åì„Åü„Åà</h2>
          <div id="laneAns" class="km-blocks km-blocks-answer" data-lane="ANS"></div>
          <div class="km-answer">
            <select id="answer" class="km-select km-answer-select" disabled></select>
            <button id="btnCheck" class="km-btn km-btn-accent" disabled>„Åì„Åü„Åà„ÅÇ„Çè„Åõ</button>
          </div>
          <div id="resultMsg" class="km-result" role="status"></div>
        </div>
      </div>

      <div class="km-formula">
        <span id="fA">0</span>
        <span id="fOp">Ôºã</span>
        <span id="fB">0</span>
        <span>Ôºù</span>
        <span id="fQ">Ôºü</span>
      </div>
    </section>

    <!-- „ÉÅ„É£„É¨„É≥„Ç∏ÔºÜ„Çπ„Çø„É≥„Éó -->
    <section class="km-reward-area">
      <button id="btnChallenge" class="km-btn km-btn-ghost" title="„É©„É≥„ÉÄ„É†Âá∫È°åÔºà„Åã„Çì„ÇÄ„Çä„ÉÅ„É£„É¨„É≥„Ç∏Ôºâ">üëë „ÉÅ„É£„É¨„É≥„Ç∏</button>
      <div class="km-stamps">
        <div class="km-stamp-slot" aria-label="„Åî„Åª„ÅÜ„Å≥„Çπ„Çø„É≥„Éó"></div>
      </div>
    </section>
  </main>

  <noscript>„Åì„ÅÆ„Ç¢„Éó„É™„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ JavaScript „ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</noscript>

  <!-- ====== Âçò‰∏Ä„Éï„Ç°„Ç§„É´ÂÜÖ„É≠„Ç∏„ÉÉ„ÇØÔºàVer.1.1.3 Fix2 Ê©üËÉΩÔºâ ====== -->
  <script>
    const BASE = '/kids-math-app/'; // ÂÖ¨ÈñãURL„Å´Âêà„Çè„Åõ„Åü„Éô„Éº„Çπ

    const $  = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>[...el.querySelectorAll(s)];
    const firstNum=$('#firstNum'), secondNum=$('#secondNum'), difficulty=$('#difficulty');
    const tabs=$$('.km-tab'), opBadge=$('#opBadge');
    const valueA=$('#valueA'), valueB=$('#valueB'), laneA=$('#laneA'), laneB=$('#laneB'), laneAns=$('#laneAns');
    const ansSel=$('#answer'), btnStart=$('#btnStart'), btnReset=$('#btnReset'), btnCheck=$('#btnCheck'), resultMsg=$('#resultMsg');
    const btnChallenge=$('#btnChallenge');
    const fA=$('#fA'), fB=$('#fB'), fOp=$('#fOp'), fQ=$('#fQ');

    let op='add', A=0, B=0;
    const answeredSet=new Set();
    const DIFF_MAX={ easy:10, normal:20, hard:50 };

    function currentMax(){ return DIFF_MAX[difficulty.value]||20; }
    function setOperator(k){ op=k; const ch=(k==='add')?'Ôºã':'Ôºç'; opBadge.textContent=ch; fOp.textContent=ch; }
    function getCorrect(){ return op==='add' ? (A+B) : (A-B); }
    function renderBlocks(el, n, cls){ el.innerHTML=''; for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className=`km-block ${cls}`; el.appendChild(d);} }
    function updateFormula(show=false){ fA.textContent=A; fB.textContent=B; fQ.textContent=show?getCorrect():'Ôºü'; }
    function fillNumberOptions(max){
      [firstNum, secondNum, ansSel].forEach(s=>s.innerHTML='');
      for(let i=0;i<=max;i++){ firstNum.appendChild(new Option(String(i),String(i))); secondNum.appendChild(new Option(String(i),String(i))); }
      ansSel.appendChild(new Option('Ôºü','',true,true)); ansSel.disabled=true; btnCheck.disabled=true;
    }
    function applyValues(){
      valueA.textContent=A; valueB.textContent=B;
      renderBlocks(laneA,A,'bA'); renderBlocks(laneB,B,'bB'); renderBlocks(laneAns,0,'bSum');
      updateFormula(false); resultMsg.textContent=''; resultMsg.className='km-result';
    }
    function buildChoices(){
      const correct=getCorrect(), max=Math.max(currentMax(), Math.max(A,B)+5), deltas=[-3,-2,-1,1,2,3,4,5,6];
      const set=new Set([correct]);
      while(set.size<6){ const base=correct+deltas[Math.floor(Math.random()*deltas.length)]; set.add(Math.max(0,Math.min(max,base))); }
      const arr=[...set].sort((x,y)=>x-y);
      ansSel.innerHTML=''; ansSel.appendChild(new Option('Ôºü','',true,true));
      arr.forEach(n=>ansSel.appendChild(new Option(String(n),String(n))));
      ansSel.disabled=false; btnCheck.disabled=true;
    }
    function problemKey(a,b,op){
      if(op==='add'){ const s=[a,b].sort((x,y)=>x-y); return `add:${s[0]},${s[1]}`; }
      return `sub:${a},${b}`;
    }
    async function playAnimation(){ const total=Math.max(getCorrect(),0); renderBlocks(laneAns,total,'bSum'); await new Promise(r=>setTimeout(r,180)); }
    function confettiMini(){
      const box=document.createElement('div'); Object.assign(box.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:'9999'}); document.body.appendChild(box);
      const count=80; for(let i=0;i<count;i++){ const p=document.createElement('i'); const size=Math.random()*8+4;
        Object.assign(p.style,{position:'absolute',left:(Math.random()*100)+'vw',top:'-10px',width:size+'px',height:size+'px',
          background:`hsl(${Math.random()*360},90%,60%)`,transform:`rotate(${Math.random()*360}deg)`,borderRadius:'2px',opacity:'0.9',
          transition:'transform 1.2s linear, top 1.2s linear, opacity .2s ease-out' });
        box.appendChild(p);
        requestAnimationFrame(()=>{ p.style.top=(Math.random()*100+10)+'vh'; p.style.transform=`translateY(0) rotate(${Math.random()*720}deg)`; });
      } setTimeout(()=>box.remove(),1400);
    }

    tabs.forEach(b=>b.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('is-active')); b.classList.add('is-active');
      setOperator(b.dataset.op); applyValues();
    }));
    difficulty.addEventListener('change',()=>{
      fillNumberOptions(currentMax());
      A=Math.min(A,currentMax()); B=Math.min(B,currentMax());
      firstNum.value=String(A); secondNum.value=String(B); applyValues();
    });
    firstNum.addEventListener('change',()=>{ A=Number(firstNum.value); valueA.textContent=A; renderBlocks(laneA,A,'bA'); updateFormula(false); });
    secondNum.addEventListener('change',()=>{ B=Number(secondNum.value); valueB.textContent=B; renderBlocks(laneB,B,'bB'); updateFormula(false); });

    btnStart.addEventListener('click',()=>{
      A=Number(firstNum.value); B=Number(secondNum.value); const key=problemKey(A,B,op);
      if(answeredSet.has(key)){
        const max=currentMax();
        if(op==='add'){ A=Math.floor(Math.random()*(max+1)); B=Math.floor(Math.random()*(max+1)); }
        else { const x=Math.floor(Math.random()*(max+1)), y=Math.floor(Math.random()*(max+1)); A=Math.max(x,y); B=Math.min(x,y); }
        firstNum.value=String(A); secondNum.value=String(B);
      }
      applyValues(); buildChoices(); btnReset.disabled=false;
    });
    btnReset.addEventListener('click',()=>{
      laneAns.innerHTML=''; ansSel.selectedIndex=0; ansSel.disabled=true; btnCheck.disabled=true;
      resultMsg.textContent=''; resultMsg.className='km-result'; updateFormula(false);
    });
    ansSel.addEventListener('change',()=>{ btnCheck.disabled=(ansSel.value===''); });
    btnCheck.addEventListener('click',async ()=>{
      const val=Number(ansSel.value), correct=getCorrect(); if(Number.isNaN(val)) return;
      if(val===correct){
        await playAnimation();
        resultMsg.textContent='üÖæ „Åõ„ÅÑ„Åã„ÅÑÔºÅ'; resultMsg.className='km-result ok';
        const slot=document.querySelector('.km-stamp-slot'); slot.textContent='‚≠êÔ∏è';
        confettiMini();
        setTimeout(()=>btnChallenge.click(),800);
        answeredSet.add(problemKey(A,B,op)); updateFormula(true);
      } else {
        resultMsg.textContent='„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ'; resultMsg.className='km-result ng';
      }
    });
    btnChallenge.addEventListener('click',()=>{
      const max=currentMax();
      if(op==='add'){ A=Math.floor(Math.random()*(max+1)); B=Math.floor(Math.random()*(max+1)); }
      else { const x=Math.floor(Math.random()*(max+1)), y=Math.floor(Math.random()*(max+1)); A=Math.max(x,y); B=Math.min(x,y); }
      firstNum.value=String(A); secondNum.value=String(B); applyValues(); buildChoices(); btnReset.disabled=false;
    });

    // ÂàùÊúüË°®Á§∫
    fillNumberOptions(currentMax());
    A=3; B=2; firstNum.value='3'; secondNum.value='2'; setOperator('add'); applyValues();

    // ====== Service Worker ÁôªÈå≤Ôºà/kids-math-app/ „Çπ„Ç≥„Éº„ÉóÔºâ ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js', { scope: BASE });
          console.log('[SW] registered:', reg.scope);
        } catch (err) {
          console.info('[SW] registration failed (online-only mode):', err?.message || err);
        }
      });
    }
  </script>
</body>
</html>
