<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- iOS / iPadOS 最適化 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#0b2340">
  <meta name="apple-mobile-web-app-title" content="さんすう">

  <!-- ✅ 正しいリンク記述（配下公開用の絶対パスに統一） -->
  <link rel="manifest" href="/kids-math-app/manifest.webmanifest">
  <!-- iPhone（Safari）のホーム画面用アイコンは Manifest ではなくこちらを参照 -->
  <link rel="icon" href="/kids-math-app/apple-touch-icon.png">
  <!-- Android/Chrome 用の汎用アイコン（推奨） -->
  <link rel="icon" href="/kids-math-appath-app/icon-512.png>

  <title>みんなのさんすう - たしざん・ひきざん</title>

  <style>
    :root{
      --bg:#f7fafc; --ink:#223; --muted:#667; --card:#fff; --border:#e6e9ef; --shadow:0 4px 16px rgba(0,0,0,0.08);
      --focus:#3b82f6; --radius:16px; --radius-sm:12px;
      /* one-digit palette */
      --red:#e53935; --orange:#ff8c00; --yellow:#ffd54a; --green:#42c58a;
      --sky:#4aa3ff; --purple:#9c27b0; --lavender:#c8a2c8; --deeppink:#ff1493;
      --gray-light:#d9d9d9; --gray:#9e9e9e; --gray-dark:#616161;
      /* tens / twenties */
      --ten-border:#e53935;
      --twenty-border:#ff9800; --twenty-bg:#fffaf0;
      /* effects */
      --ok:#e53935; --ng:#1e88e5;
    }
    *{box-sizing:border-box}
    html,body{
      background:var(--bg); color:var(--ink);
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Yu Gothic","Meiryo",sans-serif;
      -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%;
    }
    body{ margin:0; padding-bottom: env(safe-area-inset-bottom); min-height:100vh; }
    @supports (min-height:100svh){ body{ min-height:100svh; } }

    header{
      position:sticky; top:0; z-index:50; background:var(--bg); border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      padding: calc(12px + env(safe-area-inset-top)) 16px 12px 16px;
    }
    header h1{margin:0; font-size:1.2rem}
    .shell{max-width:980px; margin:0 auto; padding:10px 16px}

    /* Top controls (two rows) */
    .controls{position:sticky; top:calc(56px + env(safe-area-inset-top)); z-index:40; background:var(--bg); border-bottom:1px solid var(--border);}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:10px 0}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:10px}
    .row1{font-size:1.12rem} .row2{font-size:0.98rem}
    .label{font-weight:700} .label-inline{display:flex; align-items:center; gap:8px}

    button{appearance:none; border:none; border-radius:14px; padding:12px 16px; font-size:1.05rem;
      background:#fff; border:1px solid var(--border); box-shadow:var(--shadow); color:var(--ink)}
    button.primary{background:var(--focus); color:#fff; border-color:transparent}
    button.mute{background:#f2f4f8}
    button.big{font-size:1.15rem}
    button:active{transform:scale(0.98)} button:focus{outline:none}

    .seg{display:flex; background:#f2f4f8; border-radius:14px; overflow:hidden; border:1px solid var(--border)}
    .seg-btn{appearance:none; border:none; padding:10px 12px; font-weight:700; background:transparent}
    .seg-btn.active{background:#fff; color:var(--focus)}

    /* selects */
    select{appearance:none; padding:12px 14px; border-radius:12px; border:2px solid var(--border); background:#fff;}
    .big-select{font-size:1.35rem; min-width:132px}
    .small-select{font-size:1.05rem; min-width:120px}

    /* Stage */
    .stage{padding-top:10px}
    .equation{display:flex; align-items:center; justify-content:center; gap:12px; font-size:1.8rem; padding:10px; flex-wrap:wrap}
    .num-display{min-width:74px; min-height:74px; display:flex; align-items:center; justify-content:center; background:white;
      border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); font-weight:800}
    .op,.equals{min-width:40px; text-align:center}

    /* Vertical animation layout */
    .area{display:flex; flex-direction:column; gap:16px; padding:10px 0 24px 0}
    .group{width:100%; background:#fff; border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px}
    .group h3{margin:0 0 6px 0; font-size:0.98rem; color:var(--muted)}
    .blocks{display:flex; flex-wrap:wrap; gap:8px; min-height:60px; padding:6px; touch-action: manipulation;}

    /* blocks */
    .block{width:42px; height:42px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .b-red{background:#e53935} .b-orange{background:#ff8c00} .b-yellow{background:#ffd54a} .b-green{background:#42c58a}
    .b-sky{background:#4aa3ff} .b-purple{background:#9c27b0} .b-lavender{background:#c8a2c8} .b-deeppink{background:#ff1493}
    .b-gray-light{background:#d9d9d9} .b-gray{background:#9e9e9e} .b-gray-dark{background:#616161}
    .b-ten{background:#fff; border:6px solid var(--ten-border)}
    .b-twenty{background:#fffaf0; border:6px solid var(--twenty-border)}

    /* animations */
    .bounce-in{animation:bounceIn 360ms ease-out}
    @keyframes bounceIn{0%{transform:scale(0.6); opacity:0}60%{transform:scale(1.06); opacity:1}100%{transform:scale(1)}}

    /* overlay: marks & confetti & reward */
    .overlay{position:fixed; inset:0; pointer-events:none; z-index:1000}
    .mark{position:absolute; left:50%; top:45%; transform:translate(-50%,-50%) scale(0.6); width:300px; height:300px; opacity:0}
    .mark.show{animation:markPop 700ms ease-out forwards}
    @keyframes markPop{0%{opacity:0; transform:translate(-50%,-50%) scale(0.6)}40%{opacity:1; transform:translate(-50%,-50%) scale(1.06)}100%{opacity:1; transform:translate(-50%,-50%) scale(1)}}
    .mark.correct{border:20px solid var(--ok); border-radius:50%}
    .mark.wrong::before, .mark.wrong::after{content:""; position:absolute; left:50%; top:50%; width:22px; height:320px; background:var(--ng); transform-origin:center;}
    .mark.wrong::before{transform:translate(-50%,-50%) rotate(45deg)} .mark.wrong::after{transform:translate(-50%,-50%) rotate(-45deg)}

    .confetti{position:fixed; bottom:-8px; width:9px; height:18px; opacity:0.95; border-radius:2px; z-index:1001}
    .confetti.fly{animation:confettiFly 1200ms ease-out forwards}
    @keyframes confettiFly{0%{transform:translate(var(--x0), var(--y0)) rotate(0deg); opacity:1}100%{transform:translate(var(--x1), var(--y1)) rotate(var(--rot)); opacity:0}}

    /* reward stamp */
    .reward{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25)}
    .reward .box{pointer-events:auto; background:#fff; border-radius:18px; padding:24px; border:4px solid #eee; text-align:center;
      box-shadow:0 18px 40px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:12px; align-items:center}
    .stamp{display:inline-flex; align-items:center; justify-content:center; width:220px; height:220px; border:10px solid #ff8c00;
      border-radius:18px; background:#fffaf0; font-size:7rem; box-shadow:inset 0 0 0 6px rgba(255,140,0,0.2)}
    .reward .btn-stack{display:flex; flex-direction:column; gap:10px; width:100%; align-items:center}
    .reward button{pointer-events:auto; min-width:180px}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <!-- ここから下は、Ver.1.1.3 と同じ UI／アニメ本体（省略不可なら現行コードをそのまま入れてください） -->
  <!-- 上部2段UI、式、縦配置3領域、overlay、各アニメ用JS 本体…… -->

  <script>
  (function(){
    /* ここに Ver.1.1.3 の JS 本体をそのまま配置してください（省略不可の場合は現行のまま貼付）。
       変更があるのは Service Worker 登録部のみ（配下公開に合わせる）です。 */

    // ……（学ぶ・チャレンジ・アニメ本体は現行のまま）……

    // ✅ Service Worker 登録：/kids-math-app/ 配下公開に動的対応
    try{
      if('serviceWorker' in navigator){
        const basePath = location.pathname.replace(/[^/]*$/, ''); // 例: '/kids-math-app/'
        navigator.serviceWorker.register(`${basePath}sw.js`, { scope: basePath })
          .catch(err => console.error('SW register failed:', err));
      }
    }catch(e){
      console.error('SW init error:', e);
    }
  })();
  </script>
</body>
</html>
