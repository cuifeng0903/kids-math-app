<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<!-- iPhone/iPad æœ€é©åŒ– + PWAã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#6c5ce7" />
<!-- PWA: ç”»åƒã‚’ç½®ã„ãŸã‚‰ãƒ›ãƒ¼ãƒ ç”»é¢ã«ã‚¢ã‚¤ã‚³ãƒ³ãŒå‡ºã¾ã™ -->
icons/apple-touch-icon.png
manifest.webmanifest

<title>ã¯ã˜ã‚ã¦ã® ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ10Ã—1 & ã‚¹ãƒ†ãƒ¼ã‚¸ï¼æœ€çµ‚ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --text:#1f2a44; --muted:#6b7280; --accent:#6c5ce7;
    --gap:10px; --block-size:64px; --dur:600ms;

    /* ä¸€æ¡ã®è‰² */
    --c-red:#ef4444; --c-orange:#f59e0b; --c-yellow:#facc15; --c-green:#22c55e;
    --c-aqua:#38bdf8; --c-purple:#a855f7; --c-lilac:#c084fc; --c-hotpink:#e91e63;
    --c-gray:#9ca3af;            /* æ¨™æº–ã®ç° */
    --c-gray-light:#e5e7eb;      /* è–„ã„ç° */
    --c-gray-dark:#6b7280;       /* æ¿ƒã„ç° */

    /* ã¾ã¨ã¾ã‚Šï¼ˆ10/20ï¼‰ */
    --ten-border:#ef4444;   --ten-bg:#ffffff;
    --twenty-border:#f59e0b;--twenty-bg:#fffaf0;

    /* ç¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    --flash:#fff6;

    /* å…¨ä½“ç¸®å°ï¼ˆJSã§è¨ˆç®—ã—ã¦é©ç”¨ï¼‰ */
    --app-scale: 1;
  }
  *{box-sizing:border-box}
  html, body { height: 100%; }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    /* ç”»é¢å†…ã«åã‚ã‚‹ãŸã‚ã€åŸºæœ¬ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ */
    overflow: hidden;
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* â˜… å…¨ä½“ã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦ç”»é¢ã«åã‚ã‚‹ */
  #app{
    transform: scale(var(--app-scale));
    transform-origin: top left;
    width: 100%;
  }

  header{
    padding:16px calc(20px + env(safe-area-inset-right)) 16px calc(20px + env(safe-area-inset-left));
    background:linear-gradient(90deg, var(--accent), #8e79ff);
    color:white; position:sticky; top:0; z-index:10;
  }
  header h1{ margin:0; font-size: clamp(18px, 3.5vw, 22px); }
  main{ max-width:1100px; margin:20px auto; padding:0 16px; }
  .card{
    background:var(--panel); border-radius:14px; box-shadow:0 8px 24px rgba(31,42,68,.08);
    padding:16px;
  }
  .controls{ display:grid; gap:12px; grid-template-columns:1fr; }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .row > * { flex:0 0 auto; }
  label{ font-size:14px; color:var(--muted); }
  input[type="number"]{
    width:110px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:20px; text-align:center;
  }
  select{
    padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:18px;
  }
  button{
    border:0; border-radius:999px; padding:12px 16px; font-size:16px; background:#ecebff; color:#3e2cff;
    cursor:pointer; transition:.15s transform, .15s filter; font-weight:600; -webkit-tap-highlight-color: transparent;
  }
  button.primary{ background:#3e2cff; color:white; }
  button:disabled{ filter:grayscale(.8); opacity:.6; cursor:not-allowed; }
  .speed{ display:flex; align-items:center; gap:10px; color:var(--muted); }
  input[type="range"]{ width:180px; }

  .workspace{
    margin-top:16px; padding:14px; border:1px dashed #d1d5db; border-radius:12px; background:#fcfdff;
    position:relative; overflow:clip;
  }

  /* â˜… å¼ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’å¤§ããï¼ˆä¸Šé™ã‚’æ‹¡å¤§ï¼‰ */
  .equation{
    font-size: clamp(26px, 6vw, 48px);
    display:flex; align-items:center; gap:16px; justify-content:center; margin-bottom:12px;
  }
  .eq-num{ min-width:48px; text-align:center; font-weight:800; }
  .eq-op, .eq-eq{ opacity:.75; font-weight:800; }

  /* ç¸¦ä¸¦ã³ï¼ˆæ•°A â†’ æ•°B â†’ ã“ãŸãˆï¼‰ */
  .boards{
    display:grid; grid-template-columns: 1fr; gap:14px;
    align-items:start; justify-items:stretch;
  }
  .board{ width:100%; background:white; border:1px solid #edf2f7; border-radius:12px; padding:10px; }
  .board h3{ margin:0 0 8px; font-size:14px; color:var(--muted); text-align:left; }

  /* æ¨ª10åˆ—å›ºå®šãƒ»è‡ªå‹•ç¸®å°ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰ */
  .blocks{
    display:grid;
    grid-template-columns: repeat(10, var(--block-size));
    grid-auto-rows: var(--block-size);
    gap: var(--gap);
    justify-content:flex-start; align-content:start; width:100%;
  }

  /* ãƒ¦ãƒ‹ãƒƒãƒˆï¼ˆå°ãƒ–ãƒ­ãƒƒã‚¯ï¼å€¤1ï¼‰ */
  .block{
    width:var(--block-size); height:var(--block-size);
    border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,.08); position:relative;
  }
  /* 20ï¼šè–„ã‚ªãƒ¬ãƒ³ã‚¸ï¼‹å¤ªã‚ªãƒ¬ãƒ³ã‚¸æ ï¼ˆ1Ã—20ã§20ã‚’è¡¨ç¾ï¼‰ */
  .block.twentyu{ background:var(--twenty-bg); border:6px solid var(--twenty-border); }
  /* 10ï¼šç™½ï¼‹èµ¤æ ï¼ˆæ ç·šå¤ªã•ã‚’20ã¨åŒã˜6pxï¼‰ */
  .block.tenu{ background:var(--ten-bg); border:6px solid var(--ten-border); }

  /* ä¸€æ¡è‰² */
  .c-red{ background: var(--c-red); } .c-orange{ background: var(--c-orange); } .c-yellow{ background: var(--c-yellow); }
  .c-green{ background: var(--c-green); } .c-aqua{ background: var(--c-aqua); } .c-purple{ background: var(--c-purple); }
  .c-lilac{ background: var(--c-lilac); } .c-hotpink{ background: var(--c-hotpink); }
  .c-gray{ background: var(--c-gray); }             /* æ¨™æº–ã®ç° */
  .c-graylight{ background: var(--c-gray-light); } /* è–„ã„ç° */
  .c-graydark{ background: var(--c-gray-dark); }   /* æ¿ƒã„ç° */

  .hint{ margin-top:10px; color:var(--muted); font-size:14px; text-align:center; }

  /* é£›è¡Œã‚¯ãƒ­ãƒ¼ãƒ³ãƒ»æ¶ˆæ»… */
  .fly-clone{
    position:fixed; z-index:9999; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,.2);
    will-change: transform, opacity;
  }
  .poof{ animation: poof .35s ease forwards; }
  @keyframes poof{ 0% { transform: scale(1); opacity:1; } 100%{ transform: scale(.3); opacity:0; filter: blur(1px); } }
  .cross{ position:relative; overflow:hidden; }
  .cross::before, .cross::after{
    content:""; position:absolute; left:8px; right:8px; height:6px; background:rgba(255,255,255,.9); top:calc(50% - 3px);
    border-radius:6px; transform:rotate(45deg);
  }
  .cross::after{ transform:rotate(-45deg); }

  /* ãƒãƒ£ãƒ¬ãƒ³ã‚¸ UI */
  .challenge-bar{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:8px;
    border-top:1px dashed #e5e7eb; padding-top:10px;
  }
  .progress{ display:flex; gap:6px; align-items:center; }
  .dot{
    width:18px; height:18px; border-radius:50%;
    background:#e5e7eb; border:2px solid #c7c9d1;
  }
  .dot.done{ background:#22c55e; border-color:#16a34a; }
  .dot.fail{ background:#ef4444; border-color:#dc2626; }
  .score{ color:var(--muted); font-weight:700; }
  .ans-area{ display:flex; align-items:center; gap:8px; }
  #ansInput{ width:110px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:18px; text-align:center; }
  #checkMsg{ min-width:110px; font-weight:800; letter-spacing:.02em; }
  #dailyStats{ color:var(--muted); font-size:13px; margin-left:auto; }

  .hidden{ display:none !important; }

  /* ç¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå™´æ°´å‹ï¼šä¸‹éƒ¨ä¸­å¤®â†’ä¸Šã¸ï¼‰ */
  .celebrate{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:9998; }
  .confetti{
    position:fixed; bottom:0; left:50vw;
    width:10px; height:14px; opacity:0.95; border-radius:2px;
    animation: confetti-up 1s ease-out forwards;
  }
  @keyframes confetti-up{
    0%   { transform: translate(0, 0) rotate(0deg);   opacity:0.95; }
    100% { transform: translate(var(--dx, 0vw), -70vh) rotate(720deg); opacity:0; }
  }
  .pulse{ position:absolute; inset:0; pointer-events:none; z-index:9997; }
  .pulse::before{
    content:""; position:absolute; left:50%; top:50%; width:20vmin; height:20vmin;
    border-radius:50%; transform: translate(-50%,-50%);
    background: radial-gradient(circle, #fff7 0%, transparent 60%);
    animation: pulse-ring 900ms ease-out forwards;
  }
  @keyframes pulse-ring{
    0% { transform: translate(-50%,-50%) scale(.6); opacity:.9; }
    100%{ transform: translate(-50%,-50%) scale(2.4); opacity:0; }
  }
  .flash{ position:absolute; inset:0; background: var(--flash); animation: flashout 300ms ease-out forwards; }
  @keyframes flashout{ from{ opacity:1; } to{ opacity:0; } }

  @media (max-width:740px){
    :root{ --block-size:52px; --gap:8px; }
  }
</style>
</head>
<body>
<!-- â˜… å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾è±¡ã®ãƒ©ãƒƒãƒ‘ãƒ¼ -->
<div id="app">
  <header>
    <h1>ã¯ã˜ã‚ã¦ã® ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ10Ã—1 & ã‚¹ãƒ†ãƒ¼ã‚¸ï¼æœ€çµ‚ç‰ˆï¼‰</h1>
  </header>
  <main>
    <section class="card controls" aria-label="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«">
      <div class="row" id="basicControls">
        <label>æ¼”ç®—</label>
        <select id="op" aria-label="æ¼”ç®—ã‚’é¸æŠ">
          <option value="+">ï¼‹ï¼ˆãŸã™ï¼‰</option>
          <option value="-">âˆ’ï¼ˆã²ãï¼‰</option>
        </select>

        <label>æ•°A</label>
        <input id="a" type="number" min="0" max="99" value="13" inputmode="numeric" pattern="[0-9]*" />

        <label>æ•°B</label>
        <input id="b" type="number" min="0" max="99" value="7" inputmode="numeric" pattern="[0-9]*" />

        <button id="play" class="primary">â–¶ å†ç”Ÿ</button>
        <button id="reset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="random">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>

        <div class="speed">
          <span>ã‚¹ãƒ”ãƒ¼ãƒ‰</span>
          <input id="speed" type="range" min="0.5" max="2.0" step="0.25" value="1.0" />
          <span id="speedLabel">x1.0</span>
        </div>

        <button id="soundToggle">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰ ON</button>
      </div>

      <div class="challenge-bar">
        <label for="modeSel">å‡ºé¡Œ</label>
        <select id="modeSel" aria-label="ãƒãƒ£ãƒ¬ãƒ³ã‚¸å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰">
          <option value="plus" selected>è¶³ã—ç®—ã®ã¿</option>
          <option value="minus">å¼•ãç®—ã®ã¿</option>
          <option value="mixed">è¶³ã—ç®—ã¨å¼•ãç®—</option>
        </select>

        <label for="levelSel">é›£æ˜“åº¦</label>
        <select id="levelSel" aria-label="é›£æ˜“åº¦">
          <option value="easy" selected>ã‹ã‚“ãŸã‚“</option>
          <option value="normal">ãµã¤ã†</option>
          <option value="hard">ã‚€ãšã‹ã—ã„</option>
        </select>

        <button id="startChallenge">ğŸ ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹ï¼ˆ5å•ï¼‰</button>
        <div class="ans-area hidden" id="ansArea">
          <label for="ansInput">ã“ãŸãˆ</label>
          <input id="ansInput" type="number" inputmode="numeric" pattern="[0-9]*" min="0" />
          <button id="checkAnswer">âœ“ ç¢ºèª</button>
          <span id="checkMsg"></span>
          <button id="nextQ" class="hidden">æ¬¡ã¸ â–¶</button>
        </div>
        <div class="progress" id="progress"></div>
        <div class="score" id="score">æ­£è§£ 0/5</div>
        <div id="dailyStats">ä»Šæ—¥: ãƒãƒ£ãƒ¬ãƒ³ã‚¸0å› / æ­£è§£0å•</div>
        <button id="endChallenge" class="hidden">çµ‚äº†</button>
      </div>
    </section>

    <section class="card workspace" aria-label="ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹" id="workspace">
      <div class="equation" aria-live="polite">
        <span class="eq-num" id="eqA">13</span>
        <span class="eq-op" id="eqOp">âˆ’</span>
        <span class="eq-num" id="eqB">7</span>
        <span class="eq-eq">ï¼</span>
        <span class="eq-num" id="eqAns">ï¼Ÿ</span>
      </div>

      <!-- ç¸¦ä¸¦ã³ï¼šæ•°A â†’ æ•°B â†’ ã“ãŸãˆ -->
      <div class="boards" id="boards">
        <div class="board" aria-label="æ•°Aã®ãƒ–ãƒ­ãƒƒã‚¯">
          <h3>æ•°A</h3>
          <div class="blocks" id="left"></div>
        </div>

        <div class="board" aria-label="æ•°Bã®ãƒ–ãƒ­ãƒƒã‚¯">
          <h3>æ•°B</h3>
          <div class="blocks" id="right"></div>
        </div>

        <div class="board" aria-label="ã“ãŸãˆã®ãƒ–ãƒ­ãƒƒã‚¯">
          <h3>ã“ãŸãˆ</h3>
          <div class="blocks" id="result"></div>
        </div>
      </div>

      <div class="hint" id="hint">ã€Œå†ç”Ÿã€ã‚’æŠ¼ã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ãŒå‹•ãã¾ã™ã€‚</div>
    </section>
  </main>
</div>

<!-- ç¥ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç´™å¹é›ªãƒ»ãƒªãƒ³ã‚°ãƒ»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ -->
<div id="celebrate" class="celebrate hidden"></div>

<script>
(() => {
  const qs = s => document.querySelector(s);

  const el = {
    app: qs('#app'),
    op: qs('#op'), a: qs('#a'), b: qs('#b'),
    left: qs('#left'), right: qs('#right'), result: qs('#result'),
    eqA: qs('#eqA'), eqB: qs('#eqB'), eqOp: qs('#eqOp'), eqAns: qs('#eqAns'),
    hint: qs('#hint'), workspace: qs('#workspace'),
    play: qs('#play'), reset: qs('#reset'), random: qs('#random'),
    speed: qs('#speed'), speedLabel: qs('#speedLabel'),
    soundToggle: qs('#soundToggle'),

    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸
    modeSel: qs('#modeSel'), levelSel: qs('#levelSel'),
    startCh: qs('#startChallenge'), endCh: qs('#endChallenge'),
    ansArea: qs('#ansArea'), ansInput: qs('#ansInput'),
    checkBtn: qs('#checkAnswer'), checkMsg: qs('#checkMsg'),
    nextQ: qs('#nextQ'), progress: qs('#progress'), score: qs('#score'),
    dailyStats: qs('#dailyStats'),

    // åŸºæœ¬UI
    basicControls: qs('#basicControls'),

    // ç¥
    celebrate: qs('#celebrate'),
  };

  /* ========= ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼ˆå…¨ä½“ã‚’ç”»é¢ã«åã‚ã‚‹ï¼‰ ========= */
  function fitToViewport(){
    const app = el.app;
    if (!app) return;
    // ä¸€æ—¦ç­‰å€
    document.documentElement.style.setProperty('--app-scale', '1');
    const vw = window.innerWidth, vh = window.innerHeight;

    // appã®å®Ÿã‚µã‚¤ã‚ºã‚’æ¸¬ã‚‹
    const rect = app.getBoundingClientRect();
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä»®ã«è§£é™¤ã—ã¦å®Ÿé«˜ã•ã‚’æ¨å®š
    const fullH = app.scrollHeight;
    const fullW = app.scrollWidth;

    let scale = 1.0;
    if (fullH > vh) scale = Math.max(0.6, vh / fullH);  // é«˜ã•åŸºæº–
    // å¹…ã‚‚åã¾ã‚‹ã‚ˆã†èª¿æ•´
    if (fullW * scale > vw) {
      scale = Math.max(0.6, scale * (vw / (fullW * scale)));
    }
    document.documentElement.style.setProperty('--app-scale', scale.toFixed(3));
  }

  /* ========= å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
  let animating = false;
  let speedMul = parseFloat(el.speed.value || '1');
  let autoTimer = null; // è‡ªå‹•é·ç§»ã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ­£è§£æ™‚ã®ã¿ï¼‰
  const clamp = (v, lo, hi) => Math.min(Math.max(v, lo), hi);
  const ms = (base) => base / speedMul;

  function updateEq(a, b, op, ans=null){
    el.eqA.textContent = a;
    el.eqB.textContent = b;
    el.eqOp.textContent = (op === '+') ? 'ï¼‹' : 'âˆ’';
    el.eqAns.textContent = (ans === null ? 'ï¼Ÿ' : ans);
  }
  function setDisabled(dis){
    [el.op, el.a, el.b, el.random, el.reset].forEach(x=> x.disabled = dis);
    el.play.disabled = dis;
  }
  function clearBlocks(){ el.left.innerHTML=''; el.right.innerHTML=''; el.result.innerHTML=''; }

  /* ========= ä¸€æ¡è‰²é…åˆ— ========= */
  const COLOR_CLASS = {
    red:'c-red', orange:'c-orange', yellow:'c-yellow',
    green:'c-green', aqua:'c-aqua', purple:'c-purple',
    lilac:'c-lilac', hotpink:'c-hotpink',
    gray:'c-gray', graylight:'c-graylight', graydark:'c-graydark'
  };
  function onesColors(k){
    switch(k){
      case 0: return [];
      case 1: return [COLOR_CLASS.red];
      case 2: return [COLOR_CLASS.orange, COLOR_CLASS.orange];
      case 3: return [COLOR_CLASS.yellow, COLOR_CLASS.yellow, COLOR_CLASS.yellow];
      case 4: return Array(4).fill(COLOR_CLASS.green);
      case 5: return Array(5).fill(COLOR_CLASS.aqua);
      case 6: return Array(6).fill(COLOR_CLASS.purple);
      case 7: return [COLOR_CLASS.red, COLOR_CLASS.orange, COLOR_CLASS.yellow, COLOR_CLASS.green, COLOR_CLASS.aqua, COLOR_CLASS.purple, COLOR_CLASS.lilac];
      case 8: return Array(8).fill(COLOR_CLASS.hotpink);
      case 9: // â˜… è–„ç°3 â†’ ç°3 â†’ æ¿ƒç°3
        return [
          COLOR_CLASS.graylight, COLOR_CLASS.graylight, COLOR_CLASS.graylight,
          COLOR_CLASS.gray,      COLOR_CLASS.gray,      COLOR_CLASS.gray,
          COLOR_CLASS.graydark,  COLOR_CLASS.graydark,  COLOR_CLASS.graydark
        ];
      default: return [];
    }
  }

  /* ========= ãƒ¦ãƒ‹ãƒƒãƒˆç”Ÿæˆ ========= */
  function createTwentyUnit(role='left'){
    const d = document.createElement('div');
    d.className = `block twentyu ${role}`;
    d.dataset.kind = 'twentyu'; // å€¤1ï¼ˆè¦‹ãŸç›®ã¯20ã¾ã¨ã¾ã‚Šï¼‰Ã—20å€‹ã§20ã‚’è¡¨ç¾
    return d;
  }
  function createTenUnit(role='left'){
    const d = document.createElement('div');
    d.className = `block tenu ${role}`;
    d.dataset.kind = 'tenu'; // å€¤1ï¼ˆè¦‹ãŸç›®ã¯10ã¾ã¨ã¾ã‚Šï¼‰Ã—10å€‹ã§10ã‚’è¡¨ç¾
    return d;
  }
  function createOneUnit(colorClass, role='left'){
    const d = document.createElement('div');
    d.className = `block one ${colorClass} ${role}`;
    d.dataset.kind = 'one'; // å€¤1
    return d;
  }

  /**
   * n ã‚’ã€Œ20ã¾ã¨ã¾ã‚Šï¼ˆ20Ã—1ã‚’20å€‹ï¼‰â†’10ã¾ã¨ã¾ã‚Šï¼ˆ10Ã—1ã‚’10å€‹ï¼‰â†’ä¸€æ¡ã€ã¸åˆ†è§£
   * â€» å„è¦ç´ ã¯å€¤1ãªã®ã§ã€DOMå­è¦ç´ æ•°ã®åˆè¨ˆï¼n
   */
  function renderValue(container, n, role){
    const twenties = Math.floor(n / 20);
    let remain = n % 20;
    for (let i=0; i<twenties; i++){
      for (let j=0; j<20; j++){
        container.appendChild(createTwentyUnit(role));
      }
    }
    const tens = Math.floor(remain / 10);
    remain = remain % 10;
    for (let i=0; i<tens; i++){
      for (let j=0; j<10; j++){
        container.appendChild(createTenUnit(role));
      }
    }
    for (const cls of onesColors(remain)){
      container.appendChild(createOneUnit(cls, role));
    }
  }

  function populate(){
    const a = clamp(parseInt(el.a.value || '0', 10), 0, 99);
    const b = clamp(parseInt(el.b.value || '0', 10), 0, 99);
    el.a.value = a; el.b.value = b;
    clearBlocks();
    renderValue(el.left, a, 'left');
    renderValue(el.right, b, 'right');
    updateEq(a, b, el.op.value, null);
    el.hint.textContent = 'ã€Œå†ç”Ÿã€ã‚’æŠ¼ã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ãŒå‹•ãã¾ã™ã€‚';
    requestAnimationFrame(updateResponsiveSizes);
    requestAnimationFrame(fitToViewport);
  }

  /* ========= è‡ªå‹•ç¸®å°ï¼ˆæ¨ª10åˆ—ã«åã‚ã‚‹ï¼‰ ========= */
  function updateResponsiveSizes(){
    const wraps = [el.left, el.right, el.result];
    const widths = wraps.map(w => (w && (w.clientWidth || w.getBoundingClientRect().width)) || 0).filter(w => w>0);
    const minW = widths.length ? Math.min(...widths) : Math.max(320, el.workspace.clientWidth);
    let gap = clamp(Math.round(minW * 0.02), 3, 12);
    let bs  = Math.floor((minW - 9 * gap) / 10);
    if (bs < 10){ gap = 2; bs = Math.floor((minW - 9 * gap) / 10); }
    bs = Math.max(10, Math.min(bs, 96));
    document.documentElement.style.setProperty('--gap', `${gap}px`);
    document.documentElement.style.setProperty('--block-size', `${bs}px`);
  }
  window.addEventListener('resize', () => { requestAnimationFrame(updateResponsiveSizes); requestAnimationFrame(fitToViewport); });

  /* ========= ã‚¢ãƒ‹ãƒ¡åŸºç›¤ ========= */
  function flipMove(elm, newParent){
    return new Promise(resolve => {
      const start = elm.getBoundingClientRect();
      newParent.appendChild(elm);
      const end = elm.getBoundingClientRect();
      const dx = start.left - end.left;
      const dy = start.top - end.top;
      elm.style.transition = 'none';
      elm.style.transform = `translate(${dx}px, ${dy}px)`;
      requestAnimationFrame(() => {
        elm.style.transition = `transform ${ms(600)}ms ease`;
        elm.style.transform = 'translate(0,0)';
        const done = () => { elm.removeEventListener('transitionend', done); elm.style.transition=''; resolve(); };
        elm.addEventListener('transitionend', done, { once:true });
      });
    });
  }

  function flyClone(fromEl, toRect){
    return new Promise(resolve => {
      const r1 = fromEl.getBoundingClientRect();
      const clone = fromEl.cloneNode(true);
      clone.classList.add('fly-clone');
      clone.style.width = `${r1.width}px`;
      clone.style.height = `${r1.height}px`;
      clone.style.left = `${r1.left}px`;
      clone.style.top = `${r1.top}px`;
      clone.style.transition = `transform ${ms(500)}ms ease`;
      clone.style.transform = 'translate(0,0)';
      document.body.appendChild(clone);
      requestAnimationFrame(()=>{
        const dx = (toRect.left - r1.left);
        const dy = (toRect.top - r1.top);
        clone.style.transform = `translate(${dx}px, ${dy}px)`;
      });
      clone.addEventListener('transitionend', () => resolve(clone), { once:true });
    });
  }

  function flyAndPoofUnit(fromEl, toEl){
    return new Promise(async resolve => {
      const toRect = toEl.getBoundingClientRect();
      const clone = await flyClone(fromEl, toRect);
      toEl.classList.add('cross');
      clone.classList.add('poof');
      fromEl.remove();
      Audio.pop();
      setTimeout(()=>{
        toEl.classList.add('poof');
        setTimeout(()=>{
          toEl.remove();
          clone.remove();
          resolve();
        }, ms(320));
      }, ms(80));
    });
  }

  /* ========= ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ========= */
  async function animatePlus(a, b){
    el.hint.textContent = 'ãŸã—ã¦ã„ã‚‹ã‚ˆâ€¦';
    Audio.whoosh();
    for (const blk of Array.from(el.left.children)){ await flipMove(blk, el.result); }
    for (const blk of Array.from(el.right.children)){ await flipMove(blk, el.result); }
    const n = a + b;
    await new Promise(r=> setTimeout(r, ms(100)));
    el.result.innerHTML = '';
    renderValue(el.result, n, 'result');
    updateEq(a, b, '+', n);
    el.hint.textContent = 'ã§ããŸï¼ ã‚‚ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚‚è¦‹ã¦ã¿ã‚ˆã†ã€‚';
    updateResponsiveSizes(); fitToViewport();
    restoreSides(a, b);
  }

  async function animateMinus(a, b){
    if (b > a){ el.hint.textContent = 'â€» å¼•ãç®—ã¯ã€Œæ•°A â‰¥ æ•°Bã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
    el.hint.textContent = 'ã²ã„ã¦ã„ã‚‹ã‚ˆâ€¦ï¼ˆå³ç«¯ã‹ã‚‰æ¶ˆãˆã‚‹ã‚ˆï¼‰';
    for (let i=0; i<b; i++){
      const fromRight = el.right.lastElementChild;
      const targetLeft = el.left.lastElementChild;
      if (!fromRight || !targetLeft) break;
      await flyAndPoofUnit(fromRight, targetLeft);
    }
    for (const blk of Array.from(el.left.children)){ await flipMove(blk, el.result); }
    const n = a - b;
    await new Promise(r=> setTimeout(r, ms(100)));
    el.result.innerHTML = '';
    renderValue(el.result, n, 'result');
    updateEq(a, b, '-', n);
    el.hint.textContent = 'ã§ããŸï¼ ã‚‚ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚‚è¦‹ã¦ã¿ã‚ˆã†ã€‚';
    updateResponsiveSizes(); fitToViewport();
    restoreSides(a, b);
  }

  function restoreSides(a, b){
    el.left.innerHTML = '';
    el.right.innerHTML = '';
    renderValue(el.left, a, 'left');
    renderValue(el.right, b, 'right');
    updateResponsiveSizes(); fitToViewport();
  }

  /* ========= ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ========= */
  const QCOUNT = 5;
  const challenge = {
    active:false, list:[], idx:0, correct:0, marks:[], // 'done' / 'fail'
    mode:'plus', level:'easy'
  };

  function buildProgress(){
    el.progress.innerHTML = '';
    for (let i=0; i<QCOUNT; i++){
      const d = document.createElement('div');
      d.className = 'dot' + (challenge.marks[i] ? ' '+challenge.marks[i] : '');
      el.progress.appendChild(d);
    }
    el.score.textContent = `æ­£è§£ ${challenge.correct}/${QCOUNT}`;
  }

  function problemKey(p){
    if (p.op === '+'){
      const x = Math.min(p.a, p.b), y = Math.max(p.a, p.b);
      return `+:${x}:${y}`;
    }
    return `-:${p.a}:${p.b}`;
  }

  function rInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function rangesFor(level){
    switch(level){
      case 'easy':   return { a:[1,5],  b:[1,5]  };
      case 'normal': return { a:[5,10], b:[1,5]  };
      case 'hard':   return { a:[1,19], b:[1,10] };
      default:       return { a:[1,5],  b:[1,5]  };
    }
  }
  function genProblem(){
    const plus = challenge.mode==='plus' ? true : (challenge.mode==='minus' ? false : Math.random()<0.5);
    const {a:[aMin,aMax], b:[bMin,bMax]} = rangesFor(challenge.level);
    let a, b;
    if (plus){
      a = rInt(aMin, aMax);
      b = rInt(bMin, bMax);
    } else {
      a = rInt(aMin, aMax);
      const bUpper = Math.min(bMax, a);
      const bLower = Math.min(bMin, bUpper);
      b = rInt(bLower, bUpper);
    }
    return {op: plus?'+':'-', a, b};
  }

  function startChallenge(){
    challenge.mode = el.modeSel.value || 'plus';
    challenge.level = el.levelSel.value || 'easy';
    challenge.active = true;
    challenge.idx = 0;
    challenge.correct = 0;
    challenge.marks = Array(QCOUNT).fill('');
    const seen = new Set();
    const list = [];
    let guard = 0;
    const MAX_GUARD = 5000;
    while (list.length < QCOUNT && guard < MAX_GUARD){
      const p = genProblem();
      const key = problemKey(p);
      if (!seen.has(key)){ seen.add(key); list.push(p); }
      guard++;
    }
    challenge.list = list;

    el.basicControls.classList.add('hidden');
    el.ansArea.classList.remove('hidden');
    el.endCh.classList.remove('hidden');
    el.nextQ.classList.add('hidden');
    el.checkMsg.textContent = '';
    el.ansInput.value = '';

    loadChallengeProblem();
    buildProgress();
    updateResponsiveSizes(); fitToViewport();
  }

  function endChallenge(){
    saveDailyStats(1, challenge.correct);
    challenge.active = false;
    el.basicControls.classList.remove('hidden');
    el.ansArea.classList.add('hidden');
    el.endCh.classList.add('hidden');
    el.nextQ.classList.add('hidden');
    el.checkMsg.textContent = '';
    const total = challenge.correct;
    el.hint.textContent = `ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµ‚äº†ï¼ æ­£è§£ ${total}/${QCOUNT}`;
    if (total >= 3){ showStamp(); }
    updateResponsiveSizes(); fitToViewport();
  }

  function loadChallengeProblem(){
    const p = challenge.list[challenge.idx];
    el.op.value = p.op;
    el.a.value = p.a;
    el.b.value = p.b;
    populate();
    updateEq(p.a, p.b, p.op, null);
    el.ansInput.value = '';
    el.checkMsg.textContent = '';
    el.nextQ.classList.add('hidden');
    el.play.disabled = false;
    if (autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  }

  /* ========= ç¥ãƒ»ã‚µã‚¦ãƒ³ãƒ‰ ========= */
  function celebrate(){
    // æ­£è§£æ™‚ã®ã¿ã«å‘¼ã°ã‚Œã‚‹ï¼ˆä¸æ­£è§£ã§ã¯å‘¼ã°ãªã„ï¼‰
    // ç´™å¹é›ªï¼ˆä¸‹éƒ¨ä¸­å¤®â†’ä¸Šã¸æ‰‡çŠ¶ï¼‰
    const layer = el.celebrate;
    layer.classList.remove('hidden');
    const colors = ['#ef4444','#f59e0b','#facc15','#22c55e','#38bdf8','#a855f7','#e91e63','#9ca3af'];
    const count = 100;
    for (let i=0;i<count;i++){
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.background = colors[i % colors.length];
      c.style.setProperty('--dx', (Math.random()*80 - 40) + 'vw');
      c.style.animationDuration = (700 + Math.random()*900) + 'ms';
      c.style.animationDelay = (Math.random()*120) + 'ms';
      layer.appendChild(c);
    }
    Audio.chord();
    setTimeout(()=>{ layer.classList.add('hidden'); layer.innerHTML=''; }, 1300);
  }

  const STAMP_EMOJIS = [
    'ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸ',
    'ğŸ¥','ğŸ¥­','ğŸ','ğŸˆ','ğŸ«',
    'ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯',
    'ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ'
  ];
  function showStamp(){
    const e = STAMP_EMOJIS[Math.floor(Math.random()*STAMP_EMOJIS.length)];
    const stamp = document.createElement('div');
    stamp.className = 'stamp';
    stamp.innerHTML = `
      <div class="stamp-card">
        <div class="stamp-emoji">${e}</div>
        <div class="stamp-title">ã‚¹ã‚¿ãƒ³ãƒ—GETï¼</div>
        <div class="stamp-sub">ã‚ˆããŒã‚“ã°ã£ãŸã­</div>
        <button class="stamp-close">OK</button>
      </div>`;
    document.body.appendChild(stamp);
    const closer = () => { stamp.removeEventListener('click', closer); stamp.remove(); };
    const timer = setTimeout(closer, 3000);
    stamp.addEventListener('click', () => { clearTimeout(timer); closer(); });
  }

  // ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆWebAudioï¼‰
  const Audio = (()=> {
    let ctx=null, enabled=true;
    function ensure(){
      if (!ctx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        ctx = new AC();
      }
      if (ctx && ctx.state === 'suspended') ctx.resume();
    }
    function setEnabled(on){ enabled = !!on; return enabled; }
    function isOn(){ return !!enabled; }
    function osc(freq=440, dur=0.2, type='sine', vol=0.04){
      if (!enabled) return;
      ensure(); if (!ctx) return;
      const t = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type; o.frequency.value = freq;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(vol, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.start(t); o.stop(t+dur+0.05);
    }
    function chord(){ osc(880, 0.34, 'triangle', 0.06); osc(1174.66, 0.36, 'triangle', 0.05); osc(1567.98, 0.4, 'sine', 0.05); }
    function whoosh(){ osc(220, 0.14, 'sawtooth', 0.02); osc(330, 0.12, 'sine', 0.02); }
    function pop(){
      if (!enabled) return; ensure(); if (!ctx) return;
      const duration = 0.08;
      const buffer = ctx.createBuffer(1, ctx.sampleRate * duration, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0;i<data.length;i++){ const t = i / data.length; data[i] = (Math.random()*2 - 1) * (1 - t); }
      const src = ctx.createBufferSource();
      const g = ctx.createGain(); g.gain.value = 0.07;
      src.buffer = buffer; src.connect(g); g.connect(ctx.destination); src.start();
    }
    return { ensure, chord, whoosh, pop, setEnabled, isOn };
  })();

  el.soundToggle.addEventListener('click', () => {
    Audio.ensure();
    const nowOn = !Audio.isOn();
    Audio.setEnabled(nowOn);
    el.soundToggle.textContent = nowOn ? 'ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰ ON' : 'ğŸ”‡ ã‚µã‚¦ãƒ³ãƒ‰ OFF';
  });

  // å…¥åŠ›ï¼ˆç­”ãˆæ¬„ï¼šãƒã‚¤ãƒŠã‚¹ç¦æ­¢ï¼‰
  el.ansInput.addEventListener('keydown', (e) => {
    if (['-','+','e','E'].includes(e.key)) e.preventDefault();
  });
  el.ansInput.addEventListener('input', () => {
    el.ansInput.value = (el.ansInput.value || '').replace(/[^\d]/g,'');
  });
  el.ansInput.addEventListener('wheel', (e)=> e.preventDefault(), { passive:false });

  /* ========= æ—¥åˆ¥è¨˜éŒ² localStorage ========= */
  const STATS_KEY = 'kids-math-stats-v1';
  function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(STATS_KEY) || '{}'); }catch(e){ return {}; } }
  function saveStats(obj){ localStorage.setItem(STATS_KEY, JSON.stringify(obj)); }
  function saveDailyStats(challengeCount, correctAdd){
    const key = todayKey();
    const stats = loadStats();
    const cur = stats[key] || { challenges:0, correct:0 };
    cur.challenges += (challengeCount||0);
    cur.correct    += (correctAdd||0);
    stats[key] = cur;
    saveStats(stats);
    updateDailyStatsView();
  }
  function updateDailyStatsView(){
    const key = todayKey();
    const s = loadStats()[key] || {challenges:0, correct:0};
    el.dailyStats.textContent = `ä»Šæ—¥: ãƒãƒ£ãƒ¬ãƒ³ã‚¸${s.challenges}å› / æ­£è§£${s.correct}å•`;
  }

  /* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
  async function onPlay(){
    if (animating) return;
    const a = clamp(parseInt(el.a.value || '0', 10), 0, 99);
    const b = clamp(parseInt(el.b.value || '0', 10), 0, 99);
    const op = el.op.value;
    populate();
    animating = true;
    setDisabled(true);
    try{
      if (op === '+'){ await animatePlus(a, b); }
      else {
        if (b > a){ el.hint.textContent = 'â€» å¼•ãç®—ã¯ã€Œæ•°A â‰¥ æ•°Bã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; }
        else { await animateMinus(a, b); }
      }
    } finally {
      animating = false;
      setDisabled(false);
      if (challenge.active){ el.nextQ.classList.remove('hidden'); }
    }
  }
  function onReset(){ if (animating) return; clearBlocks(); populate(); }
  function onRandom(){
    if (animating) return;
    const op = Math.random() < 0.5 ? '+' : '-';
    let a, b;
    if (op === '+'){ a = Math.floor(Math.random()*21); b = Math.floor(Math.random()*21); }
    else { a = Math.floor(Math.random()*21)+9; b = Math.floor(Math.random()*(a+1)); }
    el.op.value = op; el.a.value = a; el.b.value = b; populate();
  }

  el.play.addEventListener('click', () => { Audio.ensure(); onPlay(); });
  el.reset.addEventListener('click', onReset);
  el.random.addEventListener('click', onRandom);
  [el.a, el.b, el.op].forEach(inp => inp.addEventListener('change', () => { populate(); fitToViewport(); }));
  el.speed.addEventListener('input', () => { speedMul = parseFloat(el.speed.value || '1'); el.speedLabel.textContent = `x${speedMul.toFixed(2).replace(/\.00$/,'')}`; });

  el.startCh.addEventListener('click', () => { Audio.ensure(); startChallenge(); });
  el.endCh.addEventListener('click', () => { if (autoTimer){ clearTimeout(autoTimer); autoTimer=null; } endChallenge(); });
  el.checkBtn.addEventListener('click', () => { Audio.ensure(); checkAnswer(); });
  el.nextQ.addEventListener('click', nextQuestion);
  el.modeSel.addEventListener('change', () => { if (!challenge.active) {/* è¨­å®šã®ã¿ */} });
  el.levelSel.addEventListener('change', () => { if (!challenge.active) {/* è¨­å®šã®ã¿ */} });

  // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å›ç­”ãƒã‚§ãƒƒã‚¯ & è‡ªå‹•é€²è¡Œ
  async function checkAnswer(){
    const p = challenge.list[challenge.idx];
    const n = p.op === '+' ? (p.a + p.b) : (p.a - p.b);
    const user = parseInt(el.ansInput.value || 'NaN', 10);
    if (user === n){
      el.checkMsg.textContent = 'â­• ã›ã„ã‹ã„ï¼';
      el.checkMsg.style.color = '#16a34a';
      if (!challenge.marks[challenge.idx]) challenge.correct++;
      challenge.marks[challenge.idx] = 'done';
      buildProgress();
      // â˜… æ­£è§£ã®ã¿ç¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      celebrate();
      // â˜… æ­£è§£ã§ã‚‚ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”¨ã®å¯è¦–åŒ–ã‚¢ãƒ‹ãƒ¡ã‚’è‡ªå‹•å†ç”Ÿ
      await onPlay();
      if (!challenge.active) return;
      // â˜… æ­£è§£æ™‚ã®ã¿3ç§’å¾Œã«è‡ªå‹•é·ç§»
      if (challenge.idx < QCOUNT - 1){ autoTimer = setTimeout(()=> nextQuestion(), 3000); }
      else { autoTimer = setTimeout(()=> endChallenge(), 3000); }
    } else {
      el.checkMsg.textContent = 'âŒ ã¡ãŒã†ã‚ˆ';
      el.checkMsg.style.color = '#ef4444';
      challenge.marks[challenge.idx] = 'fail';
      buildProgress();
      // â˜… ä¸æ­£è§£ã§ã‚‚å¯è¦–åŒ–ã‚¢ãƒ‹ãƒ¡ã‚’è‡ªå‹•å†ç”Ÿï¼ˆå­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
      await onPlay();
      // ä¸æ­£è§£æ™‚ã¯è‡ªå‹•é·ç§»ã—ãªã„ï¼ˆå†æŒ‘æˆ¦ã§ãã‚‹ï¼‰
    }
  }
  function nextQuestion(){
    if (autoTimer){ clearTimeout(autoTimer); autoTimer=null; }
    if (challenge.idx < QCOUNT - 1){
      challenge.idx++;
      loadChallengeProblem();
      buildProgress();
      fitToViewport();
    } else {
      endChallenge();
    }
  }

  // åˆæœŸåŒ–
  el.modeSel.value = 'plus'; challenge.mode = 'plus';
  el.levelSel.value = 'easy'; challenge.level = 'easy';
  populate();
  updateDailyStatsView();
  fitToViewport();

  /* ========= PWA: HTTPS or localhost ãªã‚‰ Service Workerç™»éŒ²ï¼ˆä»»æ„ï¼‰ ========= */
  if ('serviceWorker' in navigator &&
      (location.protocol === 'https:' || location.hostname === 'localhost')) {
    // sw.js ã‚’ç”¨æ„ã—ãŸå ´åˆã®ã¿æœ‰åŠ¹ï¼ˆãªãã¦ã‚‚å‹•ä½œå¯ï¼‰
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
})();
</script>
</body>
