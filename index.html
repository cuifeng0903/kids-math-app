<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚­ãƒƒã‚ºç®—æ•°ã‚¢ãƒ—ãƒª Ver.1.1.3 Fix2ï¼ˆå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆï¼‰</title>
  <meta name="theme-color" content="#ff6b6b" />

  <style>
    /* ====== åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ====== */
    :root {
      --accent: #ff6b6b;
      --primary: #2e6df6;
      --bg: #fafafa;
      --border: #eee;
      --text: #333;
    }
    body { margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; color: var(--text); background:#fff; }
    .km-container { max-width: 980px; margin: 0 auto; padding: 16px 20px; }
    .km-header { margin-bottom: 12px; }
    .km-title { font-size: 22px; font-weight: 700; }
    .km-title small { font-size: 12px; color: #888; margin-left: .5em; }

    .km-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .km-ops-tabs { display: inline-flex; gap: 8px; margin-bottom: 10px; }
    .km-tab { border: 1px solid #ddd; background: #fff; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 600; }
    .km-tab.is-active { background: #fff2f2; border-color: var(--accent); color: #d63a3a; }

    .km-settings { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; align-items: end; }
    .km-setting label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
    .km-select { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }

    .km-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .km-btn { border: 1px solid #ddd; background: #fff; border-radius: 10px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
    .km-btn:disabled { opacity: .5; cursor: not-allowed; }
    .km-btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .km-btn-accent { background: var(--accent); border-color: var(--accent); color: #fff; }
    .km-btn-ghost { background: #fff; color: #333; }

    .km-board { margin-top: 14px; border: 1px dashed #e8e8e8; border-radius: 10px; padding: 12px; }
    .km-row { display: grid; grid-template-columns: 1fr 60px 1fr 40px 1fr; gap: 8px; align-items: start; }
    .km-col { min-width: 0; }
    .km-col-operator, .km-col-equals { display: flex; align-items: center; justify-content: center; }
    .km-label { font-size: 12px; color: #666; margin: 6px 0; }

    .km-operator { font-size: 24px; font-weight: 900; color: var(--accent); }
    .km-equals { font-size: 20px; font-weight: 900; color: #333; }

    .km-value { text-align: center; margin-top: 6px; color: #333; }
    .km-num { font-weight: 800; font-size: 16px; }

    .km-blocks { display: grid; grid-template-columns: repeat(10, 18px); gap: 4px 4px; min-height: 26px; }
    .km-block { width: 18px; height: 18px; border-radius: 4px; background: #ffd5d5; border: 1px solid #ffb3b3; box-shadow: 0 1px 0 rgba(0,0,0,.04) inset; }
    .km-block.bA { background: #ffd5d5; border-color: #ffb3b3; }   /* A ã®è‰² */
    .km-block.bB { background: #d5ecff; border-color: #b3dbff; }   /* B ã®è‰² */
    .km-block.bSum { background: #fedb7a; border-color: #f9c94c; } /* åˆè¨ˆè‰² */

    .km-answer { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
    .km-answer-select { min-width: 120px; }

    .km-result { min-height: 20px; margin-top: 6px; font-weight: 700; }
    .km-result.ok { color: #d63a3a; }    /* èµ¤ã€‡ã£ã½ã„èµ¤ç³» */
    .km-result.ng { color: #666; }

    .km-formula { margin-top: 10px; text-align: center; font-weight: 800; font-size: 16px; letter-spacing: .02em; }

    .km-reward-area { margin-top: 12px; display: flex; gap: 12px; align-items: center; }
    .km-stamps { display: flex; gap: 8px; align-items: center; }
    .km-stamp-slot { width: 56px; height: 56px; border: 2px dashed #ccc; border-radius: 12px; display: grid; place-items: center; color: #bbb; }

    @media (max-width: 720px) {
      .km-settings { grid-template-columns: 1fr 1fr; }
      .km-row { grid-template-columns: 1fr 40px 1fr 30px 1fr; }
    }
  </style>
</head>
<body>
  <main id="app" class="km-container">
    <header class="km-header">
      <h1 class="km-title">ã‚­ãƒƒã‚ºç®—æ•°ã‚¢ãƒ—ãƒª <small>Ver.1.1.3 Fix2</small></h1>
    </header>

    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <section class="km-panel">
      <div class="km-ops-tabs" role="tablist" aria-label="æ¼”ç®—ã®é¸æŠ">
        <button class="km-tab is-active" data-op="add" role="tab" aria-selected="true">ãŸã—ã–ã‚“</button>
        <button class="km-tab" data-op="sub" role="tab" aria-selected="false">ã²ãã–ã‚“</button>
      </div>

      <div class="km-settings">
        <div class="km-setting">
          <label for="firstNum">ã¯ã˜ã‚ã®ã‹ãš</label>
          <select id="firstNum" class="km-select"></select>
        </div>
        <div class="km-setting">
          <label for="secondNum">ã¤ãã®ã‹ãš</label>
          <select id="secondNum" class="km-select"></select>
        </div>
        <div class="km-setting">
          <label for="difficulty">é›£æ˜“åº¦</label>
          <select id="difficulty" class="km-select">
            <option value="easy">ã‚„ã•ã—ã„ï¼ˆ1ã€œ10ï¼‰</option>
            <option value="normal" selected>ãµã¤ã†ï¼ˆ1ã€œ20ï¼‰</option>
            <option value="hard">ã‚€ãšã‹ã—ã„ï¼ˆ1ã€œ50ï¼‰</option>
          </select>
        </div>
        <div class="km-actions">
          <button id="btnStart" class="km-btn km-btn-primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="btnReset" class="km-btn" disabled>ã‚„ã‚ŠãªãŠã—</button>
        </div>
      </div>
    </section>

    <!-- è¡¨ç¤ºé ˜åŸŸ -->
    <section class="km-board" aria-live="polite" aria-atomic="true">
      <div class="km-row">
        <div class="km-col">
          <h2 class="km-label">ã¯ã˜ã‚ã®ã‹ãš</h2>
          <div id="laneA" class="km-blocks" data-lane="A"></div>
          <div class="km-value"><span id="valueA" class="km-num">0</span></div>
        </div>

        <div class="km-col km-col-operator">
          <div id="opBadge" class="km-operator">ï¼‹</div>
        </div>

        <div class="km-col">
          <h2 class="km-label">ã¤ãã®ã‹ãš</h2>
          <div id="laneB" class="km-blocks" data-lane="B"></div>
          <div class="km-value"><span id="valueB" class="km-num">0</span></div>
        </div>

        <div class="km-col km-col-equals">
          <div class="km-equals">ï¼</div>
        </div>

        <div class="km-col">
          <h2 class="km-label">ã“ãŸãˆ</h2>
          <div id="laneAns" class="km-blocks km-blocks-answer" data-lane="ANS"></div>
          <div class="km-answer">
            <select id="answer" class="km-select km-answer-select" disabled></select>
            <button id="btnCheck" class="km-btn km-btn-accent" disabled>ã“ãŸãˆã‚ã‚ã›</button>
          </div>
          <div id="resultMsg" class="km-result" role="status"></div>
        </div>
      </div>

      <div class="km-formula">
        <span id="fA">0</span>
        <span id="fOp">ï¼‹</span>
        <span id="fB">0</span>
        <span>ï¼</span>
        <span id="fQ">ï¼Ÿ</span>
      </div>
    </section>

    <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼†ã‚¹ã‚¿ãƒ³ãƒ— -->
    <section class="km-reward-area">
      <button id="btnChallenge" class="km-btn km-btn-ghost" title="ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆã‹ã‚“ã‚€ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰">ğŸ‘‘ ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
      <div class="km-stamps">
        <div class="km-stamp-slot" aria-label="ã”ã»ã†ã³ã‚¹ã‚¿ãƒ³ãƒ—"></div>
      </div>
    </section>
  </main>

  <noscript>ã“ã®ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ JavaScript ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</noscript>

  <script>
    /** =========================
     *  Ver.1.1.3 Fix2 å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ
     *  - UI/ãƒ­ã‚¸ãƒƒã‚¯/Manifest å‹•çš„ç”Ÿæˆ
     *  - SWã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ï¼ˆä¸‹ã®sw.jsã‚’ä¿å­˜ï¼‰
     * ========================= */

    // ====== ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹æ¤œå‡ºï¼ˆGH Pagesã®ã‚µãƒ–ãƒ‘ã‚¹å¯¾å¿œï¼‰ ======
    const guessBase = (() => {
      // æœŸå¾…ã•ã‚Œã‚‹å…¬é–‹URL: https://{user}.github.io/kids-math-app/
      const p = location.pathname;
      // /kids-math-app/ ã‚’å«ã‚€å ´åˆã¯ãã“ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹
      const i = p.indexOf('/kids-math-app/');
      if (i >= 0) return '/kids-math-app/';
      // ãã‚Œä»¥å¤–ã¯ "/" ã§å‹•ä½œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãªã©ï¼‰
      return '/';
    })();
    const BASE = guessBase.endsWith('/') ? guessBase : (guessBase + '/');

    // ====== ç”»é¢è¦ç´ å‚ç…§ ======
    const $  = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => [...el.querySelectorAll(sel)];

    const firstNum   = $('#firstNum');
    const secondNum  = $('#secondNum');
    const difficulty = $('#difficulty');
    const tabs       = $$('.km-tab');
    const opBadge    = $('#opBadge');
    const valueA     = $('#valueA');
    const valueB     = $('#valueB');
    const laneA      = $('#laneA');
    const laneB      = $('#laneB');
    const laneAns    = $('#laneAns');
    const ansSel     = $('#answer');
    const btnStart   = $('#btnStart');
    const btnReset   = $('#btnReset');
    const btnCheck   = $('#btnCheck');
    const resultMsg  = $('#resultMsg');
    const btnChallenge = $('#btnChallenge');

    const fA = $('#fA'), fB = $('#fB'), fOp = $('#fOp'), fQ = $('#fQ');

    // ====== çŠ¶æ…‹ãƒ»å®šæ•° ======
    let op = 'add';     // 'add' | 'sub'
    let A = 0, B = 0;
    let answeredSet = new Set(); // é‡è¤‡å›é¿
    const DIFF_MAX = { easy: 10, normal: 20, hard: 50 };

    // ====== Manifestï¼ˆå‹•çš„ç”Ÿæˆï¼‰ ======
    (function attachManifest() {
      const manifest = {
        id: BASE,
        name: "ã‚­ãƒƒã‚ºç®—æ•°ã‚¢ãƒ—ãƒª",
        short_name: "ç®—æ•°",
        lang: "ja",
        dir: "ltr",
        start_url: BASE,
        scope: BASE,
        display: "standalone",
        orientation: "portrait",
        theme_color: "#ff6b6b",
        background_color: "#ffffff",
        icons: [
          // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆãªã®ã§ã‚¢ã‚¤ã‚³ãƒ³ã¯çœç•¥ï¼ˆä»»æ„ã§è¿½åŠ å¯èƒ½ï¼‰
          // { src: BASE + "icons/icon-192.png", sizes: "192x192", type: "image/png" },
          // { src: BASE + "icons/icon-512.png", sizes: "512x512", type: "image/png" }
        ]
      };
      try {
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const url  = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel   = 'manifest';
        link.href  = url;
        document.head.appendChild(link);
      } catch (e) {
        console.warn('[Manifest] attach failed:', e);
      }
    })();

    // ====== Service Worker ç™»éŒ²ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰ ======
    (function registerSWIfPresent() {
      if (!('serviceWorker' in navigator)) return;

      window.addEventListener('load', async () => {
        const swUrl = BASE + 'sw.js'; // åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ãŒå¿…è¦
        try {
          // äº‹å‰ã«å­˜åœ¨ç¢ºèªï¼ˆ404ç­‰ã§ç„¡é§„ç™»éŒ²ã‚’é¿ã‘ã‚‹ï¼‰
          const head = await fetch(swUrl, { method:'HEAD' });
          if (!head.ok) throw new Error('sw.js not found');
          const reg = await navigator.serviceWorker.register(swUrl, { scope: BASE });
          console.log('[SW] registered:', reg.scope);
        } catch (err) {
          console.info('[SW] not registered (single-file mode / sw.js missing). Online-only:', err?.message || err);
        }
      });
    })();

    // ====== UIãƒ­ã‚¸ãƒƒã‚¯ ======
    function currentMax() { return DIFF_MAX[difficulty.value] || 20; }
    function renderBlocks(el, count, cls) {
      el.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const d = document.createElement('div');
        d.className = `km-block ${cls}`;
        el.appendChild(d);
      }
    }
    function setOperator(opKey) {
      op = opKey;
      if (op === 'add') { opBadge.textContent = 'ï¼‹'; fOp.textContent = 'ï¼‹'; }
      else { opBadge.textContent = 'ï¼'; fOp.textContent = 'ï¼'; }
    }
    function getCorrect() { return op === 'add' ? (A + B) : (A - B); }
    function updateFormula(showAns=false) {
      fA.textContent = A;
      fB.textContent = B;
      fQ.textContent = showAns ? getCorrect() : 'ï¼Ÿ';
    }
    function fillNumberOptions(max) {
      [firstNum, secondNum, ansSel].forEach(s => s.innerHTML = '');
      for (let i = 0; i <= max; i++) {
        firstNum.appendChild(new Option(String(i), String(i)));
        secondNum.appendChild(new Option(String(i), String(i)));
      }
      ansSel.appendChild(new Option('ï¼Ÿ', '', true, true));
      ansSel.disabled = true; btnCheck.disabled = true;
    }
    function applyValuesToUI() {
      valueA.textContent = A;
      valueB.textContent = B;
      renderBlocks(laneA, A, 'bA');
      renderBlocks(laneB, B, 'bB');
      renderBlocks(laneAns, 0, 'bSum');
      updateFormula(false);
      resultMsg.textContent = ''; resultMsg.className = 'km-result';
    }
    function buildAnswerChoices() {
      const correct = getCorrect();
      const max = Math.max(currentMax(), Math.max(A, B) + 5);
      const deltas = [-3,-2,-1,1,2,3,4,5,6];
      const set = new Set([correct]);
      while (set.size < 6) {
        const base = correct + deltas[Math.floor(Math.random() * deltas.length)];
        set.add(Math.max(0, Math.min(max, base)));
      }
      const arr = [...set].sort((x,y)=>x-y);
      ansSel.innerHTML = ''; ansSel.appendChild(new Option('ï¼Ÿ','',true,true));
      arr.forEach(n => ansSel.appendChild(new Option(String(n), String(n))));
      ansSel.disabled = false; btnCheck.disabled = true;
    }
    function problemKey(a,b,op) {
      if (op === 'add') {
        const s = [a,b].sort((x,y)=>x-y);
        return `add:${s[0]},${s[1]}`;
      }
      return `sub:${a},${b}`;
    }
    async function playAnimation() {
      const total = Math.max(getCorrect(), 0);
      renderBlocks(laneAns, total, 'bSum');
      await new Promise(r => setTimeout(r, 180));
    }
    function confettiMini() {
      const box = document.createElement('div');
      Object.assign(box.style, { position:'fixed', inset:'0', pointerEvents:'none', zIndex:'9999' });
      document.body.appendChild(box);
      const count = 80;
      for (let i=0; i<count; i++) {
        const p = document.createElement('i');
        const size = Math.random()*8+4;
        Object.assign(p.style, {
          position:'absolute', left:(Math.random()*100)+'vw', top:'-10px',
          width:size+'px', height:size+'px',
          background:`hsl(${Math.random()*360},90%,60%)`,
          transform:`rotate(${Math.random()*360}deg)`,
          borderRadius:'2px', opacity:'0.9',
          transition:'transform 1.2s linear, top 1.2s linear, opacity .2s ease-out'
        });
        box.appendChild(p);
        requestAnimationFrame(()=>{
          p.style.top = (Math.random()*100+10) + 'vh';
          p.style.transform = `translateY(0) rotate(${Math.random()*720}deg)`;
        });
      }
      setTimeout(()=>box.remove(), 1400);
    }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆæŸã­ ======
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
        setOperator(btn.dataset.op);
        applyValuesToUI();
      });
    });
    difficulty.addEventListener('change', () => {
      fillNumberOptions(currentMax());
      A = Math.min(A, currentMax());
      B = Math.min(B, currentMax());
      firstNum.value = String(A);
      secondNum.value = String(B);
      applyValuesToUI();
    });
    firstNum.addEventListener('change', () => { A = Number(firstNum.value); valueA.textContent = A; renderBlocks(laneA,A,'bA'); updateFormula(false); });
    secondNum.addEventListener('change', () => { B = Number(secondNum.value); valueB.textContent = B; renderBlocks(laneB,B,'bB'); updateFormula(false); });

    btnStart.addEventListener('click', () => {
      A = Number(firstNum.value);
      B = Number(secondNum.value);
      const key = problemKey(A,B,op);
      if (answeredSet.has(key)) {
        const max = currentMax();
        if (op === 'add') {
          A = Math.floor(Math.random()*(max+1));
          B = Math.floor(Math.random()*(max+1));
        } else {
          const x = Math.floor(Math.random()*(max+1));
          const y = Math.floor(Math.random()*(max+1));
          A = Math.max(x,y); B = Math.min(x,y);
        }
        firstNum.value = String(A);
        secondNum.value = String(B);
      }
      applyValuesToUI();
      buildAnswerChoices();
      btnReset.disabled = false;
    });

    btnReset.addEventListener('click', () => {
      laneAns.innerHTML = '';
      ansSel.selectedIndex = 0; ansSel.disabled = true; btnCheck.disabled = true;
      resultMsg.textContent = ''; resultMsg.className = 'km-result';
      updateFormula(false);
    });

    ansSel.addEventListener('change', () => { btnCheck.disabled = (ansSel.value===''); });

    btnCheck.addEventListener('click', async () => {
      const val = Number(ansSel.value);
      const correct = getCorrect();
      if (Number.isNaN(val)) return;

      if (val === correct) {
        await playAnimation();
        resultMsg.textContent = 'ğŸ…¾ ã›ã„ã‹ã„ï¼';
        resultMsg.className = 'km-result ok';
        const slot = document.querySelector('.km-stamp-slot'); slot.textContent = 'â­ï¸';
        confettiMini();
        setTimeout(()=>btnChallenge.click(), 800);
        answeredSet.add(problemKey(A,B,op));
        updateFormula(true);
      } else {
        resultMsg.textContent = 'ã‚‚ã†ã„ã¡ã©ï¼';
        resultMsg.className = 'km-result ng';
      }
    });

    btnChallenge.addEventListener('click', () => {
      const max = currentMax();
      if (op === 'add') {
        A = Math.floor(Math.random()*(max+1));
        B = Math.floor(Math.random()*(max+1));
      } else {
        const x = Math.floor(Math.random()*(max+1));
        const y = Math.floor(Math.random()*(max+1));
        A = Math.max(x,y); B = Math.min(x,y);
      }
      firstNum.value = String(A);
      secondNum.value = String(B);
      applyValuesToUI();
      buildAnswerChoices();
      btnReset.disabled = false;
    });

    // ====== åˆæœŸè¡¨ç¤º ======
    fillNumberOptions(currentMax());
    A = 3; B = 2; firstNum.value = '3'; secondNum.value = '2';
    setOperator('add');
    applyValuesToUI();
  </script>
