<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#0b2340">

<!-- ‚úÖ Ê≠£„Åó„ÅÑ„É™„É≥„ÇØ„ÇíÊòéÁ§∫Ôºà„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÁ¶ÅÊ≠¢Ôºâ -->
/kids-math-app/manifest.webmanifest
/kids-math-app/apple-touch-icon.png

<title>„Åø„Çì„Å™„ÅÆ„Åï„Çì„Åô„ÅÜ - „Åü„Åó„Åñ„Çì„Éª„Å≤„Åç„Åñ„Çì</title>
<style>
  :root{ --bg:#f7fafc; --ink:#223; --muted:#667; --card:#fff; --border:#e6e9ef; --shadow:0 4px 16px rgba(0,0,0,0.08);
    --focus:#3b82f6; --radius:16px; --radius-sm:12px; --red:#e53935; --orange:#ff8c00; --yellow:#ffd54a; --green:#42c58a;
    --sky:#4aa3ff; --purple:#9c27b0; --lavender:#c8a2c8; --deeppink:#ff1493; --gray-light:#d9d9d9; --gray:#9e9e9e; --gray-dark:#616161;
    --ten-border:#e53935; --twenty-border:#ff9800; --twenty-bg:#fffaf0; --ok:#e53935; --ng:#1e88e5; }
  *{box-sizing:border-box}
  html,body{background:var(--bg); color:var(--ink); font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Yu Gothic","Meiryo",sans-serif;
    -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%;}
  body{ margin:0; padding-bottom: env(safe-area-inset-bottom); min-height:100vh; }
  @supports (min-height:100svh){ body{ min-height:100svh; } }
  header{ position:sticky; top:0; z-index:50; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center; padding: calc(12px + env(safe-area-inset-top)) 16px 12px 16px; }
  header h1{margin:0; font-size:1.2rem}
  .shell{max-width:980px; margin:0 auto; padding:10px 16px}
  .controls{position:sticky; top:calc(56px + env(safe-area-inset-top)); z-index:40; background:var(--bg); border-bottom:1px solid var(--border);}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:10px 0}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:10px}
  .row1{font-size:1.12rem} .row2{font-size:0.98rem}
  .label{font-weight:700} .label-inline{display:flex; align-items:center; gap:8px}
  button{appearance:none; border:none; border-radius:14px; padding:12px 16px; font-size:1.05rem; background:#fff; border:1px solid var(--border); box-shadow:var(--shadow); color:var(--ink)}
  button.primary{background:var(--focus); color:#fff; border-color:transparent} button.mute{background:#f2f4f8} button.big{font-size:1.15rem}
  button:active{transform:scale(0.98)} button:focus{outline:none}
  .seg{display:flex; background:#f2f4f8; border-radius:14px; overflow:hidden; border:1px solid var(--border)}
  .seg-btn{appearance:none; border:none; padding:10px 12px; font-weight:700; background:transparent}
  .seg-btn.active{background:#fff; color:var(--focus)}
  select{appearance:none; padding:12px 14px; border-radius:12px; border:2px solid var(--border); background:#fff;}
  .big-select{font-size:1.35rem; min-width:132px} .small-select{font-size:1.05rem; min-width:120px}
  .stage{padding-top:10px}
  .equation{display:flex; align-items:center; justify-content:center; gap:12px; font-size:1.8rem; padding:10px; flex-wrap:wrap}
  .num-display{min-width:74px; min-height:74px; display:flex; align-items:center; justify-content:center; background:white; border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); font-weight:800}
  .op,.equals{min-width:40px; text-align:center}
  .area{display:flex; flex-direction:column; gap:16px; padding:10px 0 24px 0}
  .group{width:100%; background:#fff; border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px}
  .group h3{margin:0 0 6px 0; font-size:0.98rem; color:var(--muted)}
  .blocks{display:flex; flex-wrap:wrap; gap:8px; min-height:60px; padding:6px; touch-action: manipulation;}
  .block{width:42px; height:42px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1)}
  .b-red{background:#e53935} .b-orange{background:#ff8c00} .b-yellow{background:#ffd54a} .b-green{background:#42c58a}
  .b-sky{background:#4aa3ff} .b-purple{background:#9c27b0} .b-lavender{background:#c8a2c8} .b-deeppink{background:#ff1493}
  .b-gray-light{background:#d9d9d9} .b-gray{background:#9e9e9e} .b-gray-dark{background:#616161}
  .b-ten{background:#fff; border:6px solid var(--ten-border)} .b-twenty{background:#fffaf0; border:6px solid var(--twenty-border)}
  .bounce-in{animation:bounceIn 360ms ease-out}
  @keyframes bounceIn{0%{transform:scale(0.6); opacity:0}60%{transform:scale(1.06); opacity:1}100%{transform:scale(1)}}
  .overlay{position:fixed; inset:0; pointer-events:none; z-index:1000}
  .mark{position:absolute; left:50%; top:45%; transform:translate(-50%,-50%) scale(0.6); width:300px; height:300px; opacity:0}
  .mark.show{animation:markPop 700ms ease-out forwards}
  @keyframes markPop{0%{opacity:0; transform:translate(-50%,-50%) scale(0.6)}40%{opacity:1; transform:translate(-50%,-50%) scale(1.06)}100%{opacity:1; transform:translate(-50%,-50%) scale(1)}}
  .mark.correct{border:20px solid var(--ok); border-radius:50%}
  .mark.wrong::before, .mark.wrong::after{content:""; position:absolute; left:50%; top:50%; width:22px; height:320px; background:var(--ng); transform-origin:center;}
  .mark.wrong::before{transform:translate(-50%,-50%) rotate(45deg)} .mark.wrong::after{transform:translate(-50%,-50%) rotate(-45deg)}
  .confetti{position:fixed; bottom:-8px; width:9px; height:18px; opacity:0.95; border-radius:2px; z-index:1001}
  .confetti.fly{animation:confettiFly 1200ms ease-out forwards}
  @keyframes confettiFly{0%{transform:translate(var(--x0), var(--y0)) rotate(0deg); opacity:1}100%{transform:translate(var(--x1), var(--y1)) rotate(var(--rot)); opacity:0}}
  .reward{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25)}
  .reward .box{pointer-events:auto; background:#fff; border-radius:18px; padding:24px; border:4px solid #eee; text-align:center;
    box-shadow:0 18px 40px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:12px; align-items:center}
  .stamp{display:inline-flex; align-items:center; justify-content:center; width:220px; height:220px; border:10px solid #ff8c00;
    border-radius:18px; background:#fffaf0; font-size:7rem; box-shadow:inset 0 0 0 6px rgba(255,140,0,0.2)}
  .reward .btn-stack{display:flex; flex-direction:column; gap:10px; width:100%; align-items:center}
  .reward button{pointer-events:auto; min-width:180px}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
</style>
</head>
<body>
<header>
  <h1>„Åø„Çì„Å™„ÅÆ„Åï„Çì„Åô„ÅÜ</h1>
  <div style="color:#667">„Åø„Å¶„Éª„Åï„Çè„Å£„Å¶Â≠¶„Åº„ÅÜ</div>
</header>

<!-- ‰∏äÈÉ®2ÊÆµÔºàÂ≠¶„Å∂Ôºã„ÉÅ„É£„É¨„É≥„Ç∏Ë®≠ÂÆöÔºâ -->
<div class="controls">
  <div class="shell">
    <div class="card" id="topLearnCard">
      <div id="row1" class="row row1" aria-label="‰∏äÊÆµÔºàÂ≠¶„Å∂Ôºâ">
        <div class="seg" aria-label="„Åà„Çâ„Å∂">
          <button class="seg-btn active" id="opAdd">„Åü„Åó„Åñ„Çì</button>
          <button class="seg-btn" id="opSub">„Å≤„Åç„Åñ„Çì</button>
        </div>
        <div class="label-inline">
          <span class="label">„ÅØ„Åò„ÇÅ„ÅÆ„Åã„ÅöÔºö</span>
          <label class="sr-only" for="aSelect">„ÅØ„Åò„ÇÅ„ÅÆ„Åã„Åö</label>
          <select id="aSelect" class="big-select" aria-label="„ÅØ„Åò„ÇÅ„ÅÆ„Åã„Åö"></select>
        </div>
        <div class="label-inline">
          <span class="label">„Å§„Åé„ÅÆ„Åã„ÅöÔºö</span>
          <label class="sr-only" for="bSelect">„Å§„Åé„ÅÆ„Åã„Åö</label>
          <select id="bSelect" class="big-select" aria-label="„Å§„Åé„ÅÆ„Åã„Åö"></select>
        </div>
        <button id="playBtn" class="primary">„Çπ„Çø„Éº„Éà</button>
      </div>
      <div id="row2" class="row row2" aria-label="‰∏ãÊÆµÔºà„ÉÅ„É£„É¨„É≥„Ç∏Ë®≠ÂÆöÔºâ">
        <div class="seg" aria-label="Âá∫È°å„Çø„Ç§„Éó" id="typeSeg">
          <button class="seg-btn active" id="typeAdd">„Åü„Åó„Åñ„Çì</button>
          <button class="seg-btn" id="typeSub">„Å≤„Åç„Åñ„Çì</button>
          <button class="seg-btn" id="typeBoth">„Çä„Çá„ÅÜ„Åª„ÅÜ</button>
        </div>
        <div class="seg" aria-label="„ÇÄ„Åö„Åã„Åó„Åï" id="diffSeg">
          <button class="seg-btn active" id="diffEasy">„Åã„Çì„Åü„Çì</button>
          <button class="seg-btn" id="diffNormal">„Åµ„Å§„ÅÜ</button>
          <button class="seg-btn" id="diffHard">„ÇÄ„Åö„Åã„Åó„ÅÑ</button>
        </div>
        <button id="startChallenge" class="big">üëë „ÉÅ„É£„É¨„É≥„Ç∏</button>
      </div>
    </div>

    <!-- „ÉÅ„É£„É¨„É≥„Ç∏ÂõûÁ≠î„Éê„Éº -->
    <div id="topChallenge" class="card" style="display:none" aria-label="‰∏äÈÉ®ÂÖ•ÂäõÔºà„ÉÅ„É£„É¨„É≥„Ç∏ÂõûÁ≠îÔºâ">
      <div class="row row1" style="justify-content:space-between">
        <div style="font-weight:700">„ÉÅ„É£„É¨„É≥„Ç∏Ôºö<span id="progressText">1 / 5</span></div>
        <div id="score" style="font-size:1.1rem; color:#f5b301"></div>
      </div>
      <div class="row row2">
        <label class="sr-only" for="ansSelect">„Åì„Åü„Åà</label>
        <select id="ansSelect" class="small-select" aria-label="„Åì„Åü„Åà"></select>
        <button id="submitAns" class="primary">„Åì„Åü„Åà„Çí „Åç„ÇÅ„Çã</button>
        <button id="cancelChallenge" class="mute">„ÇÑ„ÇÅ„Çã</button>
      </div>
    </div>
  </div>
</div>

<!-- Âºè„Å®Ë°®Á§∫È†òÂüüÔºàÁ∏¶ÈÖçÁΩÆÔºâ -->
<div class="shell stage">
  <div class="equation">
    <div class="num-display" id="numA">3</div>
    <div class="op" id="opText">Ôºã</div>
    <div class="num-display" id="numB">2</div>
    <div class="equals">Ôºù</div>
    <div class="num-display" id="numAns">5</div>
  </div>
  <div class="area">
    <div class="group"><h3>„ÅØ„Åò„ÇÅ„ÅÆ „Åã„Åö</h3><div class="blocks" id="groupA"></div></div>
    <div class="group"><h3 id="middleTitle">„Å§„Åé„ÅÆ „Åã„ÅöÔºà„Åü„ÅôÔºâ</h3><div class="blocks" id="groupB"></div></div>
    <div class="group"><h3>„Åì„Åü„Åà</h3><div class="blocks" id="groupAns"></div></div>
  </div>
</div>

<div id="overlay" class="overlay" aria-hidden="true"></div>

<script>
(function(){
  // ====== State & ElementsÔºàÁúÅÁï•„Åõ„ÅöÂÆüË£ÖÔºâ ======
  const state = { a:3, b:2, op:'add', max:40,
    cRunning:false, cType:'add', cDiff:'easy', cLen:5, cIdx:0, cScore:0, cSeen:new Set(), cAnswered:false,
    cQ:{a:0,b:0,op:'add',answer:0} };

  const $ = (id) => document.getElementById(id);

  const numA=$('numA'), numB=$('numB'), numAns=$('numAns'), opText=$('opText'), middleTitle=$('middleTitle');
  const groupA=$('groupA'), groupB=$('groupB'), groupAns=$('groupAns');
  const topLearnCard=$('topLearnCard'), opAdd=$('opAdd'), opSub=$('opSub'), aSelect=$('aSelect'), bSelect=$('bSelect'), playBtn=$('playBtn');
  const typeAdd=$('typeAdd'), typeSub=$('typeSub'), typeBoth=$('typeBoth'), diffEasy=$('diffEasy'), diffNormal=$('diffNormal'), diffHard=$('diffHard'), startChallenge=$('startChallenge');
  const topChallenge=$('topChallenge'), progressText=$('progressText'), ansSelect=$('ansSelect'), submitAns=$('submitAns'), cancelChallenge=$('cancelChallenge'), scoreEl=$('score');
  const overlay=$('overlay');

  // ====== Helpers ======
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const calcAns=()=> state.op==='add' ? state.a+state.b : state.a-state.b;
  const calcLabel=()=> state.op==='add' ? '„Å§„Åé„ÅÆ „Åã„ÅöÔºà„Åü„ÅôÔºâ' : '„Å®„Çã „Åã„ÅöÔºà„Å≤„ÅèÔºâ';
  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
  function makeBlock(classes=[]){ const d=document.createElement('div'); d.className='block'; classes.forEach(c=>d.classList.add(c)); return d; }
  function onesColorBlocks(n){
    const map={1:['b-red'],2:Array(2).fill('b-orange'),3:Array(3).fill('b-yellow'),4:Array(4).fill('b-green'),
      5:Array(5).fill('b-sky'),6:Array(6).fill('b-purple'),7:['b-red','b-orange','b-yellow','b-green','b-sky','b-purple','b-lavender'],
      8:Array(8).fill('b-deeppink'),9:['b-gray-light','b-gray-light','b-gray-light','b-gray','b-gray','b-gray','b-gray-dark','b-gray-dark','b-gray-dark']};
    return map[n] || [];
  }
  function buildBlocks(container, n){
    clear(container); let r=n;
    while(r>=20){ for(let i=0;i<20;i++) container.appendChild(makeBlock(['b-twenty'])); r-=20; }
    if(r>=10){ for(let i=0;i<10;i++) container.appendChild(makeBlock(['b-ten'])); r-=10; }
    if(r>0){ onesColorBlocks(r).forEach(cls=> container.appendChild(makeBlock([cls])) ); }
  }
  function getBlockClassesForNumber(n){ const tmp=document.createElement('div'); buildBlocks(tmp,n); return Array.from(tmp.children).map(el=>Array.from(el.classList)); }
  function fillSelect(sel, min=0, max=40, def=0){ sel.innerHTML=''; for(let i=min;i<=max;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o);} sel.value=def; }

  function syncEquation(){ numA.textContent=state.a; numB.textContent=state.b; opText.textContent=state.op==='add'?'Ôºã':'‚àí';
    numAns.textContent=(state.cRunning && !state.cAnswered)?'Ôºü':calcAns(); middleTitle.textContent=calcLabel(); }
  function renderStage(){ syncEquation(); buildBlocks(groupA,state.a); buildBlocks(groupB,state.b); clear(groupAns); }

  const wait = (ms)=> new Promise(res=>setTimeout(res,ms));

  function getContainerMetrics(container){
    const cs=getComputedStyle(container);
    let gap=parseFloat((cs.columnGap || cs.gap || '8')); if(Number.isNaN(gap)) gap=8; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    const padL=parseFloat(cs.paddingLeft||'0'), padR=parseFloat(cs.paddingRight||'0');
    const innerW=container.clientWidth - padL - padR;
    return {padL,gap,innerW};
  }
  function calcNextAppendSlot(container){
    const rect=container.getBoundingClientRect(); const {padL,gap,innerW}=getContainerMetrics(container); const last=container.lastElementChild;
    if(!last) return {x:rect.left + padL, y:rect.top + 6};
    const lr=last.getBoundingClientRect(); const w=last.offsetWidth, h=last.offsetHeight;
    const nextLeft=last.offsetLeft + w + gap; const willWrap=(nextLeft + w) > innerW + 0.5;
    return willWrap ? {x:rect.left + padL, y:lr.top + h + gap} : {x:lr.right + gap, y:lr.top};
  }
  async function transferBlockToContainer(src, target, x, y, place='append'){
    const s=src.getBoundingClientRect(); const clone=src.cloneNode(true);
    clone.style.position='fixed'; clone.style.left=s.left+'px'; clone.style.top=s.top+'px'; clone.style.zIndex=9999;
    clone.style.transition='transform 420ms ease-in-out, opacity 200ms ease-in-out'; document.body.appendChild(clone);
    src.remove(); requestAnimationFrame(()=>{ clone.style.transform=`translate(${x - s.left}px, ${y - s.top}px) scale(0.96)`; });
    await wait(420); const real=src.cloneNode(true); real.classList.add('bounce-in'); place==='append'? target.appendChild(real):target.prepend(real);
    clone.style.opacity='0'; await wait(150); clone.remove(); return real;
  }
  function calcSubTargetOnRightmost(){ const last=groupAns.lastElementChild;
    if(!last){ const r=groupAns.getBoundingClientRect(); return {x:r.right-30, y:r.top+6}; }
    const lr=last.getBoundingClientRect(); return {x:lr.left+lr.width/2-20, y:lr.top+lr.height/2-20}; }
  function showDottedRectForBlock(block, ms=220){
    const r=block.getBoundingClientRect(), cs=getComputedStyle(block);
    let color=cs.borderColor, bw=parseFloat(cs.borderWidth||'0'); if(!color||color==='rgba(0, 0, 0, 0)'||bw<1){ color=cs.backgroundColor||'#000'; }
    const dash=document.createElement('div'); Object.assign(dash.style,{position:'fixed',left:r.left+'px',top:r.top+'px',width:r.width+'px',height:r.height+'px',
      border:`4px dashed ${color}`, borderRadius:getComputedStyle(block).borderRadius, zIndex:1002, opacity:'0', transition:'opacity 120ms ease-out' });
    document.body.appendChild(dash); requestAnimationFrame(()=> dash.style.opacity='1'); setTimeout(()=>{ dash.style.opacity='0'; setTimeout(()=> dash.remove(),120); }, ms);
  }

  async function animateAdd_Learn(A,B){
    clear(groupAns);
    for(const src of Array.from(groupA.children)){ const p=calcNextAppendSlot(groupAns); await transferBlockToContainer(src,groupAns,p.x,p.y,'append'); await wait(40); }
    for(const src of Array.from(groupB.children)){ const p=calcNextAppendSlot(groupAns); await transferBlockToContainer(src,groupAns,p.x,p.y,'append'); await wait(40); }
    await wait(160); buildBlocks(groupAns, A+B); await wait(500); buildBlocks(groupA,A); buildBlocks(groupB,B);
  }
  async function animateMoveAllAtoAnswerOnce(A){
    const aClasses=getBlockClassesForNumber(A); const blocks=Array.from(groupA.children); const r=groupAns.getBoundingClientRect(), cs=getComputedStyle(groupAns);
    let gap=parseFloat((cs.columnGap||cs.gap||'8')); if(Number.isNaN(gap)) gap=8; const w=(blocks[0]?.offsetWidth||42);
    const cols=Math.max(1, Math.floor((groupAns.clientWidth - parseFloat(cs.paddingLeft||'0') - parseFloat(cs.paddingRight||'0')) / (w + gap)));
    await Promise.all(blocks.map((src,i)=>{ const c=i%cols, row=Math.floor(i/cols); const x=r.left + parseFloat(cs.paddingLeft||'0') + c*(w+gap); const y=r.top + 6 + row*(w+gap);
      return transferBlockToContainer(src,groupAns,x,y,'append'); }));
    clear(groupAns); aClasses.forEach(cls=> groupAns.appendChild(makeBlock(cls)));
  }
  async function animateSub_Learn(A,B){
    await animateMoveAllAtoAnswerOnce(A);
    const blocks=Array.from(groupB.children), take=Math.min(B,blocks.length);
    for(let i=0;i<take;i++){
      const src=blocks[i], s=src.getBoundingClientRect(), clone=src.cloneNode(true);
      Object.assign(clone.style,{position:'fixed', left:s.left+'px', top:s.top+'px', zIndex:9999, transition:'transform 420ms ease-in-out, opacity 240ms ease-in-out'}); document.body.appendChild(clone);
      src.remove(); const p=calcSubTargetOnRightmost(); requestAnimationFrame(()=>{ clone.style.transform=`translate(${p.x - s.left}px, ${p.y - s.top}px) scale(0.96)`; });
      await wait(420); const last=groupAns.lastElementChild; if(last){ showDottedRectForBlock(last,220);
        last.style.transition='transform 240ms ease-in, opacity 240ms ease-in'; last.style.transform='scale(0.7)'; last.style.opacity='0';
        clone.style.transform='scale(0.7)'; clone.style.opacity='0'; await wait(240); last.remove(); }
      clone.remove(); await wait(40);
    }
    await wait(120); const remain=Math.max(0,A-B); buildBlocks(groupAns,remain); buildBlocks(groupA,A); buildBlocks(groupB,B);
  }

  function showMark(type){ overlay.innerHTML=''; const m=document.createElement('div'); m.className='mark '+(type==='ok'?'correct':'wrong')+' show'; overlay.appendChild(m); setTimeout(()=> overlay.innerHTML='', 1200); }
  let audioCtx=null; function beep(f=440,d=0.2,t='sine',v=0.22){ audioCtx=audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=t; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), d*1000); }
  function successSound(){ beep(523,0.12); setTimeout(()=>beep(659,0.12),130); setTimeout(()=>beep(784,0.18),260); }
  function failSound(){ beep(220,0.22,'sawtooth'); setTimeout(()=>beep(180,0.22,'sawtooth'),220); }

  function bigConfetti(){ const colors=['#ff4d4f','#ff8c00','#ffd54a','#42c58a','#4aa3ff','#9c27b0','#ff1493','#00c2ff','#00e676'];
    const W=innerWidth,H=innerHeight,total=Math.min(480, Math.floor(W*H/4500)+260);
    for(let i=0;i<total;i++){ const c=document.createElement('div'); c.className='confetti fly'; const center=Math.random()<0.5;
      const x0=center?W/2:Math.random()*W, spreadX=center?(Math.random()*800-400):(Math.random()*1000-500), spreadY=-(Math.random()*H*0.95+150);
      c.style.setProperty('--x0', x0+'px'); c.style.setProperty('--y0', '0px'); c.style.setProperty('--x1', (x0+spreadX)+'px'); c.style.setProperty('--y1', (spreadY)+'px');
      c.style.setProperty('--rot', (Math.random()*900-450)+'deg'); c.style.left='0'; c.style.bottom='0'; c.style.background=colors[i%colors.length];
      document.body.appendChild(c); setTimeout(()=>c.remove(),1500); }
  }
  const stamps=['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçí','üçë','ü•≠','üçç','ü•ù','üçÖ','ü••','üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ'];
  function showReward(){ overlay.innerHTML=''; const wrap=document.createElement('div'); wrap.className='reward';
    const box=document.createElement('div'); box.className='box'; const stamp=document.createElement('div'); stamp.className='stamp'; stamp.textContent=stamps[Math.floor(Math.random()*stamps.length)];
    const stack=document.createElement('div'); stack.className='btn-stack'; const btn=document.createElement('button'); btn.className='big primary'; btn.textContent='„ÇÑ„Å£„Åü„Å≠ÔºÅ';
    btn.addEventListener('click', ()=> overlay.innerHTML='' ); stack.appendChild(btn); box.appendChild(stamp); box.appendChild(stack); wrap.appendChild(box); overlay.appendChild(wrap); }

  // ====== Â≠¶„Å∂„É¢„Éº„ÉâÊìç‰Ωú ======
  function setOpAdd(){ state.op='add'; opAdd.classList.add('active'); opSub.classList.remove('active'); middleTitle.textContent='„Å§„Åé„ÅÆ „Åã„ÅöÔºà„Åü„ÅôÔºâ'; syncEquation(); renderStage(); }
  function setOpSub(){ state.op='sub'; opSub.classList.add('active'); opAdd.classList.remove('active'); middleTitle.textContent='„Å®„Çã „Åã„ÅöÔºà„Å≤„ÅèÔºâ'; if(state.b>state.a){ state.b=state.a; bSelect.value=state.b; } syncEquation(); renderStage(); }
  function setA(v){ state.a=clamp(+v,0,state.max); if(state.op==='sub' && state.b>state.a){ state.b=state.a; bSelect.value=state.b; } renderStage(); }
  function setB(v){ state.b=clamp(+v,0,state.max); if(state.op==='sub' && state.b>state.a){ state.b=state.a; bSelect.value=state.b; } renderStage(); }
  opAdd.addEventListener('click', setOpAdd); opSub.addEventListener('click', setOpSub);
  aSelect.addEventListener('change', e=> setA(e.target.value)); bSelect.addEventListener('change', e=> setB(e.target.value));
  playBtn.addEventListener('click', async ()=>{ playBtn.disabled=true; if(state.op==='add'){ await animateAdd_Learn(state.a,state.b); } else { await animateSub_Learn(state.a,state.b); } playBtn.disabled=false; });

  // ====== „ÉÅ„É£„É¨„É≥„Ç∏ ======
  function setType(t){ state.cType=t; typeAdd.classList.toggle('active',t==='add'); typeSub.classList.toggle('active',t==='sub'); typeBoth.classList.toggle('active',t==='both'); }
  function setDiff(d){ state.cDiff=d; diffEasy.classList.toggle('active',d==='easy'); diffNormal.classList.toggle('active',d==='normal'); diffHard.classList.toggle('active',d==='hard'); }
  typeAdd.addEventListener('click',()=>setType('add')); typeSub.addEventListener('click',()=>setType('sub')); typeBoth.addEventListener('click',()=>setType('both'));
  diffEasy.addEventListener('click',()=>setDiff('easy')); diffNormal.addEventListener('click',()=>setDiff('normal')); diffHard.addEventListener('click',()=>setDiff('hard'));
  function ranges(){ if(state.cDiff==='easy') return {A:[1,5], B:[0,5]}; if(state.cDiff==='normal') return {A:[1,10], B:[0,5]}; return {A:[1,10], B:[0,10]}; }
  const randInt=(min,max)=> Math.floor(Math.random()*(max-min+1))+min;
  function keyFor(a,b,op){ return op==='add' ? `add:${Math.min(a,b)},${Math.max(a,b)}` : `sub:${a},${b}`; }
  function pickOp(){ return state.cType==='add'?'add': state.cType==='sub'?'sub' : (Math.random()<0.5?'add':'sub'); }
  function prepareAnsSelect(){ fillSelect(ansSelect,0,state.max,0); }
  function makeUniqueQuestion(){
    const {A:[aMin,aMax], B:[bMin,bMax]}=ranges(); const maxTry=200;
    for(let i=0;i<maxTry;i++){ let a=randInt(aMin,aMax), b=randInt(bMin,bMax), op=pickOp(); if(op==='sub' && b>a){ [a,b]=[b,a]; if(a===0)a=1; }
      const k=state.cType==='both' ? `${op}:${a},${b}` : keyFor(a,b,op); if(!state.cSeen.has(k)){ state.cSeen.add(k); state.cQ={a,b,op,answer: op==='add'?a+b:a-b}; return true; } }
    return false;
  }
  function renderQuestion(){ const {a,b,op}=state.cQ; Object.assign(state,{a,b,op,cAnswered:false}); syncEquation(); buildBlocks(groupA,a); buildBlocks(groupB,b); clear(groupAns);
    progressText.textContent=`${state.cIdx+1} / ${state.cLen}`; ansSelect.value=0; submitAns.disabled=false; }
  function renderScore(){ scoreEl.textContent='‚òÖ'.repeat(state.cScore); }
  function startChallengeRound(){ Object.assign(state,{cRunning:true,cIdx:0,cScore:0,cSeen:new Set(),cAnswered:false}); renderScore();
    topLearnCard.style.display='none'; topChallenge.style.display='block'; prepareAnsSelect(); makeUniqueQuestion(); renderQuestion(); }
  function stopChallenge(){ state.cRunning=false; topChallenge.style.display='none'; topLearnCard.style.display='block'; renderStage(); }
  async function animateForChallengeThenNext(ok){ if(!ok) return; if(state.cQ.op==='add'){ await animateAdd_Learn(state.cQ.a,state.cQ.b); } else { await animateSub_Learn(state.cQ.a,state.cQ.b); } await wait(3000); nextQuestionOrFinish(); }
  function nextQuestionOrFinish(){ if(state.cIdx<state.cLen-1){ state.cIdx++; makeUniqueQuestion(); renderQuestion(); } else { showReward(); state.cRunning=false; topChallenge.style.display='none'; topLearnCard.style.display='block'; renderStage(); } }

  startChallenge.addEventListener('click', startChallengeRound);
  cancelChallenge.addEventListener('click', stopChallenge);
  submitAns.addEventListener('click', async ()=>{
    const val=clamp(+ansSelect.value||0,0,state.max), ok=val===state.cQ.answer;
    if(ok){ state.cAnswered=true; numAns.textContent=val; showMark('ok'); bigConfetti(); successSound(); state.cScore=clamp(state.cScore+1,0,state.cLen); renderScore(); submitAns.disabled=true; await animateForChallengeThenNext(true); }
    else{ showMark('ng'); failSound(); }
  });

  function init(){
    fillSelect(aSelect,0,state.max,3); fillSelect(bSelect,0,state.max,2); prepareAnsSelect();
    setOpAdd(); setType('add'); setDiff('easy'); renderStage();
    document.body.addEventListener('pointerdown', ()=>{ window._ac = window._ac || new (window.AudioContext||window.webkitAudioContext)(); }, {once:true});

    // ‚úÖ SWÁôªÈå≤ÔºàÈÖç‰∏ãÂÖ¨Èñã„Å´ÂØæÂøúÔºâ„ÄÇÂ§±Êïó„Åó„Å¶„ÇÇ„Ç¢„Éó„É™Á∂ôÁ∂ö„ÄÇ
    try{
      if('serviceWorker' in navigator){
        const basePath = location.pathname.replace(/[^/]*$/, ''); // '/kids-math-app/'
        navigator.serviceWorker.register(`${basePath}sw.js`, { scope: basePath })
          .catch(err => console.error('SW register failed:', err));
      }
    }catch(e){ console.error('SW init error:', e); }
  }
  init();
})();
</script>
</body>
</html>
