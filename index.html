<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<!-- iOS / iPadOS æœ€é©åŒ– -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#0b2340">
manifest.webmanifest
apple-touch-icon.png
<title>ã¿ã‚“ãªã®ã•ã‚“ã™ã† - ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“</title>
<style>
  :root{
    --bg:#f7fafc; --ink:#223; --muted:#667; --card:#fff; --border:#e6e9ef; --shadow:0 4px 16px rgba(0,0,0,0.08);
    --focus:#3b82f6; --radius:16px; --radius-sm:12px;

    /* one-digit palette */
    --red:#e53935; --orange:#ff8c00; --yellow:#ffd54a; --green:#42c58a;
    --sky:#4aa3ff; --purple:#9c27b0; --lavender:#c8a2c8; --deeppink:#ff1493;
    --gray-light:#d9d9d9; --gray:#9e9e9e; --gray-dark:#616161;

    /* tens / twenties */
    --ten-border:#e53935;
    --twenty-border:#ff9800; --twenty-bg:#fffaf0;

    /* effects */
    --ok:#e53935; /* red circle */
    --ng:#1e88e5; /* blue cross */
  }
  *{box-sizing:border-box}
  html,body{
    background:var(--bg);
    color:var(--ink);
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Yu Gothic","Meiryo",sans-serif;
    /* iOSã‚¿ãƒƒãƒæœ€é©åŒ– */
    -webkit-tap-highlight-color: transparent;
    -webkit-text-size-adjust: 100%;
  }
  /* iOSã®å®‰å…¨é ˜åŸŸï¼ˆãƒãƒƒãƒï¼‰è€ƒæ…® */
  body{ margin:0; padding-bottom: env(safe-area-inset-bottom); min-height:100vh; }
  @supports (min-height: 100svh){
    body{ min-height:100svh; } /* iOS16+ã®å‹•çš„ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ */
  }

  header{
    position:sticky; top:0; z-index:50; background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center;
    padding: calc(12px + env(safe-area-inset-top)) 16px 12px 16px; /* ä¸Šéƒ¨å®‰å…¨é ˜åŸŸ */
  }
  header h1{margin:0; font-size:1.2rem}

  .shell{max-width:980px; margin:0 auto; padding:10px 16px}

  /* Top controls (two rows) */
  .controls{position:sticky; top:calc(56px + env(safe-area-inset-top)); z-index:40; background:var(--bg); border-bottom:1px solid var(--border);}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:10px 0}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:10px}

  .row1{font-size:1.12rem}
  .row2{font-size:0.98rem}

  .label{font-weight:700}
  .label-inline{display:flex; align-items:center; gap:8px}

  button{appearance:none; border:none; border-radius:14px; padding:12px 16px; font-size:1.05rem; background:#fff; border:1px solid var(--border); box-shadow:var(--shadow); color:var(--ink)}
  button.primary{background:var(--focus); color:#fff; border-color:transparent}
  button.mute{background:#f2f4f8}
  button.big{font-size:1.15rem}
  button:active{transform:scale(0.98)}
  button:focus{outline:none}

  .seg{display:flex; background:#f2f4f8; border-radius:14px; overflow:hidden; border:1px solid var(--border)}
  .seg-btn{appearance:none; border:none; padding:10px 12px; font-weight:700; background:transparent}
  .seg-btn.active{background:#fff; color:var(--focus)}

  /* selects (iOSã¯å®Ÿã‚µã‚¤ã‚ºã‚’ç¢ºä¿) */
  select{appearance:none; padding:12px 14px; border-radius:12px; border:2px solid var(--border); background:#fff;}
  .big-select{font-size:1.35rem; min-width:132px}
  .small-select{font-size:1.05rem; min-width:120px}

  /* Stage */
  .stage{padding-top:10px}
  .equation{display:flex; align-items:center; justify-content:center; gap:12px; font-size:1.8rem; padding:10px; flex-wrap:wrap}
  .num-display{min-width:74px; min-height:74px; display:flex; align-items:center; justify-content:center; background:white; border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); font-weight:800}
  .op,.equals{min-width:40px; text-align:center}

  /* Vertical animation layout */
  .area{display:flex; flex-direction:column; gap:16px; padding:10px 0 24px 0}
  .group{width:100%; background:#fff; border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px}
  .group h3{margin:0 0 6px 0; font-size:0.98rem; color:var(--muted)}
  .blocks{
    display:flex; flex-wrap:wrap; gap:8px; min-height:60px; padding:6px;
    touch-action: manipulation; /* iOSã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§æŠ‘åˆ¶ */
  }

  /* blocks: all squares */
  .block{width:42px; height:42px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1)}
  /* ones color */
  .b-red{background:var(--red)}
  .b-orange{background:var(--orange)}
  .b-yellow{background:var(--yellow)}
  .b-green{background:var(--green)}
  .b-sky{background:var(--sky)}
  .b-purple{background:var(--purple)}
  .b-lavender{background:var(--lavender)}
  .b-deeppink{background:var(--deeppink)}
  .b-gray-light{background:var(--gray-light)}
  .b-gray{background:var(--gray)}
  .b-gray-dark{background:var(--gray-dark)}
  /* groups */
  .b-ten{background:#fff; border:6px solid var(--ten-border)}
  .b-twenty{background:var(--twenty-bg); border:6px solid var(--twenty-border)}

  /* animations */
  .bounce-in{animation:bounceIn 360ms ease-out}
  @keyframes bounceIn{0%{transform:scale(0.6); opacity:0}60%{transform:scale(1.06); opacity:1}100%{transform:scale(1)}}

  /* overlay: marks & confetti & reward */
  .overlay{position:fixed; inset:0; pointer-events:none; z-index:1000}
  .mark{position:absolute; left:50%; top:45%; transform:translate(-50%,-50%) scale(0.6); width:300px; height:300px; opacity:0}
  .mark.show{animation:markPop 700ms ease-out forwards}
  @keyframes markPop{0%{opacity:0; transform:translate(-50%,-50%) scale(0.6)}40%{opacity:1; transform:translate(-50%,-50%) scale(1.06)}100%{opacity:1; transform:translate(-50%,-50%) scale(1)}}
  .mark.correct{border:20px solid var(--ok); border-radius:50%; background:transparent}
  .mark.wrong::before, .mark.wrong::after{
    content:""; position:absolute; left:50%; top:50%; width:22px; height:320px; background:var(--ng); transform-origin:center;
  }
  .mark.wrong::before{transform:translate(-50%,-50%) rotate(45deg)}
  .mark.wrong::after{transform:translate(-50%,-50%) rotate(-45deg)}

  .confetti{position:fixed; bottom:-8px; width:9px; height:18px; opacity:0.95; border-radius:2px; z-index:1001}
  .confetti.fly{animation:confettiFly 1200ms ease-out forwards}
  @keyframes confettiFly{
    0%{transform:translate(var(--x0), var(--y0)) rotate(0deg); opacity:1}
    100%{transform:translate(var(--x1), var(--y1)) rotate(var(--rot)); opacity:0}
  }

  /* reward stamp */
  .reward{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25)}
  .reward .box{
    pointer-events:auto; background:#fff; border-radius:18px; padding:24px; border:4px solid #eee; text-align:center;
    box-shadow:0 18px 40px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:12px; align-items:center
  }
  .stamp{
    display:inline-flex; align-items:center; justify-content:center; width:220px; height:220px; border:10px solid #ff8c00;
    border-radius:18px; background:#fffaf0; font-size:7rem; box-shadow:inset 0 0 0 6px rgba(255,140,0,0.2)
  }
  .reward .btn-stack{display:flex; flex-direction:column; gap:10px; width:100%; align-items:center}
  .reward button{pointer-events:auto; min-width:180px}
</style>
</head>
<body>
<header>
  <h1>ã¿ã‚“ãªã®ã•ã‚“ã™ã†</h1>
  <div style="color:#667">ã¿ã¦ãƒ»ã•ã‚ã£ã¦å­¦ã¼ã†</div>
</header>

<div class="controls">
  <div class="shell">
    <div class="card" id="topLearnCard">
      <!-- 1æ®µç›® -->
      <div id="row1" class="row row1" aria-label="ä¸Šæ®µï¼ˆå­¦ã¶ï¼‰">
        <!-- ãŸã—ã–ã‚“ï¼ã²ãã–ã‚“ -->
        <div class="seg" aria-label="ãˆã‚‰ã¶">
          <button class="seg-btn active" id="opAdd">ãŸã—ã–ã‚“</button>
          <button class="seg-btn" id="opSub">ã²ãã–ã‚“</button>
        </div>

        <!-- ã¯ã˜ã‚ã®ã‹ãšï¼š ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
        <div class="label-inline">
          <span class="label">ã¯ã˜ã‚ã®ã‹ãšï¼š</span>
          <label class="sr-only" for="aSelect">ã¯ã˜ã‚ã®ã‹ãš</label>
          <select id="aSelect" class="big-select" aria-label="ã¯ã˜ã‚ã®ã‹ãš"></select>
        </div>

        <!-- ã¤ãã®ã‹ãšï¼š ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
        <div class="label-inline">
          <span class="label">ã¤ãã®ã‹ãšï¼š</span>
          <label class="sr-only" for="bSelect">ã¤ãã®ã‹ãš</label>
          <select id="bSelect" class="big-select" aria-label="ã¤ãã®ã‹ãš"></select>
        </div>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
        <button id="playBtn" class="primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>

      <!-- 2æ®µç›® -->
      <div id="row2" class="row row2" aria-label="ä¸‹æ®µï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨­å®šï¼‰">
        <!-- å‡ºé¡Œã‚¿ã‚¤ãƒ— -->
        <div class="seg" aria-label="å‡ºé¡Œã‚¿ã‚¤ãƒ—" id="typeSeg">
          <button class="seg-btn active" id="typeAdd">ãŸã—ã–ã‚“</button>
          <button class="seg-btn" id="typeSub">ã²ãã–ã‚“</button>
          <button class="seg-btn" id="typeBoth">ã‚Šã‚‡ã†ã»ã†</button>
        </div>

        <!-- é›£æ˜“åº¦ -->
        <div class="seg" aria-label="ã‚€ãšã‹ã—ã•" id="diffSeg">
          <button class="seg-btn active" id="diffEasy">ã‹ã‚“ãŸã‚“</button>
          <button class="seg-btn" id="diffNormal">ãµã¤ã†</button>
          <button class="seg-btn" id="diffHard">ã‚€ãšã‹ã—ã„</button>
        </div>

        <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹ -->
        <button id="startChallenge" class="big">ğŸ‘‘ ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
      </div>
    </div>

    <!-- ä¸Šéƒ¨å…¥åŠ›ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸å›ç­”ã®ã¿ï¼‰ -->
    <div id="topChallenge" class="card" style="display:none" aria-label="ä¸Šéƒ¨å…¥åŠ›ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸å›ç­”ï¼‰">
      <div class="row row1" style="justify-content:space-between">
        <div style="font-weight:700">ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼š<span id="progressText">1 / 5</span></div>
        <div id="score" style="font-size:1.1rem; color:#f5b301"></div>
      </div>
      <div class="row row2">
        <!-- ã“ãŸãˆï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰ -->
        <label class="sr-only" for="ansSelect">ã“ãŸãˆ</label>
        <select id="ansSelect" class="small-select" aria-label="ã“ãŸãˆ"></select>
        <button id="submitAns" class="primary">ã“ãŸãˆã‚’ ãã‚ã‚‹</button>
        <button id="cancelChallenge" class="mute">ã‚„ã‚ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<div class="shell stage">
  <!-- å…±æœ‰ã®å¼è¡¨ç¤ºï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸­ã¯ã“ãŸãˆã€Œï¼Ÿã€ï¼‰ -->
  <div class="equation">
    <div class="num-display" id="numA">3</div>
    <div class="op" id="opText">ï¼‹</div>
    <div class="num-display" id="numB">2</div>
    <div class="equals">ï¼</div>
    <div class="num-display" id="numAns">5</div>
  </div>

  <!-- ç¸¦é…ç½®ã®è¡¨ç¤ºé ˜åŸŸ -->
  <div class="area">
    <div class="group">
      <h3>ã¯ã˜ã‚ã® ã‹ãš</h3>
      <div class="blocks" id="groupA"></div>
    </div>
    <div class="group">
      <h3 id="middleTitle">ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰</h3>
      <div class="blocks" id="groupB"></div>
    </div>
    <div class="group">
      <h3>ã“ãŸãˆ</h3>
      <div class="blocks" id="groupAns"></div>
    </div>
  </div>
</div>

<!-- overlay for marks/confetti/reward -->
<div id="overlay" class="overlay" aria-hidden="true"></div>

<script>
(function(){
  // ====== State ======
  const state = {
    a:3, b:2, op:'add',
    max:40,
    // Challenge
    cRunning:false,
    cType:'add', // 'add' | 'sub' | 'both'
    cDiff:'easy', // 'easy'|'normal'|'hard'
    cLen:5, cIdx:0, cScore:0, cSeen:new Set(), cAnswered:false,
    cQ:{a:0,b:0,op:'add',answer:0}
  };

  // ====== Elements ======
  const numA = document.getElementById('numA');
  const numB = document.getElementById('numB');
  const numAns = document.getElementById('numAns');
  const opText = document.getElementById('opText');
  const middleTitle = document.getElementById('middleTitle');
  const groupA = document.getElementById('groupA');
  const groupB = document.getElementById('groupB');
  const groupAns = document.getElementById('groupAns');

  // top learn
  const topLearnCard = document.getElementById('topLearnCard');
  const opAdd  = document.getElementById('opAdd');
  const opSub  = document.getElementById('opSub');
  const aSelect = document.getElementById('aSelect');
  const bSelect = document.getElementById('bSelect');
  const playBtn = document.getElementById('playBtn');

  // challenge selectors (pre-start)
  const typeAdd = document.getElementById('typeAdd');
  const typeSub = document.getElementById('typeSub');
  const typeBoth = document.getElementById('typeBoth');
  const diffEasy = document.getElementById('diffEasy');
  const diffNormal = document.getElementById('diffNormal');
  const diffHard = document.getElementById('diffHard');
  const startChallenge = document.getElementById('startChallenge');

  // top challenge
  const topChallenge = document.getElementById('topChallenge');
  const progressText = document.getElementById('progressText');
  const ansSelect = document.getElementById('ansSelect');
  const submitAns = document.getElementById('submitAns');
  const cancelChallenge = document.getElementById('cancelChallenge');
  const scoreEl = document.getElementById('score');

  const overlay = document.getElementById('overlay');

  // ====== Helpers ======
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const calcAns = ()=> state.op==='add' ? state.a+state.b : state.a-state.b;
  const calcLabel = ()=> state.op==='add' ? 'ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰' : 'ã¨ã‚‹ ã‹ãšï¼ˆã²ãï¼‰';

  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
  function makeBlock(classList=[]){ const d=document.createElement('div'); d.className='block'; classList.forEach(c=>d.classList.add(c)); return d; }

  // one-digit colors mapping with ordered sequences
  function onesColorBlocks(n){
    const map = {
      1:['b-red'],
      2:Array(2).fill('b-orange'),
      3:Array(3).fill('b-yellow'),
      4:Array(4).fill('b-green'),
      5:Array(5).fill('b-sky'),
      6:Array(6).fill('b-purple'),
      7:['b-red','b-orange','b-yellow','b-green','b-sky','b-purple','b-lavender'],
      8:Array(8).fill('b-deeppink'),
      9:['b-gray-light','b-gray-light','b-gray-light','b-gray','b-gray','b-gray','b-gray-dark','b-gray-dark','b-gray-dark']
    };
    return map[n] || [];
  }

  // build blocks per N (20â†’10â†’ones)
  function buildBlocks(container, n){
    clear(container);
    let r=n;
    while(r>=20){ for(let i=0;i<20;i++) container.appendChild(makeBlock(['b-twenty'])); r-=20; }
    if(r>=10){ for(let i=0;i<10;i++) container.appendChild(makeBlock(['b-ten'])); r-=10; }
    if(r>0){ onesColorBlocks(r).forEach(cls=> container.appendChild(makeBlock([cls])) ); }
  }

  // snapshot classes for number coloring
  function getBlockClassesForNumber(n){
    const temp=document.createElement('div');
    buildBlocks(temp,n);
    return Array.from(temp.children).map(el=> Array.from(el.classList));
  }

  // populate selects 0..40
  function fillSelect(sel, min=0, max=40, def=0){
    sel.innerHTML='';
    for(let i=min;i<=max;i++){
      const o=document.createElement('option');
      o.value=i; o.textContent=i;
      sel.appendChild(o);
    }
    sel.value=def;
  }

  // ====== Equation / Displays ======
  function syncEquation(){
    numA.textContent=state.a; numB.textContent=state.b;
    opText.textContent = state.op==='add'?'ï¼‹':'âˆ’';
    if(state.cRunning && !state.cAnswered){
      numAns.textContent='ï¼Ÿ';
    }else{
      numAns.textContent=calcAns();
    }
    middleTitle.textContent = calcLabel();
  }

  function renderStage(){
    syncEquation();
    buildBlocks(groupA, state.a);
    buildBlocks(groupB, state.b);
    clear(groupAns);
  }

  // ====== Movement & Animation Utilities ======
  function wait(ms){ return new Promise(res=>setTimeout(res,ms)); }

  // ã‚³ãƒ³ãƒ†ãƒŠå†…å´ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  function getContainerMetrics(container){
    const cs = getComputedStyle(container);
    const padL = parseFloat(cs.paddingLeft || '0');
    const padR = parseFloat(cs.paddingRight || '0');
    const gap  = parseFloat((cs.columnGap || cs.gap || '8').toString());
    const innerW = container.clientWidth - padL - padR;
    return {padL, padR, gap, innerW};
  }

  // æ¬¡ã« append ã•ã‚Œã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã®è¦‹ãŸç›®ä¸Šã®ç€åœ°ç‚¹ï¼ˆå³éš£ or æŠ˜è¿”ã—å…ˆé ­ï¼‰
  function calcNextAppendSlot(container){
    const rect = container.getBoundingClientRect();
    const {padL, gap, innerW} = getContainerMetrics(container);
    const last = container.lastElementChild;

    if(!last){
      return { x: rect.left + padL, y: rect.top + 6, willWrap:false };
    }
    const lastRect = last.getBoundingClientRect();
    const blockW = last.offsetWidth;
    const blockH = last.offsetHeight;

    const nextLeftInRow = last.offsetLeft + blockW + gap;
    const willWrap = (nextLeftInRow + blockW) > innerW + 0.5;

    if(!willWrap){
      return { x: lastRect.right + gap, y: lastRect.top, willWrap:false };
    }else{
      return { x: rect.left + padL, y: lastRect.top + blockH + gap, willWrap:true };
    }
  }

  // ç§»å‹•å…ƒã‚’æ¶ˆã—ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ç›®æ¨™åº§æ¨™ã¸å‹•ã‹ã—ã€ãã®ä½ç½®ã«æœ¬ä½“ã‚’æ®ãˆã‚‹
  async function transferBlockToContainer(sourceBlock, targetContainer, targetX, targetY, place='append'){
    const sRect = sourceBlock.getBoundingClientRect();
    const clone = sourceBlock.cloneNode(true);
    clone.style.position='fixed';
    clone.style.left = (sRect.left)+'px';
    clone.style.top  = (sRect.top )+'px';
    clone.style.zIndex= 9999;
    clone.style.transition='transform 420ms ease-in-out, opacity 200ms ease-in-out';
    document.body.appendChild(clone);

    sourceBlock.remove(); // å·¦è©°ã‚ã«

    const dx = targetX - sRect.left;
    const dy = targetY - sRect.top;
    requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.96)`; });
    await wait(420);

    const real = sourceBlock.cloneNode(true);
    real.removeAttribute('style');
    real.classList.add('bounce-in');
    if(place==='append') targetContainer.appendChild(real);
    else targetContainer.prepend(real);

    clone.style.opacity='0';
    await wait(150);
    clone.remove();

    return real;
  }

  // å¼•ãç®—ï¼šå³ç«¯ãƒ–ãƒ­ãƒƒã‚¯ä¸Šã¸é‡ã­ã‚‹åº§æ¨™
  function calcSubTargetOnRightmost(){
    const last = groupAns.lastElementChild;
    if(!last){
      const aRect = groupAns.getBoundingClientRect();
      return {x:aRect.right-30, y:aRect.top+6};
    }
    const r = last.getBoundingClientRect();
    return {x: r.left + r.width/2 - 20, y: r.top + r.height/2 - 20};
  }

  // ç‚¹ç·šæ ï¼ˆæ¶ˆãˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã®è‰²ã§ä¸€ç¬è¡¨ç¤ºï¼‰
  function showDottedRectForBlock(block, ms=220){
    const rect = block.getBoundingClientRect();
    const cs = getComputedStyle(block);
    let color = cs.borderColor;
    const bw = parseFloat(cs.borderWidth||'0');
    if(!color || color==='rgba(0, 0, 0, 0)' || bw<1){
      color = cs.backgroundColor || '#000';
    }
    const dash = document.createElement('div');
    dash.style.position='fixed';
    dash.style.left = rect.left+'px';
    dash.style.top  = rect.top +'px';
    dash.style.width = rect.width+'px';
    dash.style.height= rect.height+'px';
    dash.style.border = `4px dashed ${color}`;
    dash.style.borderRadius = getComputedStyle(block).borderRadius;
    dash.style.zIndex = 1002;
    dash.style.opacity = '0';
    dash.style.transition = 'opacity 120ms ease-out';
    document.body.appendChild(dash);
    requestAnimationFrame(()=> dash.style.opacity='1');
    setTimeout(()=>{
      dash.style.opacity='0';
      setTimeout(()=> dash.remove(), 120);
    }, ms);
  }

  // ====== Animations ======
  // è¶³ã—ç®—ï¼šAâ†’B å·¦ã‹ã‚‰é †ã«ã€å¸¸ã«ç›´å‰ãƒ–ãƒ­ãƒƒã‚¯ã®å³éš£ï¼ˆæŠ˜è¿”ã—å«ã‚€ï¼‰ã¸ãƒ”ã‚¿ãƒªé…ç½®
  async function animateAdd_Learn(A, B){
    clear(groupAns);

    let aBlocks = Array.from(groupA.children);
    for(const src of aBlocks){
      const pos = calcNextAppendSlot(groupAns);
      await transferBlockToContainer(src, groupAns, pos.x, pos.y, 'append');
      await wait(40);
    }
    let bBlocks = Array.from(groupB.children);
    for(const src of bBlocks){
      const pos = calcNextAppendSlot(groupAns);
      await transferBlockToContainer(src, groupAns, pos.x, pos.y, 'append');
      await wait(40);
    }

    await wait(160);
    buildBlocks(groupAns, A+B);

    // A/B ã‚’å°‘ã—é…ã‚‰ã›ã¦å†è¡¨ç¤ºï¼ˆè¦–èªæ€§å‘ä¸Šï¼‰
    await wait(500);
    buildBlocks(groupA, A);
    buildBlocks(groupB, B);
  }

  // A å…¨æ•°ã‚’â€œä¸€åº¦ã«â€ã“ãŸãˆæ¬„ã¸ç§»å‹•ï¼ˆå…ƒè‰²ã®ã¾ã¾ï¼å…ƒã¯æ¶ˆå»ãƒ»å·¦è©°ã‚ï¼‰
  async function animateMoveAllAtoAnswerOnce(A){
    const aClasses = getBlockClassesForNumber(A);
    const aBlocks = Array.from(groupA.children);
    const aRect = groupAns.getBoundingClientRect();

    const cs = getComputedStyle(groupAns);
    const gap = parseFloat((cs.columnGap || cs.gap || '8').toString());
    const blockW = (aBlocks[0]?.offsetWidth || 42);
    const cols = Math.max(1, Math.floor((groupAns.clientWidth - parseFloat(cs.paddingLeft||'0') - parseFloat(cs.paddingRight||'0')) / (blockW + gap)));

    const promises = aBlocks.map((src, i)=>{
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = aRect.left + parseFloat(cs.paddingLeft||'0') + col*(blockW+gap);
      const y = aRect.top + 6 + row*(blockW+gap);
      return transferBlockToContainer(src, groupAns, x, y, 'append');
    });
    await Promise.all(promises);

    clear(groupAns);
    aClasses.forEach(cls => groupAns.appendChild(makeBlock(cls)));
  }

  // å¼•ãç®—ï¼šAä¸€æ‹¬ç§»å‹•â†’Bå·¦ã‹ã‚‰é †ã«å³ç«¯ã¸é‡ã­ã€ä¸¡æ–¹æ¶ˆå»ï¼ˆç‚¹ç·šæ ã‚’ä¸€ç¬è¡¨ç¤ºï¼‰
  async function animateSub_Learn(A, B){
    await animateMoveAllAtoAnswerOnce(A);

    const bBlocks = Array.from(groupB.children);
    const take = Math.min(B, bBlocks.length);
    for(let i=0;i<take;i++){
      const src = bBlocks[i];
      const sRect = src.getBoundingClientRect();
      const clone = src.cloneNode(true);
      clone.style.position='fixed';
      clone.style.left = (sRect.left)+'px';
      clone.style.top  = (sRect.top )+'px';
      clone.style.zIndex= 9999;
      clone.style.transition='transform 420ms ease-in-out, opacity 240ms ease-in-out';
      document.body.appendChild(clone);

      src.remove(); // å·¦è©°ã‚

      const targetPos = calcSubTargetOnRightmost();
      const dx = targetPos.x - sRect.left;
      const dy = targetPos.y - sRect.top;
      requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.96)`; });
      await wait(420);

      const last = groupAns.lastElementChild;
      if(last){
        showDottedRectForBlock(last, 220);
        last.style.transition='transform 240ms ease-in, opacity 240ms ease-in';
        last.style.transform='scale(0.7)'; last.style.opacity='0';
        clone.style.transform='scale(0.7)'; clone.style.opacity='0';
        await wait(240);
        last.remove();
      }
      clone.remove();
      await wait(40);
    }

    await wait(120);
    const remain = Math.max(0, A-B);
    buildBlocks(groupAns, remain);

    buildBlocks(groupA, A);
    buildBlocks(groupB, B);
  }

  // ====== Effects (ã€‡âœ• / Confetti / Sounds / Reward) ======
  const overlay = document.getElementById('overlay');
  function showMark(type){ // 'ok'|'ng'
    overlay.innerHTML='';
    const mark=document.createElement('div');
    mark.className='mark ' + (type==='ok' ? 'correct' : 'wrong') + ' show';
    overlay.appendChild(mark);
    setTimeout(()=>{ overlay.innerHTML=''; }, 1200);
  }

  let audioCtx=null;
  function beep(freq=440, dur=0.2, type='sine', vol=0.22){
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); setTimeout(()=>osc.stop(), dur*1000);
  }
  function successSound(){ beep(523,0.12,'sine',0.2); setTimeout(()=>beep(659,0.12,'sine',0.2),130); setTimeout(()=>beep(784,0.18,'sine',0.2),260); }
  function failSound(){ beep(220,0.22,'sawtooth',0.2); setTimeout(()=>beep(180,0.22,'sawtooth',0.2),220); }

  function bigConfetti(){
    const colors=['#ff4d4f','#ff8c00','#ffd54a','#42c58a','#4aa3ff','#9c27b0','#ff1493','#00c2ff','#00e676'];
    const W=window.innerWidth, H=window.innerHeight;
    const total = Math.min(480, Math.floor(W*H/4500)+260);
    for(let i=0;i<total;i++){
      const c=document.createElement('div');
      c.className='confetti fly';
      const center = Math.random()<0.5;
      const x0 = center ? W/2 : Math.random()*W;
      const y0 = H - 6;
      const spreadX = center ? (Math.random()*800-400) : (Math.random()*1000-500);
      const spreadY = -(Math.random()*H*0.95 + 150);
      const rot = (Math.random()*900-450)+'deg';
      c.style.setProperty('--x0', x0+'px');
      c.style.setProperty('--y0', '0px');
      c.style.setProperty('--x1', (x0+spreadX)+'px');
      c.style.setProperty('--y1', (spreadY)+'px');
      c.style.setProperty('--rot', rot);
      c.style.left='0'; c.style.bottom='0';
      c.style.background = colors[i%colors.length];
      document.body.appendChild(c);
      setTimeout(()=>c.remove(), 1500);
    }
  }

  const stamps = [
    'ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥','ğŸ…','ğŸ¥¥',
    'ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ'
  ];
  function showReward(){
    overlay.innerHTML='';
    const wrap=document.createElement('div');
    wrap.className='reward';
    const box=document.createElement('div');
    box.className='box';
    const stamp=document.createElement('div');
    stamp.className='stamp';
    stamp.textContent = stamps[Math.floor(Math.random()*stamps.length)];

    const btnStack=document.createElement('div');
    btnStack.className='btn-stack';
    const btn=document.createElement('button');
    btn.className='big primary';
    btn.textContent='ã‚„ã£ãŸã­ï¼';
    btn.addEventListener('click', ()=>{ overlay.innerHTML=''; });

    btnStack.appendChild(btn); /* ã‚¹ã‚¿ãƒ³ãƒ—ç›´ä¸‹ãƒ»ç¸¦ä¸¦ã³ */
    box.appendChild(stamp);
    box.appendChild(btnStack);
    wrap.appendChild(box);
    overlay.appendChild(wrap);
  }

  // ====== Learn Controls ======
  function setOpAdd(){ state.op='add'; opAdd.classList.add('active'); opSub.classList.remove('active'); middleTitle.textContent='ã¤ãã® ã‹ãšï¼ˆãŸã™ï¼‰'; syncEquation(); renderStage(); }
  function setOpSub(){ state.op='sub'; opSub.classList.add('active'); opAdd.classList.remove('active'); middleTitle.textContent='ã¨ã‚‹ ã‹ãšï¼ˆã²ãï¼‰'; if(state.b>state.a) {state.b=state.a; bSelect.value=state.b;} syncEquation(); renderStage(); }

  function setA(v){ state.a=clamp(Number(v),0,state.max); if(state.op==='sub' && state.b>state.a){ state.b=state.a; bSelect.value=state.b; } renderStage(); }
  function setB(v){ state.b=clamp(Number(v),0,state.max); if(state.op==='sub' && state.b>state.a){ state.b=state.a; bSelect.value=state.b; } renderStage(); }

  opAdd.addEventListener('click', setOpAdd);
  opSub.addEventListener('click', setOpSub);
  aSelect.addEventListener('change', (e)=> setA(e.target.value));
  bSelect.addEventListener('change', (e)=> setB(e.target.value));

  playBtn.addEventListener('click', async ()=>{
    playBtn.disabled=true;
    if(state.op==='add'){ await animateAdd_Learn(state.a, state.b); }
    else{ await animateSub_Learn(state.a, state.b); }
    playBtn.disabled=false;
  });

  // ====== Challenge setup (pre-start selectors) ======
  function setType(t){
    state.cType=t;
    typeAdd.classList.toggle('active',t==='add');
    typeSub.classList.toggle('active',t==='sub');
    typeBoth.classList.toggle('active',t==='both');
  }
  function setDiff(d){
    state.cDiff=d;
    diffEasy.classList.toggle('active',d==='easy');
    diffNormal.classList.toggle('active',d==='normal');
    diffHard.classList.toggle('active',d==='hard');
  }
  typeAdd.addEventListener('click',()=>setType('add'));
  typeSub.addEventListener('click',()=>setType('sub'));
  typeBoth.addEventListener('click',()=>setType('both'));
  diffEasy.addEventListener('click',()=>setDiff('easy'));
  diffNormal.addEventListener('click',()=>setDiff('normal'));
  diffHard.addEventListener('click',()=>setDiff('hard'));

  // ranges
  function ranges(){
    if(state.cDiff==='easy') return {A:[1,5], B:[0,5]};
    if(state.cDiff==='normal') return {A:[1,10], B:[0,5]};
    return {A:[1,10], B:[0,10]};
  }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function keyFor(a,b,op){
    if(op==='add'){
      const x=Math.min(a,b), y=Math.max(a,b);
      return `add:${x},${y}`;
    }else{
      return `sub:${a},${b}`;
    }
  }

  function pickOp(){
    if(state.cType==='add') return 'add';
    if(state.cType==='sub') return 'sub';
    return Math.random()<0.5?'add':'sub';
  }

  // populate answer select 0..40
  function prepareAnsSelect(){ fillSelect(ansSelect,0,state.max,0); }

  function makeUniqueQuestion(){
    const {A:[aMin,aMax], B:[bMin,bMax]} = ranges();
    const maxTry = 200;
    for(let i=0;i<maxTry;i++){
      let a=randInt(aMin,aMax);
      let b=randInt(bMin,bMax);
      const op = pickOp();
      if(op==='sub' && b>a){ [a,b]=[b,a]; if(a===0)a=1; } // avoid negative
      const k = state.cType==='both' ? `${op}:${a},${b}` : keyFor(a,b,op);
      if(!state.cSeen.has(k)){
        state.cSeen.add(k);
        const ans = op==='add' ? a+b : a-b;
        state.cQ={a,b,op,answer:ans};
        return true;
      }
    }
    return false;
  }

  function renderQuestion(){
    const {a,b,op} = state.cQ;
    state.a=a; state.b=b; state.op=op;
    state.cAnswered=false;
    syncEquation();           // ã“ãŸãˆã¯ã€Œï¼Ÿã€è¡¨ç¤º
    buildBlocks(groupA, a);
    buildBlocks(groupB, b);
    clear(groupAns);
    progressText.textContent = `${state.cIdx+1} / ${state.cLen}`;
    ansSelect.value = 0;
    submitAns.disabled=false;
  }

  function renderScore(){ scoreEl.textContent = 'â˜…'.repeat(state.cScore); }

  function startChallengeRound(){
    state.cRunning=true;
    state.cIdx=0; state.cScore=0; state.cSeen.clear(); state.cAnswered=false;
    renderScore();
    topLearnCard.style.display='none';
    topChallenge.style.display='block';
    prepareAnsSelect();
    makeUniqueQuestion();
    renderQuestion();
  }

  function stopChallenge(){
    state.cRunning=false;
    topChallenge.style.display='none';
    topLearnCard.style.display='block';
    renderStage();
  }

  async function animateForChallengeThenNext(ok){
    if(!ok) return;
    if(state.cQ.op==='add'){ await animateAdd_Learn(state.cQ.a, state.cQ.b); }
    else{ await animateSub_Learn(state.cQ.a, state.cQ.b); }
    await wait(3000);
    nextQuestionOrFinish();
  }

  function nextQuestionOrFinish(){
    if(state.cIdx < state.cLen-1){
      state.cIdx++;
      makeUniqueQuestion();
      renderQuestion();
    }else{
      showReward();
      state.cRunning=false;
      topChallenge.style.display='none';
      topLearnCard.style.display='block';
      renderStage();
    }
  }

  // ====== Challenge control events ======
  startChallenge.addEventListener('click', startChallengeRound);
  cancelChallenge.addEventListener('click', stopChallenge);

  submitAns.addEventListener('click', async ()=>{
    const val = clamp(Number(ansSelect.value||'0'),0,state.max);
    const ok = val===state.cQ.answer;
    if(ok){
      state.cAnswered=true;
      numAns.textContent = val; // å¼ã®ç­”ãˆã‚‚åæ˜ 
      showMark('ok');
      bigConfetti();
      successSound();
      state.cScore = clamp(state.cScore+1,0,state.cLen);
      renderScore();
      submitAns.disabled=true; // æ­£è§£å¾Œã¯è‡ªå‹•ã§æ¬¡ã¸
      await animateForChallengeThenNext(true);
    }else{
      showMark('ng');
      failSound();
      // ä¸æ­£è§£æ™‚ï¼šå†å…¥åŠ›ç¶™ç¶šå¯
    }
  });

  // ====== Init ======
  function init(){
    // fill selects
    fillSelect(aSelect,0,state.max,3);
    fillSelect(bSelect,0,state.max,2);
    prepareAnsSelect();
    // defaults
    setOpAdd(); setType('add'); setDiff('easy');
    renderStage();

    // iOS/WebAudio åˆå›ã‚¿ãƒƒãƒ—ã§æœ‰åŠ¹åŒ–ï¼ˆPWAã§ã‚‚å‹•ä½œï¼‰
    document.body.addEventListener('pointerdown', ()=>{ 
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); 
    }, {once:true});

    // PWA: Service Workerç™»éŒ²
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js', {scope: './'})
        .catch(console.error);
    }
  }
  init();
})();
</script>
</body>
</html>
