<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã¯ã˜ã‚ã¦ã® ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ10Ã—1ï¼‰</title>

<!-- PWAï¼ˆç¾çŠ¶ï¼šå˜ä¸€HTMLã€‚manifest/SWã¯ä»»æ„ï¼‰ -->
<link-touch-icon.png
manifest.webmanifest

<style>
:root{
  /* å‹•çš„ã« JS ã§è¨ˆç®—ã—ã¦æ›´æ–°ï¼šå¿…ãšæ¨ª10åˆ—ãŒåã¾ã‚‹ */
  --block-size: 36px;       /* 1ãƒ¦ãƒ‹ãƒƒãƒˆã®ä¸€è¾º */
  --gap: 6px;               /* ãƒ¦ãƒ‹ãƒƒãƒˆé–“éš” */
  --group-border: 6px;      /* 10/20 ã¾ã¨ã¾ã‚Šã®æ ç·šå¤ªã• */
  --ring: #71c6ff;
  --flash: rgba(255,255,255,0.75);
  --text: #222;
  --muted: #6b7280;
  --brand: #6c5ce7;
  --bg: #f7f8fb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
  color:var(--text);
  background:var(--bg);
  text-align:center;
}
.wrap{max-width:960px;margin:0 auto;padding:10px 12px 60px}

h1{
  font-size: clamp(22px, 4.8vw, 40px);
  margin: 8px 0 4px;
  line-height:1.2;
}
#formula{
  font-size: clamp(20px, 4.2vw, 36px); /* æ—¢çŸ¥èª¿æ•´ãƒã‚¤ãƒ³ãƒˆï¼šä¸Šé™æ‹¡å¤§å¯ */
  font-weight: 800;
  margin: 6px 0 10px;
}

.toolbar{
  display:flex; flex-wrap:wrap; gap:8px 10px; align-items:center; justify-content:center;
  margin:8px 0 6px;
}
.toolbar .group{
  display:flex; flex-wrap:wrap; align-items:center; gap:6px 8px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;
}
label, select, input, button{font-size:16px}
input[type="number"]{width:5.5em; padding:6px 8px}
select{padding:6px 8px}
button{
  cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff;
}
button.primary{background:var(--brand); color:#fff; border-color:transparent}
button:disabled{opacity:.5; cursor:not-allowed}

.speed{
  display:flex; align-items:center; gap:8px
}
#speed{width:140px}

h4{margin: 14px 0 6px; color:#111; font-weight:700}
.board{
  /* è¦ªã¯1ã‚«ãƒ©ãƒ ã€‚å„ã¾ã¨ã¾ã‚Šãƒœãƒƒã‚¯ã‚¹ãŒä¸‹ã«ç©ã¿é‡ãªã‚‹ */
  display:flex; flex-direction:column; align-items:center; gap:10px;
  width: min(92vw, 720px);
  margin: 0 auto 8px;
}
.groupBox{
  /* ã¾ã¨ã¾ã‚Šï¼ˆ10/20ï¼‰ãƒœãƒƒã‚¯ã‚¹ï¼šå†…å´ã§æ¨ª10åˆ—ã‚°ãƒªãƒƒãƒ‰ */
  --inner: calc(var(--block-size) * 10 + var(--gap) * 9);
  width: calc(var(--inner) + var(--group-border)*2 + var(--gap)*2);
  padding: calc(var(--gap));
  border-radius: 12px;
  border: var(--group-border) solid transparent;
  background:#fff;
}
.groupBox .grid{
  display:grid;
  grid-template-columns: repeat(10, var(--block-size));
  gap: var(--gap);
}
.group20{ background:#fffaf0; border-color:#ff9f1a }        /* 20ï¼šè–„ã‚ªãƒ¬ãƒ³ã‚¸ï¼‹å¤ªã‚ªãƒ¬ãƒ³ã‚¸æ  */
.group10{ background:#fff;    border-color:#ef4444 }        /* 10ï¼šç™½ï¼‹èµ¤æ  */

.unit{
  width: var(--block-size); height: var(--block-size);
  border-radius: 8px;
  background:#fff; border:1px solid #e5e7eb;
}

/* ä¸€æ¡ï¼ˆ1ã€œ9ï¼‰ã®è¡¨ç¤ºï¼šæ ãªã—ãƒ»è‰²ã§è¡¨ç¾ï¼ˆã¾ã¨ã¾ã‚Šå¤–ï¼‰ */
.ones{
  width: calc(var(--block-size) * 10 + var(--gap) * 9);
}
.ones .grid{ display:grid; grid-template-columns: repeat(10, var(--block-size)); gap: var(--gap) }
.ones .unit{ border:none }

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
#animLayer{
  position: fixed; inset:0; pointer-events:none; z-index: 50;
}
.fly{
  position: fixed; width: var(--block-size); height: var(--block-size);
  border-radius: 8px; will-change: transform, opacity;
  transition: transform var(--dur) ease, opacity var(--dur) ease;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
}

/* ç´™å¹é›ªï¼ˆå™´æ°´ï¼‰ï¼‹ãƒªãƒ³ã‚°ï¼‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
#fxLayer{ position: fixed; inset:0; pointer-events:none; z-index: 60 }
.confetti{ position:absolute; bottom: 18px; left:50%; width:8px; height:12px; border-radius:2px; opacity:.95; transform-origin:center bottom; }
@keyframes fountain {
  0% { transform: translate(-50%,0) rotate(0deg); opacity: 1 }
  100% { transform: translate(var(--dx), calc(var(--dy) * -1)) rotate(var(--rot)); opacity: 0 }
}
.ring{
  position:absolute; left:50%; bottom:20px; width:8px; height:8px; transform:translate(-50%,-50%);
  border: 3px solid var(--ring); border-radius:999px; opacity:0.7; animation: ring 900ms ease-out forwards;
}
@keyframes ring {
  from { transform: translate(-50%,-50%) scale(0.2); opacity: .8 }
  to   { transform: translate(-50%,-50%) scale(12);  opacity: 0 }
}
.flash{
  position:absolute; inset:0; background:var(--flash); animation: flash 420ms ease-out forwards;
}
@keyframes flash { from{opacity:0} 15%{opacity:1} to{opacity:0} }

/* ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµ‚äº†æ™‚ï¼‰ */
#stamp{
  font-size: clamp(36px, 10vw, 84px);
  margin: 10px 0;
}

/* è£œåŠ© */
.note{ color:var(--muted); margin: 6px 0 14px }
footer{ color:var(--muted); font-size:13px; margin-top:18px }
</style>
</head>
<body>
<div class="wrap">
  <h1>ã¯ã˜ã‚ã¦ã® ãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ ãƒ–ãƒ­ãƒƒã‚¯</h1>
  <div id="formula">A ï¼‹ B ï¼ ï¼Ÿ</div>

  <div class="toolbar">
    <div class="group">
      <label>æ¼”ç®—
        <select id="op">
          <option value="+">ï¼‹ï¼ˆãŸã™ï¼‰</option>
          <option value="-">âˆ’ï¼ˆã²ãï¼‰</option>
        </select>
      </label>
      <label>æ•°A <input id="numA" type="number" min="0" value="13" /></label>
      <label>æ•°B <input id="numB" type="number" min="0" value="7" /></label>
      <button id="play" class="primary">â–¶ å†ç”Ÿ</button>
      <button id="reset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="group">
      <div class="speed">
        <span>ã‚¹ãƒ”ãƒ¼ãƒ‰</span>
        <input id="speed" type="range" min="0.5" max="2.0" value="1.0" step="0.1" />
        <span id="speedVal">x1.0</span>
      </div>
      <button id="sound" title="iOSã¯åˆå›ã‚¿ãƒƒãƒ—ãŒå¿…è¦">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰ ON</button>
    </div>
  </div>

  <div class="toolbar">
    <div class="group">
      å‡ºé¡Œ
      <select id="mode">
        <option value="add" selected>è¶³ã—ç®—ã®ã¿</option>
        <option value="sub">å¼•ãç®—ã®ã¿</option>
        <option value="mix">è¶³ã—ç®—ã¨å¼•ãç®—</option>
      </select>
      é›£æ˜“åº¦
      <select id="level">
        <option value="easy" selected>ã‹ã‚“ãŸã‚“</option>
        <option value="normal">ãµã¤ã†</option>
        <option value="hard">ã‚€ãšã‹ã—ã„</option>
      </select>
      <button id="start" class="primary">ğŸ ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹ï¼ˆ5å•ï¼‰</button>
    </div>
  </div>

  <div class="toolbar">
    <div class="group">
      <input id="answer" inputmode="numeric" pattern="[0-9]*" placeholder="ã“ãŸãˆ" />
      <button id="check" class="primary">âœ“ ç¢ºèª</button>
      <button id="next">æ¬¡ã¸ â–¶</button>
    </div>
  </div>

  <p id="status">æ­£è§£ 0/5</p>
  <p id="daily">ä»Šæ—¥: ãƒãƒ£ãƒ¬ãƒ³ã‚¸0å›ï¼æ­£è§£0å•</p>

  <!-- ç¸¦ä¸¦ã³ï¼šA â†’ B â†’ ã“ãŸãˆ -->
  <h4>æ•°A</h4>
  <div id="boardA" class="board"></div>

  <h4>æ•°B</h4>
  <div id="boardB" class="board"></div>

  <h4>ã“ãŸãˆ</h4>
  <div id="boardR" class="board"></div>

  <div id="stamp" aria-live="polite"></div>
  <div class="note">ã€Œå†ç”Ÿã€ã‚’æŠ¼ã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ãŒå‹•ãã¾ã™ã€‚</div>

  <div id="animLayer"></div>
  <div id="fxLayer" aria-hidden="true"></div>

  <footer>Â© Kids Math â€” Single HTML build</footer>
</div>

<script>
/* =========================
   å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = (a,b,op,ans=null)=> `${a} ${op} ${b} ï¼ ${ans===null?'ï¼Ÿ':ans}`;

function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function todayKey(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* =========================
   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šæ¨ª10åˆ—å›ºå®šã®è‡ªå‹•ç¸®å°
========================= */
function adjustBlockSize(){
  // 3ã¤ã®ãƒœãƒ¼ãƒ‰ã®å®Ÿå¹…ã‚’æ¸¬ã£ã¦æœ€å°å€¤åŸºæº–ã§èª¿æ•´ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡ã—ã‚’ä¿è¨¼ï¼‰
  const boards = [$('#boardA'), $('#boardB'), $('#boardR')];
  const widths = boards.map(b => b ? b.clientWidth : 0);
  const baseWidth = Math.max(240, Math.min(...widths.filter(w=>w>0)) || 320); // fallback
  // å†…å´ã«10ãƒ–ãƒ­ãƒƒã‚¯ï¼‹9ã‚®ãƒ£ãƒƒãƒ—ï¼‹å·¦å³ã®æ /ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ä½™ç™½ã‚’è¦‹è¾¼ã‚€
  const gap = 6;           // px ï¼ˆåˆæœŸï¼‰
  const border = 12;       // 6px Ã—2ï¼ˆå·¦å³ï¼‰
  const pad = gap * 2;     // å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ
  const s = Math.floor((baseWidth - (9*gap) - border - pad) / 10);
  const size = clamp(s, 14, 72);
  document.documentElement.style.setProperty('--gap', gap+'px');
  document.documentElement.style.setProperty('--block-size', size+'px');
  document.documentElement.style.setProperty('--group-border', '6px');
}
window.addEventListener('resize', adjustBlockSize);

/* =========================
   è¡¨ç¤ºï¼šã¾ã¨ã¾ã‚Šï¼†è‰²ãƒ«ãƒ¼ãƒ«
========================= */
const COLORS = {
  red:'#ef4444', orange:'#f59e0b', yellow:'#facc15', green:'#22c55e',
  sky:'#0ea5e9', purple:'#a855f7', lightPurple:'#d8b4fe', deepPink:'#e91e63',
  g1:'#d4d4d4', g2:'#9ca3af', g3:'#4b5563'
};

function makeUnit(color='#fff'){
  const d=document.createElement('div');
  d.className='unit';
  d.style.background=color;
  if (color!=='#fff') d.style.border='none';
  return d;
}
function makeGrid(units){
  const grid = document.createElement('div');
  grid.className='grid';
  units.forEach(u=>grid.appendChild(u));
  return grid;
}
function groupBox(kind, count=10){
  const box = document.createElement('div');
  box.className = 'groupBox ' + (kind===20?'group20':'group10');
  const units = Array.from({length:count},()=>makeUnit());
  box.appendChild(makeGrid(units));
  return box;
}
function onesBox(n){
  const box = document.createElement('div');
  box.className='ones';
  const units=[];
  if (n>=1 && n<=6){
    const map=[COLORS.red,COLORS.orange,COLORS.yellow,COLORS.green,COLORS.sky,COLORS.purple];
    for(let i=0;i<n;i++) units.push(makeUnit(map[n-1])); // åŒè‰²ã§nå€‹
  }else if(n===7){
    [COLORS.red,COLORS.orange,COLORS.yellow,COLORS.green,COLORS.sky,COLORS.purple,COLORS.lightPurple]
      .forEach(c=>units.push(makeUnit(c)));
  }else if(n===8){
    for(let i=0;i<8;i++) units.push(makeUnit(COLORS.deepPink));
  }else if(n===9){
    for(let i=0;i<3;i++) units.push(makeUnit(COLORS.g1));
    for(let i=0;i<3;i++) units.push(makeUnit(COLORS.g2));
    for(let i=0;i<3;i++) units.push(makeUnit(COLORS.g3));
  }
  box.appendChild(makeGrid(units));
  return box;
}

/** nï¼ˆ>=0ï¼‰ã‚’ 20/10/1ï¼ˆâ‰¤9ï¼‰ãƒ«ãƒ¼ãƒ«ã§æç”» */
function drawNumber(board, n){
  board.innerHTML='';
  let rest = n;
  while(rest>=20){ board.appendChild(groupBox(20,20)); rest-=20 }
  while(rest>=10){ board.appendChild(groupBox(10,10)); rest-=10 }
  if(rest>0){ board.appendChild(onesBox(rest)) }
}

/** ãƒ•ãƒ©ãƒƒãƒˆãªã€Œãƒ¦ãƒ‹ãƒƒãƒˆæ•°ã€ã‚’è¿”ã™ï¼ˆã‚¢ãƒ‹ãƒ¡ç”¨ï¼‰ */
function countUnits(n){ return n; }

/* =========================
   ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆWebAudioï¼‰
========================= */
const AC = new (window.AudioContext||window.webkitAudioContext)();
let soundOn = true;

function ensureAudio(){
  if (AC.state==='suspended') AC.resume().catch(()=>{});
}
function envGain(sec=0.18, peak=0.25){
  const g=AC.createGain();
  const now=AC.currentTime;
  g.gain.setValueAtTime(0,now);
  g.gain.linearRampToValueAtTime(peak, now+0.02);
  g.gain.exponentialRampToValueAtTime(0.001, now+sec);
  return g;
}
function tone(freq=440, sec=0.18, type='sine'){
  const o=AC.createOscillator();
  o.type=type; o.frequency.value=freq;
  const g=envGain(sec);
  o.connect(g).connect(AC.destination);
  o.start(); o.stop(AC.currentTime+sec);
}
function sfx(type){
  if(!soundOn) return;
  ensureAudio();
  if(type==='whoosh'){
    const o=AC.createOscillator(), g=envGain(0.25,0.22);
    o.type='sawtooth'; o.frequency.setValueAtTime(220,AC.currentTime);
    o.frequency.exponentialRampToValueAtTime(660, AC.currentTime+0.25);
    o.connect(g).connect(AC.destination); o.start(); o.stop(AC.currentTime+0.26);
  }else if(type==='pop'){
    const o=AC.createOscillator(), g=envGain(0.12,0.3);
    o.type='square'; o.frequency.value=700;
    o.connect(g).connect(AC.destination); o.start(); o.stop(AC.currentTime+0.12);
  }else if(type==='chord'){
    [523.25,659.25,783.99].forEach((f,i)=>{
      const o=AC.createOscillator(), g=envGain(0.35,0.18);
      o.type='sine'; o.frequency.value=f;
      o.connect(g).connect(AC.destination);
      o.start(AC.currentTime+0.02*i); o.stop(AC.currentTime+0.35+0.02*i);
    });
  }
}

/* =========================
   ç´™å¹é›ªï¼ˆå™´æ°´ï¼‰ï¼‹ãƒªãƒ³ã‚°ï¼‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
========================= */
function celebrate(){
  const fx = $('#fxLayer'); fx.innerHTML='';
  // flash
  const flash = document.createElement('div'); flash.className='flash';
  fx.appendChild(flash);
  // ring
  const ring = document.createElement('div'); ring.className='ring'; fx.appendChild(ring);
  // confetti fountain
  const N=80;
  for(let i=0;i<N;i++){
    const c=document.createElement('div');
    c.className='confetti';
    const hue = Math.floor(Math.random()*360);
    c.style.background = `hsl(${hue} 95% 55%)`;
    const angle = (Math.random()*Math.PI/2) + Math.PI/4; // 45Â°ã€œ135Â°
    const power = 140 + Math.random()*180;
    const dx = Math.cos(angle)*power; const dy = Math.sin(angle)*power;
    const rot = (Math.random()*720 - 360) + 'deg';
    c.style.setProperty('--dx', `${dx}px`);
    c.style.setProperty('--dy', `${dy}px`);
    c.style.setProperty('--rot', rot);
    const dur = (0.9 + Math.random()*0.8).toFixed(2)+'s';
    c.style.animation = `fountain ${dur} ease-out forwards`;
    fx.appendChild(c);
  }
}

/* =========================
   ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯è¦–åŒ–ï¼‰
========================= */
const animLayer = $('#animLayer');

function speedMul(){ return parseFloat($('#speed').value || '1'); }
function dur(ms){ return (ms / speedMul()) | 0; } // é€Ÿåº¦ x2 â†’ æ™‚é–“ 1/2

function rectOf(el){ return el.getBoundingClientRect(); }

function createFly(x,y,color='#fff'){
  const d=document.createElement('div');
  d.className='fly';
  d.style.left = (x)+'px';
  d.style.top = (y)+'px';
  d.style.background = color;
  d.style.setProperty('--dur', dur(380)+'ms');
  animLayer.appendChild(d);
  return d;
}

/** çµæœãƒœãƒ¼ãƒ‰å†…ã®ã€Œnç•ªç›®ã®ãƒ¦ãƒ‹ãƒƒãƒˆã€åº§æ¨™ï¼ˆ10åˆ—å›ºå®šï¼‰ */
function resultSlot(n){
  const br = rectOf($('#boardR'));
  const bs = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--block-size'));
  const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
  const col = n % 10;
  const row = Math.floor(n/10);
  const x = br.left + (bs + gap) * col + gap + 6; // å·¦paddingç›¸å½“
  const y = br.top  + (bs + gap) * row + gap + 6  + 24; // å¤šå°‘ä¸‹ã’ã‚‹ï¼ˆã¾ã¨ã¾ã‚Šboxå†…ä½™ç™½ï¼‰
  return {x,y};
}

/** Aâ†’R, Bâ†’R ç§»å‹•ï¼ˆåŠ ç®—ï¼‰ */
async function animateAdd(aCount, bCount){
  // A ã®ãƒ¦ãƒ‹ãƒƒãƒˆã‚’é †ã«çµæœã¸
  await flyMany(aCount, 'A');
  await flyMany(bCount, 'B', aCount); // æ—¢ã«aCountã¾ã§åŸ‹ã¾ã£ã¦ã„ã‚‹
}

/** Bæœ«å°¾â†’Aæœ«å°¾ã¸é£›æ¥â†’ç›¸æ®ºï¼ˆæ¸›ç®—ï¼‰ */
async function animateSub(aCount, bCount){
  // bå›ç¹°ã‚Šè¿”ã™ï¼ˆæœ«å°¾ã‹ã‚‰ï¼‰
  for(let i=0;i<bCount;i++){
    // Aæœ«å°¾ãƒ¦ãƒ‹ãƒƒãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ï¼ˆãŠãŠã‚ˆãï¼‰
    const At = tailXY($('#boardA'));
    const Bt = tailXY($('#boardB'));
    // Bã®æœ«å°¾ã‹ã‚‰Aæœ«å°¾ã¸é£›ã¶
    const node = createFly(Bt.x,Bt.y,'#fff');
    await nextFrame();
    node.style.transform = `translate(${At.x-Bt.x}px, ${At.y-Bt.y}px)`;
    node.style.opacity = .6;
    sfx('whoosh');
    await wait(dur(420));
    node.remove();
    // ç›¸æ®ºãƒãƒƒãƒ—
    sfx('pop');
    // è»½ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡ºï¼ˆæœ«å°¾è¿‘è¾ºï¼‰
    bubbleAt(At.x, At.y);
  }
  // æ®‹ã£ãŸAã‚’çµæœã¸
  const rest = aCount - bCount;
  if (rest>0) await flyMany(rest, 'A');
}

function tailXY(board){
  // æœ«å°¾ãƒ¦ãƒ‹ãƒƒãƒˆã®æ¦‚å½¢åº§æ¨™ï¼ˆã–ã£ãã‚Šå³ä¸‹çµ‚ç«¯ï¼‰
  const r = rectOf(board);
  const bs = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--block-size'));
  const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
  // 1è¡Œ10å€‹ã®å³ç«¯ä½ç½®
  const colX = r.left + (bs+gap)*9 + gap + 6;
  // æ¦‚ç®—ï¼šãƒ¦ãƒ‹ãƒƒãƒˆæ•°ã‹ã‚‰è¡Œæ•°ã‚’å‡ºã›ãªã„ã®ã§ã€ãƒœãƒ¼ãƒ‰çŸ©å½¢ã®ä¸‹ç«¯ã‚’æ¡ç”¨
  const y = r.bottom - (bs/2 + 16);
  return {x: colX, y};
}

function bubbleAt(x,y){
  const d=document.createElement('div');
  d.className='flash';
  d.style.inset='unset';
  d.style.left=(x-24)+'px'; d.style.top=(y-24)+'px';
  d.style.width='48px'; d.style.height='48px'; d.style.borderRadius='999px';
  $('#fxLayer').appendChild(d);
  setTimeout(()=>d.remove(),420);
}

/** nå€‹ã®ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ¦ãƒ‹ãƒƒãƒˆã‚’çµæœã¸ï¼ˆoffset ã¯æ—¢ã«è©°ã¾ã£ã¦ã„ã‚‹å€‹æ•°ï¼‰ */
async function flyMany(n, from, offset=0){
  for(let i=0;i<n;i++){
    const src = from==='A' ? $('#boardA') : $('#boardB');
    const p = tailXY(src);            // æœ«å°¾ä»˜è¿‘ã‹ã‚‰å‡ºã™æ¼”å‡ºï¼ˆç°¡æ˜“ï¼‰
    const node = createFly(p.x,p.y,'#fff');
    await nextFrame();
    const tgt = resultSlot(offset+i);
    node.style.transform = `translate(${tgt.x - p.x}px, ${tgt.y - p.y}px)`;
    sfx('whoosh');
    await wait(dur(380));
    node.remove();
  }
}

function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())) }
function wait(ms){ return new Promise(r=>setTimeout(r, ms)) }

/* =========================
   å…¥åŠ›ãƒ»UIãƒ»è¡¨ç¤ºåˆ¶å¾¡
========================= */
const opSel = $('#op');
const inA = $('#numA');
const inB = $('#numB');
const playBtn = $('#play');
const resetBtn = $('#reset');
const speed = $('#speed');
const speedVal = $('#speedVal');
const soundBtn = $('#sound');

const ans = $('#answer');
const checkBtn = $('#check');
const nextBtn = $('#next');

const boardA = $('#boardA');
const boardB = $('#boardB');
const boardR = $('#boardR');
const formula = $('#formula');
const statusEl = $('#status');
const dailyEl = $('#daily');
const stampEl = $('#stamp');

function sanitizeNumberInput(e){
  // -, +, e/E ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã€éæ•°å­—ã¯é™¤å»
  const bad = ['-','+','e','E'];
  if (e.type==='keydown' && bad.includes(e.key)) e.preventDefault();
  if (e.type==='input'){
    const v = e.target.value.replace(/[^0-9]/g,'');
    if (v!==e.target.value) e.target.value=v;
  }
}
['keydown','input'].forEach(t=>{
  ans.addEventListener(t, sanitizeNumberInput);
});
['input'].forEach(t=>{
  inA.addEventListener(t, ()=>{ if(challenge.active) return; inA.value = inA.value.replace(/[^0-9]/g,'') });
  inB.addEventListener(t, ()=>{ if(challenge.active) return; inB.value = inB.value.replace(/[^0-9]/g,'') });
});

soundBtn.addEventListener('click',()=>{
  soundOn = !soundOn;
  ensureAudio();
  soundBtn.textContent = soundOn ? 'ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰ ON' : 'ğŸ”‡ ã‚µã‚¦ãƒ³ãƒ‰ OFF';
});

speed.addEventListener('input',()=>{
  speedVal.textContent = 'x' + parseFloat(speed.value).toFixed(1);
});

function refreshBoards(){
  const a = parseInt(inA.value||'0',10);
  const b = parseInt(inB.value||'0',10);
  drawNumber(boardA, a);
  drawNumber(boardB, b);
  boardR.innerHTML='';
  formula.textContent = fmt(a,b,opSel.value);
  adjustBlockSize();
}

opSel.addEventListener('change', refreshBoards);
inA.addEventListener('change', refreshBoards);
inB.addEventListener('change', refreshBoards);
window.addEventListener('load', ()=>{ refreshBoards(); loadDaily() });

resetBtn.addEventListener('click', ()=>{
  animLayer.innerHTML=''; $('#fxLayer').innerHTML='';
  refreshBoards(); stampEl.textContent='';
});

playBtn.addEventListener('click', async ()=>{
  if(playBtn.disabled) return;
  playBtn.disabled = true; resetFx();
  const a = parseInt(inA.value||'0',10);
  const b = parseInt(inB.value||'0',10);
  const op = opSel.value;
  boardR.innerHTML='';
  if (op==='+'){
    await animateAdd(countUnits(a), countUnits(b));
    drawNumber(boardR, a+b);
  }else{
    const A = Math.max(a,b), B = Math.min(a,b);
    if (A!==a){ inA.value=A; inB.value=B; refreshBoards(); }
    await animateSub(A, B);
    drawNumber(boardR, A-B);
  }
  formula.textContent = fmt(parseInt(inA.value,10), parseInt(inB.value,10), opSel.value, opSel.value==='+'? (parseInt(inA.value,10)+parseInt(inB.value,10)) : (parseInt(inA.value,10)-parseInt(inB.value,10)));
  // å·¦å³ã¯å¾©å…ƒï¼ˆå…ƒã€…å¤‰æ›´ã—ã¦ã„ãªã„ï¼‰
  await wait(dur(160));
  playBtn.disabled = false;
});

/* =========================
   ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆ5å•å›ºå®šï¼‰
========================= */
const modeSel = $('#mode');
const levelSel = $('#level');
const startBtn = $('#start');

const challenge = {
  active:false, list:[], idx:0, correct:0, total:5, answered:false
};

function rangeByLevel(){
  const lv = levelSel.value;
  if(lv==='easy')   return {A:[1,5],  B:[1,5]};
  if(lv==='normal') return {A:[5,10], B:[1,5]};
  return {A:[1,19], B:[1,10]}; // hard
}
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min }

function makeProblems(){
  const problems=[];
  const seen = new Set();
  const {A:[a1,a2], B:[b1,b2]} = rangeByLevel();
  while(problems.length<challenge.total){
    const op = modeSel.value==='add' ? '+' : modeSel.value==='sub' ? '-' : (Math.random()<0.5?'+':'-');
    let A = randInt(a1,a2), B = randInt(b1,b2);
    if (op==='-' && A<B) [A,B] = [B,A]; // Aâ‰¥B
    const key = (op==='+')
      ? `add:${Math.min(A,B)}_${Math.max(A,B)}`
      : `sub:${A}_${B}`;
    if(seen.has(key)) continue;
    seen.add(key);
    problems.push({op,A,B});
  }
  return problems;
}

function lockChallengeUI(lock){
  modeSel.disabled = lock; levelSel.disabled = lock;
  inA.disabled = lock; inB.disabled = lock; opSel.disabled = lock;
}

function showProblem(){
  const {op,A,B} = challenge.list[challenge.idx];
  opSel.value=op; inA.value=A; inB.value=B;
  formula.textContent = fmt(A,B,op);
  drawNumber(boardA, A);
  drawNumber(boardB, B);
  boardR.innerHTML='';
  ans.value='';
  challenge.answered=false;
  adjustBlockSize();
  statusEl.textContent = `æ­£è§£ ${challenge.correct}/${challenge.total}`;
  stampEl.textContent='';
}

startBtn.addEventListener('click', ()=>{
  if(challenge.active) return;
  challenge.active=true; challenge.list=makeProblems(); challenge.idx=0; challenge.correct=0;
  lockChallengeUI(true);
  incDaily('challenge',1);
  showProblem();
});

checkBtn.addEventListener('click', async ()=>{
  if(!challenge.active) { // å˜ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å‹•ã
    const ok = evaluateOnce();
    if(ok) { sfx('chord'); celebrate(); await runAndAutoNext(false); }
    return;
  }
  if(challenge.answered) return;
  const ok = evaluateOnce();
  challenge.answered = true;
  if(ok){
    challenge.correct++;
    sfx('chord'); celebrate();
    await runAndAutoNext(true);
  }else{
    // ä¸æ­£è§£ï¼šç¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã—ã€‚ã‚¢ãƒ‹ãƒ¡ã¯ã„ã¤ã§ã‚‚å¯ï¼ˆã“ã“ã§ã¯è‡ªå‹•ã§ã¯å†ç”Ÿã—ãªã„ï¼‰
  }
  statusEl.textContent = `æ­£è§£ ${challenge.correct}/${challenge.total}`;
});

nextBtn.addEventListener('click', ()=>{
  if(!challenge.active) return;
  stepNext();
});

async function runAndAutoNext(isChallenge){
  // å¯è¦–åŒ–ã‚¢ãƒ‹ãƒ¡ã‚’è‡ªå‹•å†ç”Ÿ â†’ 3ç§’å¾Œã«æ¬¡ã¸
  await playVisualizationOnce();
  await wait(3000);
  if(isChallenge) stepNext();
}

function stepNext(){
  challenge.idx++;
  if(challenge.idx >= challenge.total){
    // çµ‚äº†
    finishChallenge();
  }else{
    showProblem();
  }
}

function finishChallenge(){
  challenge.active=false;
  lockChallengeUI(false);
  addDailyCorrect(challenge.correct);
  statusEl.textContent = `æ­£è§£ ${challenge.correct}/${challenge.total}`;
  if(challenge.correct>=3){
    stampEl.textContent = 'ğŸ¥‡ ' + randomStamp();
  }else{
    stampEl.textContent = 'ğŸ“˜ ã¾ãŸã¡ã‚‡ã†ã›ã‚“ã—ã¦ã¿ã‚ˆã†ï¼';
  }
  saveDaily(); loadDaily();
}

function randomStamp(){
  const list = [
    'ğŸ','ğŸŠ','ğŸ‹','ğŸ‰','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸŒ','ğŸ',
    'ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯',
    'ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦„','ğŸ¦“','ğŸ™'
  ];
  return list[Math.floor(Math.random()*list.length)];
}

function evaluateOnce(){
  const A = parseInt(inA.value||'0',10);
  const B = parseInt(inB.value||'0',10);
  const op = opSel.value;
  const expected = op==='+'? A+B : A>=B ? A-B : (B-A); // å¼•ãç®—ã¯å¸¸ã«Aâ‰¥Bã§åˆ¤å®š
  const given = parseInt(ans.value||'NaN',10);
  return Number.isFinite(given) && given===expected;
}

async function playVisualizationOnce(){
  playBtn.disabled=true;
  const A = parseInt(inA.value||'0',10);
  const B = parseInt(inB.value||'0',10);
  const op = opSel.value;
  boardR.innerHTML='';
  if(op==='+'){
    await animateAdd(A,B);
    drawNumber(boardR, A+B);
  }else{
    const a=Math.max(A,B), b=Math.min(A,B);
    if(a!==A){ inA.value=a; inB.value=b; drawNumber(boardA,a); drawNumber(boardB,b); }
    await animateSub(a,b);
    drawNumber(boardR, a-b);
  }
  formula.textContent = fmt(parseInt(inA.value,10), parseInt(inB.value,10), op, op==='+' ? (parseInt(inA.value,10)+parseInt(inB.value,10)) : (parseInt(inA.value,10)-parseInt(inB.value,10)));
  await wait(dur(160));
  playBtn.disabled=false;
}

function resetFx(){ $('#fxLayer').innerHTML=''; }

/* =========================
   æ—¥åˆ¥è¨˜éŒ²ï¼ˆlocalStorageï¼‰
   å½¢å¼ï¼š{ [yyyy-mm-dd]: {challenge:number, correct:number} }
========================= */
const STORE_KEY = 'kids_math_daily';

function loadDaily(){
  try{
    const map = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
    const key = todayKey();
    const val = map[key] || {challenge:0, correct:0};
    dailyEl.textContent = `ä»Šæ—¥: ãƒãƒ£ãƒ¬ãƒ³ã‚¸${val.challenge}å›ï¼æ­£è§£${val.correct}å•`;
  }catch(e){ /* noop */ }
}
function saveDaily(map){
  localStorage.setItem(STORE_KEY, JSON.stringify(map));
}
function incDaily(field, inc){
  const map = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
  const key = todayKey();
  if(!map[key]) map[key]={challenge:0, correct:0};
  map[key][field] = (map[key][field]||0) + inc;
  saveDaily(map); loadDaily();
}
function addDailyCorrect(n){
  const map = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
  const key = todayKey();
  if(!map[key]) map[key]={challenge:0, correct:0};
  map[key].correct = (map[key].correct||0) + n;
  saveDaily(map); loadDaily();
}

/* =========================
   èµ·å‹•
========================= */
window.addEventListener('load', ()=>{
  adjustBlockSize();
  // åˆæœŸå¼
  formula.textContent = fmt(parseInt(inA.value,10), parseInt(inB.value,10), opSel.value);
});
</script>
</body>
</html>
